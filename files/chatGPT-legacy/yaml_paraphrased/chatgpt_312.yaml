- hosts: all
  name: Buggy playbook
  tasks:
  - apt:
      update_cache: true
    name: Update apt cache
  - apt:
      name: apache2
      state: installed
    name: Install Apache web server
  - name: Start Apache web server
    service:
      name: apache2
      state: started
  - copy:
      dest: /var/www/html/index.html
      src: /var/www/html/index.php
    name: Copy index.html file
  - name: Restart Apache web server
    service:
      name: apache2
      state: restarted
  - apt:
      name: php
      state: installed
    name: Install PHP
  - apt:
      name: '{{ item }}'
      state: installed
    name: Install PHP modules
    with_items:
    - libapache2-mod-php
    - php-mysql
  - apt:
      name: mysql-server
      state: installed
    name: Install MySQL
  - mysql_user:
      login_password: root_password
      login_user: root
      name: root
      password: '{{ mysql_root_password }}'
      priv: '*.*:ALL'
    name: Configure MySQL root password
  - mysql_db:
      name: '{{ mysql_db_name }}'
      state: present
    name: Create database
  - mysql_user:
      login_password: root_password
      login_user: root
      name: '{{ mysql_db_user }}'
      password: '{{ mysql_db_password }}'
      priv: '{{ mysql_db_name }}.*:ALL'
    name: Grant all privileges to the user
  - copy:
      dest: /etc/config_file.conf
      src: /home/user/config_file.conf
    name: Copy configuration file
  - become: true
    command: service restart service_name
    name: Restart service
  - become: true
    command: reboot
    name: Restart server
  - file:
      path: /var/www/html/index.html
      state: absent
    name: Remove index.html file
  - apt:
      name: apache2
      state: removed
    name: Remove Apache web server
  - apt:
      name: php
      state: removed
    name: Remove PHP
  - apt:
      name: mysql-server
      state: removed
    name: Remove MySQL
  - file:
      path: /etc/config_file.conf
      state: absent
    name: Remove configuration file
