- hosts: all
  name: buggy playbook
  tasks:
  - name: disable curbless
    netcommon:
      curbless: false
    register: output
  - name: restart service
    service:
      name: '{{ service_name }}'
      state: restarted
    when: output.changed
  - name: get uptime
    register: uptime_output
    shell: uptime
  - debug:
      var: uptime_output.stdout
    name: print uptime
  - apt:
      name: '{{ package_name }}'
      state: present
    name: install package
    register: package_install
  - debug:
      var: package_install
    name: print package install
  - name: create user
    user:
      name: '{{ user_name }}'
      state: present
    when: package_install.changed
  - command: chsh -s /bin/bash "{{ user_name }}"
    name: change user shell
    when: package_install.changed and user_name is defined
  - lineinfile:
      line: '{{ user_name }} ALL=(ALL) NOPASSWD: ALL'
      path: /etc/sudoers
    name: add user to sudoers
    when: package_install.changed and user_name is defined
