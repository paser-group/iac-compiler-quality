
- name: Test Zabbix Template Export and Import
  hosts: localhost
  connection: local
  tasks:
    - name: Create a Zabbix Template
      zabbix_template:
        server_url: "https://zabbix.example.com"
        login_user: "user"
        login_password: "{{ lookup('file', '/path/to/password/file') }}"
        state: present
        cert_key_file: "/path/to/cert_key_file.pem"
        cert_file: "/path/to/cert_file.pem"
        validate_certs: no
        name: "zabbix_template test"
        groups: "{{ ['Templates', 'Applications'] }}"
        templates: "{{ ['Template OS', 'Template App'] }}"
        description: "A test Zabbix Template"
        macros:
          - macro: "{$MACRO1}"
            value: "non-ASCII àèìòù漢字字符串"
    - name: Export and Import the Zabbix Template
      zabbix_export:
        server_url: "https://zabbix.example.com"
        login_user: "user"
        login_password: "{{ lookup('file', '/path/to/password/file') }}"
        ssl_cert_file: "/path/to/cert_file.pem"
        ssl_key_file: "/path/to/cert_key_file.pem"
        validate_certs: no
        format: xml
        type: template
        output_file: "/path/to/output/file.xml"
        ids: "{{ lookup('zabbix_template', 'name=zabbix_template test')['ids'] }}"
      register: export_output
    - name: Check Exported and Imported Template
      zabbix_import:
        server_url: "https://zabbix.example.com"
        login_user: "user"
        login_password: "{{ lookup('file', '/path/to/password/file') }}"
        ssl_cert_file: "/path/to/cert_file.pem"
        ssl_key_file: "/path/to/cert_key_file.pem"
        validate_certs: no
        format: xml
        upload_file: "/path/to/output/file.xml"
      register: import_output
    - name: Validate Export and Import Output
      debug:
        var: export_output
        verbosity: 2
      when: export_output.failed or import_output.failed
