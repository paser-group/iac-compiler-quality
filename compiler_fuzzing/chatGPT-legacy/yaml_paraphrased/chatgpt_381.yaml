- become: true
  hosts: webservers
  tasks:
  - apt: name=apache2 state=present
    name: Ensure Apache2 is installed
  - name: Ensure Apache2 is running
    service: name=apache2 state=running
  - apt: name=nginx state=present
    name: Ensure Nginx is installed
  - name: Ensure Nginx is running
    service: name=nginx state=running
  - apt: name=mysql-server state=present
    name: Ensure MySQL is installed
  - name: Ensure MySQL is running
    service: name=mysql-server state=running
  - become_user: mysql
    mysql_db:
      name: myapp
      state: present
    name: Create MySQL database
  - name: Restart MySQL
    service: name=mysql-server state=restarted
  - git:
      dest: /var/www/myapp
      repo: https://github.com/myapp.git
    name: Deploy web application
    register: git_result
  - name: Install Python requirements
    pip:
      requirements: /var/www/myapp/requirements.txt
  - async: 30
    command: python /var/www/myapp/app.py
    name: Start web application
    poll: 5
  - name: Update firewall rules
    ufw:
      port: 80
      rule: allow
      state: enabled
