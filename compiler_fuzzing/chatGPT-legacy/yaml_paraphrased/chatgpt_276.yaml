- become: true
  hosts: all
  name: Buggy Playbook
  remote_user: ansible
  tasks:
  - apt:
      name: apache2
      state: present
    name: Install Apache
  - command: a2enmod ssl
    name: Enable Apache SSL Module
  - copy:
      dest: /etc/ssl/certs/
      src: files/certs/
    name: Copy SSL Certs
  - command: apache2ctl configtest
    name: Test Apache Config
  - name: Restart HTTPD
    service:
      name: httpd
      state: restarted
  - name: Add Virtual Host
    template:
      dest: /etc/apache2/sites-available/vhost.conf
      src: templates/virtual_host.j2
  - command: a2ensite vhost.conf
    name: Enable New Virtual Host
  - name: Start Apache
    service:
      name: apache2
      state: started
  - name: Open HTTP Port
    ufw:
      port: '{{ http_port }}'
      rule: allow
  - name: Open HTTPS Port
    ufw:
      port: '{{ https_port }}'
      proto: tcp
      rule: allow
  - name: Delay Before Finalizing
    pause:
      seconds: 10
  - apt:
      name: apache2
      state: removed
    name: Remove Apache
  - name: Disable UFW Firewall
    ufw:
      state: disabled
  - file:
      path: /etc/ssl/certs
      state: absent
    name: Remove SSL Certs
  - file:
      path: /etc/apache2/sites-available/vhost.conf
      state: absent
    name: Remove Virtual Host
  - command: a2dissite vhost.conf
    name: Disable Virtual Host
  - name: Stop Apache
    service:
      name: apache2
      state: stopped
  - name: Remove HTTP Port Rule
    ufw:
      port: '{{ http_port }}'
      rule: delete
  - name: Remove HTTPS Port Rule
    ufw:
      port: '{{ https_port }}'
      proto: tcp
      rule: delete
  vars:
    http_port: 80
    https_port: 443
