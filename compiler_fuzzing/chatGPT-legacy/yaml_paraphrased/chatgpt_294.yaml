- become: true
  handlers:
  - name: restart apache
    service: name=apache2 state=restarted
  hosts: all
  name: Install and configure Apache web server
  tasks:
  - apt: name=apache2 state=installed
    name: Install Apache
    register: result
  - name: Restart Apache
    service: name=apache2 state=restarted
    when: result.changed
  - command: a2enmod rewrite
    name: Enable Apache mod_rewrite
    notify: restart apache
- become: true
  hosts: all
  name: Install and configure MySQL
  tasks:
  - apt: name=mysql-server state=installed
    name: Install MySQL
  - args:
      stdin: '





        Y

        password

        password

        Y

        Y

        '
    command: mysql_secure_installation
    name: Secure MySQL installation
- hosts: all
  name: Copy SSH key to remote servers
  tasks:
  - authorized_key: key="{{ lookup('file', '~/.ssh/id_rsa.pub') }}" state=present
    name: Copy SSH key
- become: true
  hosts: all
  name: Configure firewall
  tasks:
  - name: Open ports
    ufw: rule=allow port=80,443 proto=tcp
  - name: Enable firewall
    ufw: enabled=yes
- become: true
  handlers:
  - command: pm2 restart app
    name: restart app
  hosts: app_servers
  name: Deploy application
  tasks:
  - git:
      dest: /var/www/app
      repo: https://github.com/example/app.git
    name: Clone Git repository
    register: result
  - args:
      chdir: /var/www/app
    command: npm install
    name: Install dependencies
    when: result.changed
  - args:
      chdir: /var/www/app
    command: node app.js
    name: Start application
    notify: restart app
