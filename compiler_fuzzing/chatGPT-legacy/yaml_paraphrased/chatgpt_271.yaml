- become: true
  hosts: all
  name: Upgrade self-conflicting package
  tasks:
  - apt:
      update_cache: true
    name: Update apt
  - apt:
      dpkg_options: force-conflicts
      upgrade: true
    ignore_errors: true
    name: Try upgrade
    register: result
  - name: Restart services if upgrade successful
    service:
      name: '{{ item }}'
      state: restarted
    when: result.changed
    with_items:
    - service1
    - service2
