- hosts: all
  name: Ensure shebang uses correct python interpreter
  tasks:
  - find:
      file_type: file
      paths: /
      patterns: '*'
      recurse: true
    name: Find files with shebang
    register: files_with_shebang
  - become: true
    become_user: root
    loop: '{{ files_with_shebang.files }}'
    name: Replace shebang
    replace:
      path: '{{ item.path }}'
      regexp: '#!.*$'
      replace: '#!/usr/bin/env {{ ansible_python_interpreter }}'
    when: item.stat.isdir is not defined and '#!' in item.content
