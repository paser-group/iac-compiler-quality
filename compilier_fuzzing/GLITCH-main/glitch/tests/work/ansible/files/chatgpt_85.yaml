- become: true
  hosts: all
  name: Update apt cache
  tasks:
  - apt_repository:
      repo: '{{ item }}'
      state: present
    name: Update apt cache
    register: apt_update_result
    with_items:
    - deb http://archive.ubuntu.com/ubuntu trusty main
    - deb http://archive.ubuntu.com/ubuntu trusty-updates main
  - fail:
      msg: Apt update failed!
    name: Check apt update result
    when: apt_update_result is failed
  - name: Wait for apt to finish
    wait_for:
      timeout: 300
    when: apt_update_result is changed
