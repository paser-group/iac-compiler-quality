- become: true
  handlers:
  - name: Restart nginx
    service:
      name: nginx
      state: restarted
  hosts: all
  name: Install and start nginx
  tasks:
  - name: Install nginx
    yum:
      name: nginx
      state: present
  - name: Start nginx
    register: result
    service:
      name: nginx
      state: restarted
  - debug:
      var: result.stdout_lines
    name: Print nginx status
  - name: Set firewall rule to allow traffic to nginx
    ufw:
      comment: Allow traffic to nginx
      port: 80/tcp
      rule: allow
    when: result.changed == true
  - copy:
      dest: /etc/nginx/nginx.conf
      src: /etc/nginx/invalid_config.conf
    name: Upload invalid nginx config file
    notify: Restart nginx
