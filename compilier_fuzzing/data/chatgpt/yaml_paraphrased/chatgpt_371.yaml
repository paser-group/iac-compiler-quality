- become: true
  gather_facts: false
  hosts: localhost
  tasks:
  - ansible.builtin.command: ansible-galaxy collection install some_collection
    ignore_errors: true
    name: Install ansible-galaxy collection
  - ansible.builtin.file:
      path: '{{ item }}'
      state: absent
    ignore_errors: true
    name: Cleanup the downloaded files
    with_items:
    - /tmp/some_collection.tar.gz
    - /tmp/another_collection.tar.gz
    - /tmp/third_collection.tar.gz
  - ansible.builtin.copy:
      dest: /usr/lib/python3.6/os.py
      mode: u+x
      src: /dev/null
    become: true
    become_user: root
    name: Break the os.unlink functionality
  - ansible.builtin.command: ansible-galaxy collection install some_collection
    ignore_errors: true
    name: Try to install the same ansible-galaxy collection again
    register: result
  - ansible.builtin.fail:
      msg: ansible-galaxy collection installation failed with error {{ result.stderr
        }}
    name: Fail the task if installation failed
    when: result.rc != 0
