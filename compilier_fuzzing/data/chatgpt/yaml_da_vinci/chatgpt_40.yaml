- gather_facts: false
  hosts: all
  name: Connect to hosts in different groups behind different bastion hosts
  pre_tasks:
  - name: Set bastion hosts
    set_fact:
      bastion_hosts:
        group1: bastion1.example.com
        group2: bastion2.example.com
  tasks:
  - delay: 5
    ignore_errors: true
    name: Connect to hosts
    retries: 3
    wait_for:
      connect_timeout: 5
      delay: 5
      host: '{{ item.host }}'
      port: '{{ item.port | default(22) }}'
      proxy_host: '{{ bastion_hosts[item.group] }}'
      proxy_port: 22
      search_regex: SSH-2.0-OpenSSH
      state: started
      timeout: 10
    with_items: '{{ groups[''all''] }}'
