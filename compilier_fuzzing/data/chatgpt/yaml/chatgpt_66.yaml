- hosts: windows_servers
  name: TLS 1.3 client certificate authentication towards Windows 11
  tasks:
  - name: Install certificate on Windows Server
    register: cert_output
    when: ansible_os_family == 'Windows'
    win_package:
      arguments: IMPORTCERT /PFX {{ cert_password }}
      path: '{{ cert_path }}'
      product_id: KB2919355
      return_code: 3010
  - failed_when:
    - tls_output.rc not in [0, 1]
    name: Enable TLS 1.3 on server
    register: tls_output
    win_regedit:
      data: 1
      name: Enabled
      path: HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols\{{
        tls_version }}\Client
      type: dword
  - failed_when:
    - cipher_output.rc not in [0, 1]
    name: Set cipher suite for TLS 1.3 on server
    register: cipher_output
    win_regedit:
      data: 1
      name: Enabled
      path: HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Ciphers\{{
        cipher_suite }}
      type: dword
  vars:
    cert_password: mypassword
    cert_path: /path/to/certificate.pfx
    cipher_suite: TLS_AES_256_GCM_SHA384
    tls_version: OneTLS
