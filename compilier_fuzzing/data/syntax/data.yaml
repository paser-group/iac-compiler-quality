- become: true
  hosts: all
  name: Create a new user
  tasks:
  - name: Create the user
    user:
      append: true
      groups: wheel
      name: '{{ new_user }}'
      shell: /bin/bash
      state: present
  - name: Set the password for the user
    user:
      name: '{{ new_user }}'
      password: '{{ new_user_password }}'
      update_password: always
  - authorized_key:
      key: '{{ new_user_key }}'
      state: present
      user: '{{ new_user }}'
    name: Set up SSH keys for the user
  - lineinfile:
      dest: /etc/sudoers
      line: '{{ new_user }}  ALL=(ALL) NOPASSWD:ALL'
      state: present
      validate: visudo -cf %s
    name: Set up sudo privileges for the user
