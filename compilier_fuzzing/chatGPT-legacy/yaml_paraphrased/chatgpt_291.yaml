- become: true
  handlers:
  - name: Restart Apache
    service:
      name: apache2
      state: restarted
  hosts: webserver
  name: Install and Configure Apache Web Server
  tasks:
  - apt: name=apache2 state=latest
    name: Install Apache
  - name: Configure Apache
    notify: Restart Apache
    template:
      dest: /etc/apache2/sites-enabled/000-default.conf
      src: /etc/apache2/sites-available/000-default.conf.j2
  - file:
      mode: '0755'
      path: /var/www/html
      state: directory
    name: Create Document Root Directory
  - copy:
      dest: /var/www/html/index.html
      mode: '0644'
      src: index.html
    name: Copy Index File
  - name: Enable Apache Service
    service:
      enabled: true
      name: apache2
      state: started
- become: true
  hosts: database
  name: Install MySQL Server
  tasks:
  - apt_repository:
      repo: deb http://repo.mysql.com/apt/debian/ stretch mysql-8.0
      repo_key: 5072E1F5
      state: present
      update_cache: true
    name: Add MySQL APT Repository
  - apt: name=mysql-server state=latest
    name: Install MySQL Server
  - name: Start MySQL Service
    service:
      enabled: true
      name: mysql
      state: started
  - mysql_secure_installation:
      disallow_root_login: false
      login_password: '{{ mysql_root_password }}'
      login_user: root
      reload_privilege_tables: true
      remove_anonymous_users: true
      remove_test_database: true
      validate_password: true
    name: Secure MySQL Installation
- become: true
  hosts: all
  name: Set up Firewall Rules
  tasks:
  - name: Allow SSH
    ufw:
      port: ssh
      rule: allow
  - name: Allow HTTP
    ufw:
      port: http
      rule: allow
  - name: Allow HTTPS
    ufw:
      port: https
      proto: tcp
      rule: allow
  - name: Deny All Incoming Traffic
    ufw:
      default: deny
      incoming: deny
      outgoing: allow
