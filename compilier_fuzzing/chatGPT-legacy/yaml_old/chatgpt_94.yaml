- hosts: all
  name: Playbook to clone git repo
  tasks:
  - git:
      accept_hostkey: true
      dest: /opt/repo
      key_file: /root/.ssh/id_rsa
      repo: git@github.com:example/repo.git
      version: master
    ignore_errors: true
    name: Clone git repo
    register: git_clone_result
  - debug:
      msg: '{{ git_clone_result.stdout }}'
  - command: ssh-keygen -t rsa -b 4096 -f /root/.ssh/id_rsa -N ''
    name: Generate ssh key
    when: git_clone_result.rc != 0
  - command: ssh-copy-id -i /root/.ssh/id_rsa.pub git@github.com
    name: Add ssh key to github
    when: git_clone_result.rc != 0
  - git:
      accept_hostkey: true
      dest: /opt/repo
      key_file: /root/.ssh/id_rsa
      repo: git@github.com:example/repo.git
      version: master
    name: Retry cloning git repo
    when: git_clone_result.rc != 0
