- hosts: all
  tasks:
  - ansible.builtin.set_fact:
      ulimit_nofile: '{{ ulimit_nofile }}'
    name: Set ulimit nofile value
    when: inventory_hostname != 'localhost'
  - ansible.posix.pam_limits:
      domain: '{{ item.name }}'
      limit_item: '{{ item.item }}'
      limit_type: '{{ item.type }}'
      state: '{{ item.state }}'
      value: '{{ ulimit_nofile }}'
    name: Set ulimit nofile for non-root user
    when: ansible_connection != 'local'
    with_items:
    - item: nofile
      name: '*'
      state: present
      type: hard
    - item: nofile
      name: '*'
      state: present
      type: soft
  vars:
    ulimit_nofile: 65536
