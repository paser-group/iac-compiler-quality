- become: true
  hosts: webservers
  name: Install Apache web server
  tasks:
  - apt:
      update_cache: true
    name: Update apt package list
  - apt:
      name: apache2
      state: latest
    name: Install Apache
  - name: Start Apache service
    service:
      enabled: true
      name: apache2
      state: started
  - copy:
      dest: /var/www/html/index.html
      src: index.html
    name: Deploy sample HTML file
    notify: restart Apache
- become: true
  hosts: all
  name: Add new user
  tasks:
  - name: Create a new user
    user:
      append: true
      group: sudo
      name: ansibleuser
      password: pwd123
      state: present
- become: true
  hosts: dbserver
  name: Install MySQL database server
  tasks:
  - apt:
      update_cache: true
    name: Update apt package list
  - apt:
      name: mysql-server
      state: latest
    name: Install MySQL
  - mysql_secure_installation:
      login_unix_socket: true
    name: Secure MySQL installation
- hosts: webservers
  name: Install Nginx web server
  tasks:
  - apt:
      update_cache: true
    name: Update apt package list
  - apt:
      name: nginx
      state: latest
    name: Install Nginx
  - name: Deploy sample HTML file
    template:
      dest: /var/www/html/index.html
      src: index.html.j2
  - name: Restart Nginx service
    service:
      name: nginx
      state: restarted
  - file:
      path: /etc/nginx/sites-enabled/default
      state: absent
    name: Remove default Nginx configuration
- become: true
  hosts: all
  name: Configure firewall
  tasks:
  - name: Open HTTP and HTTPS ports
    ufw:
      port: '{{ item }}'
      rule: allow
      state: enabled
    with_items:
    - 80
    - 443
