- gather_facts: false
  handlers:
  - name: restart apache
    service:
      enabled: true
      name: httpd
      state: restarted
  hosts: all
  tasks:
  - name: Install Apache
    notify: restart apache
    yum:
      name: httpd
      state: installed
  - name: Configure Apache
    notify: restart apache
    template:
      dest: /etc/httpd.conf
      src: /etc/httpd.conf.j2
- gather_facts: false
  hosts: web
  tasks:
  - name: Restart Apache
    service: name = apache2 state = restarted
  - apt:
      upgrade: dist
    name: Update Packages
- gather_facts: false
  hosts: db
  tasks:
  - name: Start MySQL Service
    service: name = mysql state = started
  - mysql_db:
      db_name: mydatabase
      login_password: password
      login_user: root
      state: dump
    name: Backup MySQL Database
    register: db_backup
  - name: Upload MySQL Backup
    scp:
      dest: /tmp/
      known_hosts: '{{ ansible_env.HOME }}/.ssh/known_hosts'
      recursive: true
      src: /tmp/{{ db_backup.dest }}
      ssh_key_file: '{{ ansible_env.HOME }}/.ssh/id_rsa'
