- hosts: all
  tasks:
  - name: Install Apache
    package: name=httpd state=installed
  - become: true
    name: Start Apache
    service: name=httpd state=restarted
- hosts: database
  tasks:
  - command: sudo apt-get install mysql-server
    name: Install MySQL
  - become: true
    name: Start MySQL
    service: name=mysql state=restarted
- hosts: web
  tasks:
  - iptables: rule='-A INPUT -p tcp --dport 80 -j ACCEPT' state=enabled permanent=true
    name: Set up Firewall
  - become: true
    copy: src=./web-app dest=/var/www/html/
    name: Deploy Web App
- hosts: app
  tasks:
  - apt: name={{ item }} state=present
    name: Install Dependencies
    with_items:
    - python-dev
    - python-pip
    - libssl-dev
    - libffi-dev
  - become: true
    command: python app.py
    name: Start App
- hosts: backup
  tasks:
  - become: true
    command: tar czvf /backup.tar.gz /var/www/html
    name: Create Backup
  - become: true
    copy: src=./backup.tar.gz dest=/mnt/backup/
    name: Transfer Backup
  - become: true
    command: rm /backup.tar.gz
    name: Clean Up Backup
