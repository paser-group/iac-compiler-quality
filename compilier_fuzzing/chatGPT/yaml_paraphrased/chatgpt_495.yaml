- become: true
  hosts: app-server
  name: Deploy Application
  tasks:
  - apt: name={{item}} state=installed
    name: Install dependencies
    with_items:
    - nginx
    - mysql-server
    - python3-pip
  - copy:
      dest: /etc/nginx/
      src: /etc/nginx/nginx.conf
    name: Configure web server
  - name: Start web server
    service: name=nginx state=started
  - mysql_db: name={{db_name}} login_user=root login_password={{db_password}}
    name: Create database
  - name: Install python packages
    pip: name={{item}}
    with_items:
    - flask
    - uwsgi
  - copy:
      dest: /var/www/html/
      src: files/app.py
    name: Deploy application code
  - command: uwsgi /var/www/html/app.py --http :{{app_port}} --processes 4 --threads
      2
    name: Start application server
  - name: Add user
    user:
      name: test_user
      password: test_pass
      state: present
  - file:
      path: /etc/mysql/db_password.txt
      state: absent
    name: Remove sensitive file
  - name: Restart services
    service:
      name: '{{item}}'
      state: restarted
    with_items:
    - nginx
    - mysql-server
    - uwsgi
  vars:
    app_port: 8080
    db_name: test_db
