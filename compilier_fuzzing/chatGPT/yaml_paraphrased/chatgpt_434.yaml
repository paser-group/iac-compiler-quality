- hosts: webservers
  name: Install Apache
  tasks:
  - apt: update_cache=yes
    name: Update apt cache
  - apt: name=apache2 state=latest
    name: Install Apache
  - copy:
      dest: /etc/apache2/apache2.conf
      src: /etc/apache2/apache2.conf
    name: Copy Apache config file
  - name: Start Apache service
    service:
      name: apache2
      state: started
  - name: Set Apache to start on boot
    service:
      enabled: true
      name: apache2
- hosts: dbservers
  name: Install MySQL
  tasks:
  - apt: update_cache=yes
    name: Update apt cache
  - apt: name=mysql-server state=latest
    name: Install MySQL
  - copy:
      dest: /etc/mysql/mysql.conf.d/mysqld.cnf
      src: /etc/mysql/mysql.conf.d/mysqld.cnf
    name: Copy MySQL config file
  - name: Start MySQL service
    service:
      name: mysql
      state: started
  - name: Set MySQL to start on boot
    service:
      enabled: true
      name: mysql
- hosts: webservers
  name: Configure web server
  tasks:
  - apt: name=php state=latest
    name: Install PHP
  - apt: name=libapache2-mod-php state=latest
    name: Install PHP module for Apache
  - name: Restart Apache service
    service:
      name: apache2
      state: restarted
- hosts: webservers
  name: Deploy web app
  tasks:
  - copy:
      dest: /var/www/html/
      src: /home/user/web_app/
    name: Copy web app files
  - name: Restart Apache service
    service:
      name: apache2
      state: restarted
- hosts: webservers:dbservers
  name: Set up firewall
  tasks:
  - name: Allow HTTP traffic
    ufw:
      port: http
      rule: allow
  - name: Allow HTTPS traffic
    ufw:
      port: https
      rule: allow
  - name: Enable firewall
    ufw:
      state: enabled
