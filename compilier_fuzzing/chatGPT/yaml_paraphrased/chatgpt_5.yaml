- hosts: windows_servers
  name: Update Windows Server
  tasks:
  - name: Install Windows Update Module
    win_command: Install-PackageProvider -Name NuGet -Force
  - name: Install PSWindowsUpdate
    win_command: Install-Module -Name PSWindowsUpdate -Force
  - name: Update Server
    register: update_result
    win_updates:
      category_names: '{{ item }}'
      state: '{{ state }}'
    with_items:
    - SecurityUpdates
    - DefinitionUpdates
    - CriticalUpdates
    - FeaturePacks
  - name: Reboot if Required
    win_reboot:
      force: true
      message: System will reboot in 5 minutes for updates to take effect.
      timeout: 600
      when: update_result.reboot_required == true
