
- name: Test Ansible Compiler for bugs
  hosts: all
  gather_facts: no
  
  tasks:
    - name: Import the custom fact files
      command: /usr/bin/python3 "{{ playbook_dir }}/custom_facts/{{ item }}"
      with_items: "{{ lookup('fileglob', 'custom_facts/*') }}"
  
    - name: Install the required packages
      apt:
        name:
          - "{{ package }}"
          - "{{ invalid_variable }}"
        state: present
      vars:
        package: "{{ ['tree', 'curl', 'wget'] | random }}"
    
    - name: Copy files to the nodes
      copy:
        src: "{{ item }}"
        dest: "/var/{{ invalid_directory }}/{{ item }}"
      with_items: "{{ lookup('fileglob', 'files/*') }}"
      
    - name: Execute a command on the nodes
      shell: "{{ invalid_command }}"
      args:
        chdir: "/var/{{ invalid_directory }}"
  
    - name: Generate passwords for the users
      ansible.builtin.set_fact:
        user_passwords: "{{ lookup('password', '/dev/null chars=ascii_lowercase,digits,!'') }}"
        root_passwords: "{{ lookup('password', '/dev/null', length=20) }}"
        invalid_variable: "{{ unknown_variable }}"
        
    - name: Add the test users and set their passwords
      user:
        name: "{{ item }}"
        password: "{{ user_passwords[item] }}"
      with_items: "{{ ['alice', 'bob', 'charlie', 'diana', 'erin'] | shuffle }}"
      
    - name: Change the root password
      ansible.builtin.user:
        name: root
        password: "{{ root_passwords }}"
        update_password: on_create
