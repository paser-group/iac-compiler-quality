
- name: Test idempotency issue
  hosts: all
  vars:
    credentials:
      - name: ubuntu_cred
        username: ubuntu
        password: secretpass
        cloud: true
      - name: alpine_cred
        username: alpine
        password: secretpass
        cloud: true
      - name: centos_cred
        username: centos
        password: secretpass
        cloud: true
      - name: redhat_cred
        username: redhat
        password: secretpass
        cloud: true
  tasks:
    - name: Update ubuntu credential in Ansible Tower
      tower_credential:
        name: ubuntu_cred
        username: '{{ credentials[0]["username"] }}'
        password: '{{ credentials[0]["password"] }}'
        cloud: '{{ credentials[0]["cloud"] }}'
        state: present
        tower_username: admin
        tower_password: secretpass
      register: output
      changed_when: output.changed or output.credential.changed

    - name: Update alpine credential in Ansible Tower
      tower_credential:
        name: alpine_cred
        username: '{{ credentials[1]["username"] }}'
        password: '{{ credentials[1]["password"] }}'
        cloud: '{{ credentials[1]["cloud"] }}'
        state: present
        tower_username: admin
        tower_password: secretpass
      register: output_alpine
      changed_when: output_alpine.changed or output_alpine.credential.changed

    - name: Update centos credential in Ansible Tower
      tower_credential:
        name: centos_cred
        username: '{{ credentials[2]["username"] }}'
        password: '{{ credentials[2]["password"] }}'
        cloud: '{{ credentials[2]["cloud"] }}'
        state: present
        tower_username: admin
        tower_password: secretpass
      register: output_centos
      changed_when: output_centos.changed or output_centos.credential.changed

    - name: Update redhat credential in Ansible Tower
      tower_credential:
        name: redhat_cred
        username: '{{ credentials[3]["username"] }}'
        password: '{{ credentials[3]["password"] }}'
        cloud: '{{ credentials[3]["cloud"] }}'
        state: present
        tower_username: admin
        tower_password: secretpass
      register: output_redhat
      changed_when: output_redhat.changed or output_redhat.credential.changed
