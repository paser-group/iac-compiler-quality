
- name: Test vmware_portgroup idempotence issue
  hosts: localhost
  gather_facts: no

  tasks:
    - name: Create vmware datacenter
      vmware_datacenter:
        hostname: "{{ host }}"
        username: "{{ username }}"
        password: "{{ password }}"
        validate_certs: no
        datacenter_name: "{{ datacenter_name }}"
      register: datacenter

    - name: Create vmware cluster
      vmware_cluster:
        hostname: "{{ host }}"
        username: "{{ username }}"
        password: "{{ password }}"
        validate_certs: no
        datacenter_name: "{{ datacenter_name }}"
        cluster_name: "{{ cluster_name }}"
      register: cluster

    - name: Create vmware portgroup
      vmware_portgroup:
        hostname: "{{ host }}"
        username: "{{ username }}"
        password: "{{ password }}"
        validate_certs: no
        datacenter_name: "{{ datacenter_name }}"
        cluster_name: "{{ cluster_name }}"
        portgroup_name: "{{ portgroup_name }}"
        vlan_id: "{{ vlan_id }}"
      register: portgroup

    - name: Test idempotence of vmware portgroup creation
      vmware_portgroup:
        hostname: "{{ host }}"
        username: "{{ username }}"
        password: "{{ password }}"
        validate_certs: no
        datacenter_name: "{{ datacenter_name }}"
        cluster_name: "{{ cluster_name }}"
        portgroup_name: "{{ portgroup_name }}"
        vlan_id: "{{ vlan_id }}"
      register: portgroup_idempotence

    - debug:
        var: portgroup_idempotence.changed
