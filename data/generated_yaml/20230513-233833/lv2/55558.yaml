
- name: Windows VMs inventory
  hosts: windows-vms

- name: Install pywinrm
  gather_facts: no
  tasks:
    - name: Install pywinrm via pip
      pip:
        name: pywinrm
        version: 0.4.1

- name: Configure winrm on Windows servers
  gather_facts: no
  hosts: windows-vms
  tasks:
    - name: Enable winrm service
      win_service:
        name: winrm
        start_mode: auto
        state: started

- name: Test winrm connection
  hosts: windows-vms
  tasks:
    - name: Test winrm connectivity
      win_ping:

- name: Create new user
  hosts: windows-vms
  tasks:
    - name: Create user
      win_user:
        name: "testuser"
        password: "Pa$$w0rd"
        groups: "Administrators"
        state: present

- name: Delete the newly created user
  hosts: all
  tasks:
    - name: Delete user
      win_user:
        name: "testuser"
        state: absent
