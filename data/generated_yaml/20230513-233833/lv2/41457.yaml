
---
- name: Test nxos_facts legacy subset
  hosts: all
  gather_facts: no
  tasks:
    - name: Run nxos_facts with subset fan which causes an error
      nxos_facts:
        subset: fan
      register: facts

    - name: Check if fan module exists in facts
      debug:
        msg: "Fan module exists in facts"
      when: "'fan' in facts"

    - name: Assert if fan module exists in facts
      assert:
        that: "'fan' in facts"
        fail_msg: "Fan module was not found in facts"
        success_msg: "Fan module was found in facts"

    - name: Check if facts contain a fan_accton module with inventory_hostname as key
      debug:
        msg: "Fan module exists with inventory_hostname as key"
      when: "'fan_accton' in facts[inventory_hostname]"

    - name: Assert if facts contain a fan_accton module with inventory_hostname as key
      assert:
        that: "'fan_accton' in facts[inventory_hostname]"
        fail_msg: "Fan module was not found with inventory_hostname as key"
        success_msg: "Fan module was found with inventory_hostname as key"

    - name: Check if facts contain a fan_cisco module across all hosts
      debug:
        msg: "Fan module exists across all hosts"
      when: "'fan_cisco' in hostvars[groups['all'][0]]['facts'] and 'fan_cisco' in hostvars[groups['all'][1]]['facts'] and 'fan_cisco' in hostvars[groups['all'][2]]['facts']"

    - name: Assert if facts contain a fan_cisco module across all hosts
      assert:
        that: "'fan_cisco' in hostvars[groups['all'][0]]['facts'] and 'fan_cisco' in hostvars[groups['all'][1]]['facts'] and 'fan_cisco' in hostvars[groups['all'][2]]['facts']"
        fail_msg: "Fan module was not found across all hosts"
        success_msg: "Fan module was found across all hosts"
