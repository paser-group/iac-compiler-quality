
---
- name: Test include_role bug
  hosts: all
  gather_facts: false

  tasks:
    - name: Include role with vars and defaults
      include_role:
        name: test_role
      vars:
        - var1: "{{ item }}"
      defaults:
        - def1: "{{ inventory_hostname }}"
      when: inventory_hostname == groups['node1'][0] or inventory_hostname == groups['node2'][0]
      loop: "{{ groups['all'] | difference(groups['node3']) }}"

  vars:
    - var2: "{{ var1 | replace('node', 'host') }}"
