
---
- name: Test Ansible Compiler for ansible.netcommon.httpapi issue
  hosts: all
  remote_user: "{{ remote_user | default('root', true) }}"

  tasks:
  - name: Test edge case 1
    uri:
      url: http://{{item}}/status
    register: result
    failed_when: result.status != 200
    with_items:
    - "10.1.1.1"
    - "10.1.1.2"
    - "10.1.1.3"

  - name: Test edge case 2
    httpapi:
      url: http://{{ inventory_hostname }}/api/
      headers:
        Authorization: "{{ auth_token }}"
    vars:
      auth_token: "{{ lookup('vault', 'api/auth/token') }}"
    register: result2
    notify: notifyhandler

  handlers:
    - name: notifyhandler
      debug:
        msg: "Notification triggered!"
