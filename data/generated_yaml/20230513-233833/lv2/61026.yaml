
---
- name: Test Ansible installation
  hosts: all
  gather_facts: no

  tasks:
    - name: Check if pyconfig.h exists
      command: ls /usr/include/python3.6m/pyconfig.h
      register: pyconfig_check

    - name: Install Ansible
      apt:
        name: ansible
        state: latest
      when: pyconfig_check.rc != 0

    - name: Install Ansible with pip
      pip:
        name: ansible
        state: present
      when: pyconfig_check.rc != 0

    - name: Install missing dependency
      apt:
        name: python3-dev
        state: present
      when: pyconfig_check.rc != 0

    - name: Install specific version of Ansible
      pip:
        name: ansible==2.6.5
        state: present
      when: pyconfig_check.rc != 0
