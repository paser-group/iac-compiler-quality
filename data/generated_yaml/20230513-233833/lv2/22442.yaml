
---
- name: Stress test EAPI connection
  hosts: all
  gather_facts: false

  tasks:
  - name: Connect to EAPI endpoint
    eos_command:
      command: "show version"
      provider: "{% if hostvars['localhost']['omni_user'] is defined %}{{ hostvars['localhost']['omni_user'] }}{% endif %} {% if hostvars['localhost']['omni_pass'] is defined %}{{ hostvars['localhost']['omni_pass'] }}{% endif %} {% if hostvars['localhost']['omni_host'] is defined %}{{ hostvars['localhost']['omni_host'] }}{% endif %}"
      register: result

  - name: Check EAPI connection
    debug:
      msg: "{{ result.stdout }}"
    failed_when: "not result.stdout"

  - name: Disconnect from EAPI endpoint
    eos_command:
      command: "exit\n"
      provider: "{% if hostvars['localhost']['omni_user'] is defined %}{{ hostvars['localhost']['omni_user'] }}{% endif %} {% if hostvars['localhost']['omni_pass'] is defined %}{{ hostvars['localhost']['omni_pass'] }}{% endif %} {% if hostvars['localhost']['omni_host'] is defined %}{{ hostvars['localhost']['omni_host'] }}{% endif %}"
