
---
- name: EC2 VPC deployment stress test
  hosts: all
  vars:
    vpc_name: stress-test-vpc
    subnet_names: ["stress-test-1", "stress-test-2"]
    cidr_block: "10.0.0.0/16"
    region: "us-west-2"
    zone1: "us-west-2a"
    zone2: "us-west-2b"
    invalid_value: "notvalid"
  tasks:
    - name: Create VPC
      ec2_vpc_net:
        name: "{{ vpc_name }}"
        cidr_block: "{{ cidr_block }}"
      register: vpc_result

    - name: Create subnet 1
      ec2_vpc_subnet:
        vpc_id: "{{ vpc_result.vpc.id }}"
        cidr: "{{ cidr_block }}"
        name: "{{ subnet_names[0] }}"
        az: "{{ zone1 }}":
      register: subnet1_result

    - name: Create subnet 2
      ec2_vpc_subnet:
        vpc_id: "{{ vpc_result.vpc.id }}"
        cidr: "{{ cidr_block }}"
        name: "{{ subnet_names[1] }}"
        az: "{{ zone2 }}":
      register: subnet2_result

    - name: Verify created subnets
      assert:
        that:
          - subnet1_result.subnet.id is defined
          - subnet2_result.subnet.id is defined

    - name: Test invalid parameter value
      ec2_vpc_subnet:
        vpc_id: "{{ vpc_result.vpc.id }}"
        cidr: "{{ cidr_block }}"
        name: "{{ invalid_value }}"
      ignore_errors: yes

    - name: Test concurrency
      async: 60
      poll: 2
      ec2_vpc_subnet:
        vpc_id: "{{ vpc_result.vpc.id }}"
        cidr: "{{ cidr_block }}"
        name: "concurrent-subnet-{{ item }}"
      with_sequence: count=10
