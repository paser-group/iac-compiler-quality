
---
- name: Stress Test AIX WPAR Handling
  hosts: all
  gather_facts: false

  tasks:
    - name: Start a WPAR process
      shell: chroot /wparspace_{{ item }}/ /usr/bin/startwparsrv
      loop: "{{ range(1, 100) }}"
      register: wpar_proc

    - name: Check output of startwparsrv
      assert:
        that: wpar_proc.stdout is not empty

    - name: Install package to WPARs
      shell: chroot /wparspace_{{ item }}/ apt-get install -y package_name_{{ item }}
      loop: "{{ range(1, 100) }}"

    - name: Run script on all WPARs
      script: wparscript.sh
      loop: "{{ range(1, 100) }}"
      register: wpar_script_output

    - name: Check output of wparscript.sh
      assert:
        that: wpar_script_output.stdout is not empty and wpar_script_output.stdout is search('success')

    - name: Stop all WPARs
      shell: chroot /wparspace_{{ item }}/ /usr/bin/stopwparsrv
      loop: "{{ range(1, 100) }}"
      register: wpar_stop

    - name: Check output of stopwparsrv
      assert:
        that: wpar_stop.stdout is not empty
