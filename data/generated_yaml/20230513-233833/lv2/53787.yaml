
- name: GCPubSub Module Error Test
  hosts: all
  gather_facts: false
  tasks:

    - name: Install Dependencies
      apt:
        name: '{{ item }}'
        state: present
      with_items:
        - python3
        - python3-dev

    - name: Configure GCPubSub Module
      pip:
        name: google-cloud-pubsub==1.5.0
        state: present

    - name: Import GCPubSub Module
      command: |
        - from google.cloud import pubsub_v1 as pubsub
        - from google.cloud.pubsub_v1 import PublisherClient, SubscriberClient
        - project_id = 'my-project'
        - topic_name = 'test-topic'
        - subscription_name = 'test-subscription'
      failed_when: false

    - name: Publish Message to GCPubSub Topic
      command: |
        - publisher = PublisherClient()
        - topic_path = publisher.topic_path(project_id, topic_name)
        - message = b'Hello World'
        - future = publisher.publish(topic_path, data=message)
      failed_when: false

    - name: Subscribe to GCPubSub Topic and Process Messages
      command: |
        - subscriber = SubscriberClient()
        - subscription_path = subscriber.subscription_path(project_id, subscription_name)
        - def callback(message):
            - print(f"Acknowledging {message.data}.")
            - message.ack()
        - subscriber.subscribe(subscription_path, callback=callback)
      failed_when: false
