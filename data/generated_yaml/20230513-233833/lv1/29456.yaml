
- hosts: localhost
  gather_facts: no
  vars:
    aws_region: us-east-1
    instance_id: <your_instance_id>

  tasks:
    - name: Get Instance Shutdown Behaviour
      ec2_instance_facts:
         region: "{{ aws_region }}"
         filters:
           instance-id: "{{ instance_id }}"
      register: instance_facts

    - name: Stop the Instance
      ec2:
        state: stopped
        instance_ids: "{{ instance_id }}"
        region: "{{ aws_region }}"
        instance_initiated_shutdown_behavior: stop

    - name: Update instance_initiated_shutdown_behavior
      ec2_mod:
        instance_ids: "{{ instance_id }}"
        region: "{{ aws_region }}"
        instance_initiated_shutdown_behavior: stop
      when: instance_facts.instances[0].instance_initiated_shutdown_behavior != 'stop'

    - name: Start the Instance
      ec2:
        state: running
        instance_ids: "{{ instance_id }}"
        region: "{{ aws_region }}"
