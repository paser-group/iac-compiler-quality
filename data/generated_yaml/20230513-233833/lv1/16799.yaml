yaml
---
- hosts: all
  tasks:
    - name: Install custom modules
      pip:
        name:
          - "{{ item }}"
        state: present
      with_items:
        - module1
        - module2
      when: ansible_local | default({})['library'] is undefined or ansible_local.library.version != "{{ inventory_hostname }}-{{ lookup('pipe', 'date +%s') }}"

    - name: Copy custom modules to library folder
      copy:
        src: "{{ item }}"
        dest: "/usr/share/ansible/plugins/modules/"
      with_items:
        - library/custom_module_folder1
        - library/custom_module_folder2
