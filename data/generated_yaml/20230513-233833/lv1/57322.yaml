
---
- name: Upgrade network_cli connection plugin
  hosts: all
  become: true

  tasks:
    - name: Install latest version of Ansible
      apt:
        name: ansible
        state: latest

    - name: Upgrade network_cli connection plugin
      ansible-galaxy:
        name: ansible.netcommon
        state: latest

    - name: Set network_cli as default connection plugin
      set_fact:
        ansible_connection: network_cli

    - name: Verify network_cli connection plugin performance
      command:
        command: ping -c 3 {{ inventory_hostname }}

    - name: Ensure SSH connection plugin is disabled
      lineinfile:
        path: /etc/ansible/ansible.cfg
        regex: '^#?connection = ssh'
        line: 'connection = local'
