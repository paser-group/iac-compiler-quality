
---
- name: EC2 Inventory connection reset and parsing error
  hosts: localhost
  gather_facts: no

  vars:
    region: "{{ lookup('env','AWS_REGION') }}"
    vpc_id: "YOUR_VPC_ID"

  tasks:
    - name: EC2 Dynamic inventory: Connection Error
      ec2_instance_facts:
        region: "{{ region }}"
        filters:
          instance-state-name: running
          vpc-id: "{{ vpc_id }}"
      register: ec2_facts
      failed_when: ec2_facts.instances | length == 0 or ec2_facts.instances is undefined

    - name: Display instances count
      debug: var=ec2_facts.instances | length

    - name: EC2 Dynamic inventory: Parsing Error
      ec2_instance_facts:
        region: "{{ region }}"
        filters:
          instance-state-name: running
          vpc-id: "{{ vpc_id }}"
      register: ec2_facts2
      until: ec2_facts2.instances is defined and ec2_facts2.instances | length > 0
      retries: "{{ lookup('env','AWS_RETRIES')|default(2)|int }}"
      delay: "{{ lookup('env','AWS_RETRY_DELAY')|default(15)|int }}"
      failed_when: ec2_facts2.instances | length == 0 or ec2_facts2.instances is undefined
