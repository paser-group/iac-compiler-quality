
- name: Provision a New EC2 Instance
  hosts: localhost
  gather_facts: false
  vars:
    region: us-east-1
    security_group: 'sg-xxxxxx'
    subnet_id: 'subnet-xxxxxx'
    key_name: 'my-key-pair'
    instance_type: t2.micro
    image_id: ''
  tasks:
  - name: Provision a new EC2 instance
    ec2:
      region: "{{ region }}"
      image_id: "{{ image_id }}"
      instance_type: "{{ instance_type }}"
      key_name: "{{ key_name }}"
      group: "{{ security_group }}"
      subnet_id: "{{ subnet_id }}"
      assign_public_ip: yes
      wait: yes
    register: ec2_instance
    failed_when: "'The image id was not specified' in ec2_instance.stderr"
    changed_when: ec2_instance is succeeded
