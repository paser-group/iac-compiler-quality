yaml
---
- hosts: localhost
  gather_facts: no

  vars:
    project_id: "YOUR_PROJECT_ID"
    zone: "YOUR_ZONE"
    cluster_name: "YOUR_CLUSTER_NAME"
    network: "YOUR_NETWORK_NAME"
    
  tasks:
  - name: Get private subnets for network {{ network }}
    gcp_compute_subnetwork_info:
      project: "{{ project_id }}"
      region: "{{ zone.split('-')[0] }}-{{ zone.split('-')[1] }}"
      network: "{{ network }}"
      filters:
        - name: purpose
          values:
            - PRIVATE
    register: subnets_result

  - name: Create GKE Cluster with Private Cluster Config
    gcp_container_cluster:
      auth_kind: serviceaccount
      project: "{{ project_id }}"
      location: "{{ zone }}"
      name: "{{ cluster_name }}"
      network: "{{ network }}"
      subnetwork_project_id: "{{ project_id }}"
      subnetwork_name: "{{ subnets_result.subnetworks[0].name }}"
      logging_service: logging.googleapis.com/kubernetes
      monitoring_service: monitoring.googleapis.com/kubernetes
      master_ipv4_cidr_block: 172.17.0.0/28
      private_cluster_config:
        enable_private_endpoint: true
        enable_private_nodes: true
      service_account_scopes:
        - https://www.googleapis.com/auth/compute
        - https://www.googleapis.com/auth/devstorage.read_only
        - https://www.googleapis.com/auth/logging.write
        - https://www.googleapis.com/auth/monitoring
    register: cluster_result

  - name: Check cluster status
    gcp_container_cluster_status:
      auth_kind: serviceaccount
      project: "{{ project_id }}"
      name: "{{ cluster_name }}"
      location: "{{ zone }}"
      state: present
    register: status_result
    until: status_result.status == 'RUNNING'
    retries: 10
    delay: 30
