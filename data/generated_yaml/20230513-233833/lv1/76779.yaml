
- name: Fix apt Package Installation Issues
  hosts: all
  become: true

  tasks:
    - name: Disable apt Automatic Updates
      apt:
        update_cache: no
        period: 0
        enabled: false
    - name: Update apt Cache
      apt:
        update_cache: yes
    - name: Install aptitude Package Manager
      apt:
        name: aptitude
        state: present
    - name: Install Virtual Packages using aptitude
      apt:
        name: "{{ item }}"
        state: present
        install_recommends: no
      loop:
        - virtualbox-guest-x11
        - virtualbox-guest-utils
        - virtualbox-guest-dkms
        - qemu-guest-agent
        - spice-vdagent
    - name: Re-enable apt Automatic Updates
      apt:
        update_cache: yes
        period: 3600
        enabled: true
