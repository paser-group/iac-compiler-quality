
- name: Test imc_rest module under high sessions
  hosts: all
  gather_facts: no

  vars:
    max_sessions: 100
    session_interval: 1

  tasks:
    - name: Create sessions
      imc_rest:
        hostname: "{{ inventory_hostname }}"
        username: "{{ imc_username }}"
        password: "{{ imc_password }}"
        port: "{{ imc_rest_port }}"
        session_timeout: "{{ max_sessions }}"
        validate_certs: "{{ imc_validate_certs }}"
      with_sequence: start=1 end="{{ max_sessions }}" stride="{{ session_interval }}"

    - name: Verify sessions
      imc_rest:
        hostname: "{{ inventory_hostname }}"
        username: "{{ imc_username }}"
        password: "{{ imc_password }}"
        port: "{{ imc_rest_port }}"
        validate_certs: "{{ imc_validate_certs }}"
