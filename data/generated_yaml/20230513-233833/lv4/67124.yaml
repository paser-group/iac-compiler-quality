
---
- name: Test WinRM connectivity to Windows Servers
  hosts: windows_servers
  gather_facts: no
  vars:
    ansible_connection: winrm
    ansible_port: 5986
    ansible_winrm_transport: ntlm
    ansible_winrm_server_cert_validation: ignore
  tasks:
    - name: Test connection to Windows server
      win_ping:
      register: win_ping_status
      retries: 3
      delay: 5
      until: win_ping_status.ping == "pong"
      failed_when: False
    - name: Handle connection errors
      fail:
        msg: "Failed to connect to the Windows server."
      when: win_ping_status.failed == True
