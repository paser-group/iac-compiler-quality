
- hosts: all
  vars:
    persisted_value: "{{  random_string(10) }}"
  tasks:
  - name: Insert default value
    blockinfile:
      path: /etc/myfile.txt
      insertbefore: 'EOF'
      block: "{{ persisted_value }}"
    register: first_block
    changed_when: first_block.changed

  - name: Replace default value in file
    blockinfile:
      path: /etc/myfile.txt
      backup: yes
      block: "{{ persisted_value.upper() }}"
      replace: '^{{ persisted_value }}$'
    register: second_block
    changed_when: second_block.changed
