
- name: Test iam_policy.py module
  hosts: all
  gather_facts: no

  tasks:
    - name: Install Ansible version 2.4.0 (devel 788a0d1b9e)
      raw: sudo pip install "ansible==2.4.0.dev0"

    - name: Test IAM policy creation
      iam_policy:
        region: us-west-2
        state: present
        policy_name: my-test-policy
        policy_document: "{{ lookup('file', 'test_policy.json') }}"
      register: policy_result
      tags: [iam]

    - name: Test IAM policy update
      iam_policy:
        region: us-west-2
        state: present
        policy_name: my-test-policy
        policy_document: "{{ lookup('file', 'test_policy_v2.json') }}"
      register: policy_update_result
      tags: [iam]

    - name: Test IAM policy deletion
      iam_policy:
        region: us-west-2
        state: absent
        policy_name: my-test-policy
      when: policy_result.changed
      tags: [iam]
