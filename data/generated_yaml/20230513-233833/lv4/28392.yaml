
- name: Create a virtual machine in Azure
  azure_rm_virtualmachine:
    resource_group: ansibleResourceGroup
    name: testVM
    vm_size: Standard_B1s
    admin_username: username
    admin_password: password
    image:
      offer: UbuntuServer
      publisher: Canonical
      sku: 16.04-LTS
      version: latest
    network_interface_names:
      - nic1
    tags:
      environment: test
  register: result
- name: Generate error to test error handling
  command: /bin/false
  ignore_errors: yes
- name: Clean up resources
  azure_rm_virtualmachine:
    resource_group: ansibleResourceGroup
    name: testVM
    state: absent
  when: result|failed
