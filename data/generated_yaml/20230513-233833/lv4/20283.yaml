
- name: Ensure reg keys are idempotent

  hosts: all

  tasks: 

  - name: Modify registry key value

    win_regedit:

      path: 'HKLM:\SOFTWARE\Vendor\Key'

      name: KeyName

      value: Value1

  - name: Check value after modification

    assert:

      that:

        - registry_key is exists

        - registry_key['value'] == 'Value1'

        - registry_key['type'] == 'REG_SZ'

      register: registry_key

  - name: Perform another registry modification

    win_regedit:

      path: 'HKLM:\SOFTWARE\Vendor\Key'

      name: KeyName

      value: Value2

  - name: Check value after modification

    assert:

      that:

        - registry_key is exists

        - registry_key['value'] == 'Value2'

        - registry_key['type'] == 'REG_SZ'

      register: registry_key
