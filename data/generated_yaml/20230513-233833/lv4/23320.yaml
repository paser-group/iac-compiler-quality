
- name: Test WinRM
  hosts: all
  gather_fact: False
  tasks:
    - name: Ping Pong
      win_ping:
    
    - name: Run Basic Command
      win_command: hostname

- name: Introduce ReadTimeout Errors
  hosts: all
  gather_facts: False
  vars:
    winrm_config_settings:
      MaxEnvelopeSizekb: 2056
      MaxTimeoutms: 60000
  tasks:    
    - name: Set WinRM Settings
      ansible.windows.winrm_winrmconf:
        settings: "{{winrm_config_settings}}"
    
    - name: Introduce Random Data Input
      win_command: "powershell -Command '1..1000000 | %{echo 1234567890 >> c:\\temp\\random.txt}'"
      async: 400
      poll: 1
      register: random_data_input_result
      failed_when: "'timeout exceeds' not in random_data_input_result.msg"
    
    - name: WinRM should Timeout during input of random data
      win_command: "powershell -Command 'Get-Content c:\\temp\\random.txt'" 
      failed_when: "'ReadTimeout' not in result.stderr"
