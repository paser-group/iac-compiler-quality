
- name: Test Ansible compiler
  hosts: all
  gather_facts: no
  become: yes

  tasks:
  - name: Install dependencies for testing Ansible modules
    apt:
      name: "{{ item }}"
      state: present
    with_items:
      - git
      - python3
      - python3-dev
      - python3-pip

  - name: Clone Ansible repository
    git:
      repo: https://github.com/ansible/ansible.git
      dest: "/opt/ansible"
      version: stable-2.10

  - name: Write custom test module
    copy:
      content: |
        ---
        #!/usr/bin/python3

        from ansible.test import runtest
        from ansible.utils.display import Display

        display = Display()

        result = runtest('python3 /opt/ansible/hacking/test-module', '/opt/ansible', '/opt/ansible/examples', display)

        display.banner('Test results')
        display.display('RESULT: {}'.format(result))

      dest: "/opt/ansible/test_module.py"
      mode: "0755"

  - name: Test runtest function in hacking/test-module module
    command: "/usr/bin/python3 /opt/ansible/test_module.py"
    register: test_result

  - name: Output test results
    debug:
      var: test_result.stderr_lines
    when: test_result.rc != 0
