
- name: Create an EC2 VPC with subnets
  hosts: localhost
  gather_facts: no
  vars:
    region: us-east-1
    vpc_cidr_block: 10.0.0.0/16
    public_subnet_cidr_block_1: 10.0.1.0/24
    public_subnet_cidr_block_2: 10.0.2.0/24
  tasks:
  - name: Create VPC
    ec2_vpc:
      state: present
      cidr_block: "{{ vpc_cidr_block }}"
      region: "{{ region }}"
      resource_tags:
        Name: ec2-vpc
    register: ec2_vpc

  - name: Create first subnet
    ec2_vpc_subnet:
      vpc_id: "{{ ec2_vpc.vpc.id }}"
      cidr: "{{ public_subnet_cidr_block_1 }}"
      region: "{{ region }}"
      resource_tags: {Name: subnet1}
      az: "{{ region }}a"
    register: subnet1

  - name: Create second subnet
    ec2_vpc_subnet:
      vpc_id: "{{ ec2_vpc.vpc.id }}"
      cidr: "{{ public_subnet_cidr_block_2 }}"
      region: "{{ region }}"
      resource_tags: {Name: subnet2}
      az: "{{ region }}b"
    register: subnet2

