
---
- name: Verify `win_firewall_rule` use 'leave existing'
  hosts: windows
  gather_facts: no
  vars:
    firewall_rules:
      - name: "Test Rule 1"
        enabled: true
        direction: "in"
        action: "allow"
        protocol: "tcp"
        local_port: "80, 443"
      - name: "Test Rule 2"
        enabled: true
        direction: "in"
        action: "allow"
        protocol: "tcp"
        local_port: "3389"
  tasks:
  - name: Create firewall rules
    win_firewall_rule:
      name: "{{ item.name }}"
      direction: "{{ item.direction }}"
      action: "{{ item.action }}"
      protocol: "{{ item.protocol }}"
      local_port: "{{ item.local_port }}"
      enabled: "{{ item.enabled }}"
    loop: "{{ firewall_rules }}"
  - name: Modify firewall rules
    win_firewall_rule:
      name: "{{ item.name }}"
      direction: "{{ item.direction }}"
      action: "{{ item.action }}"
      protocol: "{{ item.protocol }}"
      local_port: "{{ item.local_port }}"
      enabled: "{{ item.enabled }}"
      state: "present"
      existing: "true"
    loop: "{{ firewall_rules }}"
  - name: Set 'leave existing' for firewall rules
    win_firewall_rule:
      name: "{{ item.name }}"
      direction: "{{ item.direction }}"
      action: "{{ item.action }}"
      protocol: "{{ item.protocol }}"
      local_port: "{{ item.local_port }}"
      enabled: "{{ item.enabled }}"
      state: "present"
      existing: "true"
      set_rule: "yes"
      match: "all"
      set_profile: "public"
    loop: "{{ firewall_rules }}"
  