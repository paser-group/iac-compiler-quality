
- hosts: all
  gather_facts: false
  vars:
    vcenter_hostname: 'v-center.domain.com'
    vcenter_username: 'admin'
    vcenter_password: 'password'
    vcenter_template_name: 'wrong_template_name'
    vcenter_datacenter_name: 'Datacenter'
    vcenter_cluster_name: 'Cluster'

  tasks:
  - name: Test error message generated by vmware_guest module
    vmware_guest:
      hostname: "{{ vcenter_hostname }}"
      username: "{{ vcenter_username }}"
      password: "{{ vcenter_password }}"
      validate_certs: no
      name: TestVM
      template: "{{ vcenter_template_name }}"
      datacenter: "{{ vcenter_datacenter_name }}"
      cluster: "{{ vcenter_cluster_name }}"
      folder: /{{ vcenter_datacenter_name }}/vm

    register: vm_guest_result
    ignore_errors: yes

  - name: Fail with the error message from vmware_guest module
    fail:
      msg: "The vmware_guest module failed with the following message: {{ vm_guest_result.msg }}"
    when: vm_guest_result.failed
