
- name: Create a Virtual Machine
  vmware_guest:
    hostname: "{{ esxi_host }}"
    username: "{{ esxi_user }}"
    password: "{{ esxi_password }}"
    datacenter: "{{ datacenter }}"
    folder: "/{{ datacenter }}/vm/{{ vm_name }}"
    name: "{{ vm_name }}"
    guest_id: "{{ guest_id }}"
    disk:
      - size_gb: "{{ disk_size }}"
        type: "{{ disk_type }}"
        datastore: "{{ datastore }}"
    hardware:
      memory_mb: "{{ memory_size }}"
      num_cpus: "{{ cpu_count }}"
  register: vm_details

- name: Export VM to OVF
  vmware_export_ovf:
    hostname: "{{ esxi_host }}"
    username: "{{ esxi_user }}"
    password: "{{ esxi_password }}"
    ovf_folder: "/{{ datacenter }}/OVF-exports"
    vm_id: "{{ vm_details.instance.uuid }}"
    ovf_name: "{{ vm_name }}.ovf"
