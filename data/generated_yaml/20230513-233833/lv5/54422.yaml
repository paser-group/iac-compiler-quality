
# Create a new service account using gcp_iam_service_account_module and wait for 5 seconds
- name: Create service account
  gcp_iam_service_account:
    name: my-service-account
    project: my-project
    auth_kind: serviceaccount
    service_account_file: /path/to/service_account_file.json
  async: 5
  poll: 10

# Rerun the gcp_iam_service_account_module after 5 seconds and wait for 5 seconds
- name: Rerun service account creation to test for 409 error
  gcp_iam_service_account:
    name: my-service-account
    project: my-project
    auth_kind: serviceaccount
    service_account_file: /path/to/service_account_file.json
  async: 5
  poll: 10
  delay: 5

# Check if error message occurs
- name: Check for 409 error
  fail:
    msg: 409 Already Exists
  when: "stderr | search('409 Already Exists') is defined"
