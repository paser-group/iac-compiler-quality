
- name: Install pip
  hosts: all
  become: true
  gather_facts: true
  tasks:
  - name: Install pip
    apt:
      name: python-pip
      update_cache: yes

- name: Create virtual environment
  hosts: all
  become: true
  gather_facts: true
  tasks:
  - name: Create virtual environment
    pip:
      requirements: /path/to/requirements.txt
      virtualenv: /path/to/venv

- name: Install additional pip packages
  hosts: all
  become: true
  gather_facts: true
  tasks:
  - name: Install package
    pip:
      name: "{{ item }}"
      virtualenv: /path/to/venv
    with_items:
      - package1
      - package2
      - package3

- name: Run custom module with pipelining
  hosts: all
  become: true
  gather_facts: true
  tasks:
  - name: Run custom module
    command: /path/to/custom/module | jq
    environment:
      PATH: "/path/to/venv/bin:{{ ansible_env.PATH }}"
    register: result
    failed_when: result.rc != 0
