
- name: Get list of errored nodes without internal_ip
  openstack:
    cloud: "{{ openstack_cloud }}"
    module: server list
    state: error
  register: server_list

- name: Filter the list to get nodes without internal_ip
  set_fact:
    nodes_without_internal_ip: "{{ server_list | json_query(query) }}"
  vars:
    query: "servers[?addresses.internal_ip == null].name"

- name: Print the list of nodes without internal_ip
  debug:
    var: nodes_without_internal_ip
