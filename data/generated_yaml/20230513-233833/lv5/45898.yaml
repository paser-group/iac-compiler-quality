
- name: Ping all hosts
  ping:

- name: Check SSH Connection
  vars:
    unreachable_nodes: []
  block:
    - name: ssh to node1
      hosts: node1
      connection: local
      become: false
      gather_facts: no
      shell: echo "Connected to {{ inventory_hostname }}"
      ignore_errors: true
      register: ssh_node1

    - name: add node1 to unreachable_nodes
      when: ssh_node1 is failed
      set_fact:
        unreachable_nodes: "{{ unreachable_nodes|default([]) + [inventory_hostname] }}"

    - name: ssh to node2
      hosts: node2
      connection: local
      become: false
      gather_facts: no
      shell: echo "Connected to {{ inventory_hostname }}"
      ignore_errors: true
      register: ssh_node2

    - name: add node2 to unreachable_nodes
      when: ssh_node2 is failed
      set_fact:
        unreachable_nodes: "{{ unreachable_nodes|default([]) + [inventory_hostname] }}"

    - name: ssh to node3
      hosts: node3
      connection: local
      become: false
      gather_facts: no
      shell: echo "Connected to {{ inventory_hostname }}"
      ignore_errors: true
      register: ssh_node3

    - name: add node3 to unreachable_nodes
      when: ssh_node3 is failed
      set_fact:
        unreachable_nodes: "{{ unreachable_nodes|default([]) + [inventory_hostname] }}"

- name: Print unreachable nodes
  debug: var=unreachable_nodes
