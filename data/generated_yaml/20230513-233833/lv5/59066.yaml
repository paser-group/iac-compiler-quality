
- name: Test SSH connection to target node
  hosts: all
  gather_facts: no
  tasks:
    - name: Scan the target node and add public key to known_hosts file
      shell: ssh-keyscan -H {{ inventory_hostname }} >> ~/.ssh/known_hosts
      args:
        creates: ~/.ssh/known_hosts
      become: no

    - name: Test SSH connection
      wait_for:
        port: 22
        timeout: 10
      delegate_to: localhost
      vars:
        ansible_ssh_private_key_file: /path/to/private/key
      become: no
      connection: ssh
