
- name: Get service status
  hosts: all
  gather_facts: yes

  tasks:
    - name: Get service facts
      service_facts:

    - name: Debug service status
      debug:
        var: ansible_facts.services

    - name: Check disabled service state
      fail:
        msg: "{{ item.key }} service is not running"
      when: item.value.state == 'unknown' and item.value.enabled == false
      with_dict: "{{ ansible_facts.services }}"
