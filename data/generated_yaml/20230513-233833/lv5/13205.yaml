
---
- name: Test async error with check mode
  hosts: all
  gather_facts: no

  tasks:
    - name: Test async task with check mode
      async: 60
      poll: 0
      shell: sleep 10 && echo "Hello, Ansible!"
      register: async_task
      check_mode: true

    - name: When async task fails in check mode
      fail:
        msg: "Async tasks cannot be performed in check mode."
      when: async_task.failed and 'check mode is active' in async_task.msg

