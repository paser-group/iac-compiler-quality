
- name: Configure docker for ipv6 port bindings
  hosts: all
  become: yes
  vars:
    docker_bridged_ipv6_address: "fd00:1234:5678:a::1/64"
    docker_subnet: "fd00:1234:5678:b::/80"
    docker_gateway_ipv6_address: "fd00:1234:5678:b::1"
  tasks:
  - name: Configure docker bridge for ipv6
    copy:
      content: |
        [Unit]
        Description=Docker ipv6 Bridge
        [NetDev]
        Name=docker0
        Kind=bridge
        [IPAddr]
        Address={{ docker_bridged_ipv6_address }}
        [Bridge]
        MaxPorts=256
        [Network]
        Address={{ docker_subnet }}
        Gateway={{ docker_gateway_ipv6_address }}
        IPv6AcceptRA=yes
        IPv6Forwarding=no
        LinkLocalAddressing=no
      dest: /etc/systemd/network/docker-ipv6.network
    register: docker_bridge_file_status
    changed_when: docker_bridge_file_status.changed

  - name: Reload netplan config
    shell: "networkctl reload"

  - name: Ensure ipv6 is enabled for the container runtime
    sysctl:
      name: "{{ item }}"
      value: "1"
      sysctl_set: yes
      state: present
    with_items:
    - net.ipv6.conf.all.disable_ipv6
    - net.ipv6.conf.default.disable_ipv6
    - net.ipv6.conf.lo.disable_ipv6
    - net.ipv6.conf.eth0.disable_ipv6
    - net.ipv6.conf.docker0.disable_ipv6

  - name: Configure ipv6 port bindings for the containers
    docker_container:
      name: "{{ item.name }}"
      image: "{{ item.image }}"
      ipv6_address: "{{ item.ipv6_address }}"
      published_ports: "{{ item.published_ports }}"
    with_items:
    - name: "container_1"
      image: "ubuntu"
      ipv6_address: "fd00:1234:5678:b::2"
      published_ports:
      - "fd00:1234:5678:a::2:22:22/tcp"
      - "fd00:1234:5678:a::2:80:80/tcp"
    - name: "container_2"
      image: "ubuntu"
      ipv6_address: "fd00:1234:5678:b::3"
      published_ports:
      - "fd00:1234:5678:a::3:22:22/tcp"
      - "fd00:1234:5678:a::3:80:80/tcp"
