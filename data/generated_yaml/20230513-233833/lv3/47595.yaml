
- name: Deploy EC2 instance and copy AMI
  hosts: localhost
  gather_facts: no
  vars:
    aws_region: eu-west-1
    source_ami: ami-0a8b886f900bdcd97
    destination_region: us-east-1
    wait_timeout: 300
    tag_name: Name
    tag_value: AnsibleAMI
  tasks:
    - name: Launch EC2 instance
      ec2:
        instance_type: t2.micro
        image: "{{ source_ami }}"
        wait: yes
        region: "{{ aws_region }}"
        count: 1
        instance_tags:
          Name: AnsibleInstance
        assign_public_ip: yes
        key_name: myKey
        group_id: sg-123456789
        vpc_subnet_id: subnet-abcd1234
      register: ec2_instance

    - name: Wait for instance to become available
      wait_for:
        host: "{{ item.public_ip }}"
        port: 22
        delay: 10
        timeout: 300
      with_items: "{{ ec2_instance.instances }}"

    - name: Copy AMI to destination region
      ec2_ami_copy:
        source_region: "{{ aws_region }}"
        destination_region: "{{ destination_region }}"
        source_image_id: "{{ source_ami }}"
        name: "{{ tag_value }}"
        tag_equality:
          key: "{{ tag_name }}"
          value: "{{ tag_value }}"
        wait: yes
        wait_timeout: "{{ wait_timeout }}"
      register: ami_copy
