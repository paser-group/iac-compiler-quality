
---
- name: Recreate and Expose Issues with OpenStack security group rules deletion
  hosts: all
  become: true
  tasks:
  - name: Create a new security group
    os_security_group:
      state: present
      name: new-sec-group
      description: New security group
    register: new_sg

  - name: Add security rule to the new security group
    os_security_group_rule:
      security_group: "{{ new_sg.security_group.name }}"
      direction: ingress
      ethertype: IPv4
      protocol: tcp
      port_range_min: 22
      port_range_max: 22
      remote_ip_prefix: 10.1.1.0/24

  - name: Delete the default security group rule
    os_security_group_rule:
      security_group: default
      direction: ingress
      ethertype: IPv4
      protocol: all
      remote_ip_prefix: 0.0.0.0/0
      state: absent
    register: deletion

  - name: Fail if unable to delete default security group rule
    fail:
      msg: "Unable to delete default security group rule"
    when: deletion is not defined or deletion is failed
