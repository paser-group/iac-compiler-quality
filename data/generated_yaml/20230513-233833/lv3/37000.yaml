
---
- hosts: all
  gather_facts: no
  vars:
    vm_name: TestVM
    vmware_user: "{{ vault_vmware_user }}"
    vmware_password: "{{ vault_vmware_password }}"
    vmware_server: "{{ vault_vmware_server }}"
  tasks:
  - name: Create the virtual machine
    vmware_guest:
      name: "{{ vm_name }}"
      state: poweredon
      vmware_guest_disk:
        disk1:
          size_gb: 10
      vmware_guest_hw:
        memory_mb: 1024
        num_cpus: 1
        guest_id: ubuntu64Guest
      vmware_username: "{{ vmware_user }}"
      vmware_password: "{{ vmware_password }}"
      vmware_hostname: "{{ vmware_server }}"
    register: vm

  - name: Try to delete the virtual machine
    vmware_guest:
      name: "{{ vm_name }}"
      state: absent
      vmware_username: "{{ vmware_user }}"
      vmware_password: "{{ vmware_password }}"
      vmware_hostname: "{{ vmware_server }}"
    ignore_errors: yes
