
- hosts: all
  gather_facts: no
  tasks:
    - name: Create semaphore file
      file:
         path: /dev/shm/my_semaphore
         state: touch

    - name: Acquire semaphore
      command: bash -c "( flock -x 200; sleep 2; ) 200>/dev/shm/my_semaphore"

    - name: Sleep to keep the lock
      pause:
        seconds: 5

    - name: Acquire semaphore again
      command: bash -c "( flock -x 200; ) 200>/dev/shm/my_semaphore"
