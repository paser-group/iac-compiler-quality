
---
- name: Create and delete VMWare snapshot
  hosts: all
  gather_facts: no

  tasks:
  
  - name: create snapshot
    vmware_guest_snapshot:
      hostname: "{{ inventory_hostname }}"
      username: "{{ vault_vmware_user }}"
      password: "{{ vault_vmware_pass }}"
      validate_certs: no
      vm_id: "{{ vm_id }}"
      snapshot_name: "{{ snapshot_name }}"
      description: "{{ snapshot_description }}"
      state: present
    register: snapshot

  - name: delete snapshot
    vmware_guest_snapshot:
      hostname: "{{ inventory_hostname }}"
      username: "{{ vault_vmware_user }}"
      password: "{{ vault_vmware_pass }}"
      validate_certs: no
      vm_id: "{{ vm_id }}"
      snapshot_name: "{{ snapshot_name }}"
      state: absent
    when: snapshot.changed
