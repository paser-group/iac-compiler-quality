
---
- name: Install Ansible from source
  hosts: all
  become: true
  tasks:
    - name: Install dependencies
      package:
        name: ["python3", "python3-dev", "libffi-dev", "libssl-dev", "gcc"]
        state: present
      become: true

    - name: Clone Ansible from source
      git:
        repo: https://github.com/ansible/ansible.git
        dest: /usr/local/src/ansible
        version: stable-2.9
      become: true

    - name: Install Ansible from source
      command: make
      args:
        chdir: /usr/local/src/ansible
      become: true

    - name: Configure Ansible
      lineinfile:
        path: /etc/ansible/ansible.cfg
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
      loop:
        - { regexp: '^#*(inventory|library)_on_demand.*$', line: 'inventory_on_demand = True' }

    - name: Check Ansible version
      command: ansible --version
      register: ansible_version
      become: true

    - name: Print Ansible version
      debug:
        var: ansible_version.stdout_lines
