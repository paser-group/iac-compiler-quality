
---
- name: demonstrate_ec2_py_issue
  hosts: localhost
  gather_facts: no

  tasks:
  - name: ensure boto profile is configured
    block:
      - name: copy ec2.ini to correct location
        copy:
          src: "/path/to/ec2.ini"
          dest: "/etc/boto.cfg"
          mode: '0600'

      - name: set boto profile env variable
        lineinfile:
          path: "~/.bashrc"
          line: "export BOTO_CONFIG=/etc/boto.cfg"
          state: present
          
      - name: update the RDS instances using incorrect boto profile
        ec2_remote_facts:
          region: us-west-2
          filters:
            instance-state-name: running
          profile: "{{ boto_profile_name }}"
        register: ec2_facts

      - name: print the retrieved facts
        debug:
          var: ec2_facts

      - name: create entries for RDS instances with incorrect boto profile
        add_host:
          name: "{{ item.public_ip_address }}"
          groups: rds_instances
        with_items: "{{ ec2_facts.instances }}"

      - name: ping RDS Instances with incorrect boto profile
        ping:
        delegate_to: "{{ item.public_dns_name }}"
        with_items: "{{ groups['rds_instances'] | default([]) }}"
