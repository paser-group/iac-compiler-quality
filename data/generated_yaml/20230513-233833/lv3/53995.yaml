
---
- name: Fetch Virtual Machines with tags from Azure Cloud
  hosts: node1
  gather_facts: false
  vars:
    client_id: '<clientId>'
    secret: '<clientSecret>'
    tenant: '<tenantId>'
    subscription_id: '<subscriptionId>'
  tasks:
  - name: Set Azure cloud environment variables
    set_fact:
      azure_environment:
        ActiveDirectoryEndpoint: https://login.microsoftonline.com
        ResourceManagerEndpoint: https://management.azure.com/
        GraphEndpoint: https://graph.windows.net/
        SubscriptionId: "{{ subscription_id }}"
        TenantId: "{{ tenant }}"
        ClientId: "{{ client_id }}"
        Secret: "{{ secret }}"
  - name: Fetch Virtual Machines using tags
    azure_rm_virtualmachine_facts:
      resource_group: "myResourceGroup"
      tag_name: "myTag"
      tag_value: "myValue"
