
---
- name: Test ec2_elb_lb idempotence
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    region: "us-east-1"
    elb_name: "test-elb"
    subnet_ids:
      - "subnet-12345678"
      - "subnet-abcdefgh"
    security_group: "sg-0123456789abcdef"
    listeners:
      - "{{ elb_name }}-listener"
    instance_ids:
      - "i-1234567890abcdefg"
      - "i-0987654321abcdefg"

  tasks:
    - name: Create Elastic Load Balancer
      ec2_elb_lb:
        name: "{{ elb_name }}"
        subnets: "{{ subnet_ids }}"
        region: "{{ region }}"
        security_group: "{{ security_group }}"
        listeners: "{{ listeners }}"
        tags:
          Name: "{{ elb_name }}"
      register: elb

    - name: Add Listener to the Load Balancer
      ec2_elb_lb_listener:
        name: "{{ listeners[0] }}"
        load_balancer_name: "{{ elb_name }}"
        load_balancer_port: 80
        instance_protocol: http
        instance_port: 80
        region: "{{ region }}"

    - name: Register instances to the Load Balancer
      ec2_elb_lb_instance:
        region: "{{ region }}"
        load_balancer_name: "{{ elb_name }}"
        instance_ids: "{{ instance_ids }}"

    - name: Unregister first instance from the Load Balancer
      ec2_elb_lb_instance:
        region: "{{ region }}"
        load_balancer_name: "{{ elb_name }}"
        instance_ids: "{{ instance_ids[:1] }}"
        state: absent

    - name: Reregister the removed instance to the Load Balancer
      ec2_elb_lb_instance:
        region: "{{ region }}"
        load_balancer_name: "{{ elb_name }}"
        instance_ids: "{{ instance_ids[:1] }}"
