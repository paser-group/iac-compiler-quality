
---
- name: Reproduce Jinja 2.10 + Ansible 2.7.5 bug
  hosts: all
  gather_facts: false

  tasks:
    - name: Create set.j2 template
      shell: echo "{% set someval = 'a' %}set{% include 'include-me.j2' %}" > set.j2
      register: result
      changed_when: false

    - name: Create include-me.j2 template
      shell: echo "just text" > include-me.j2
      register: result
      changed_when: false

    - name: Render template
      template:
        src: set.j2
        dest: /tmp/test.conf
        mode: '0644'
      register: result
      changed_when: false
