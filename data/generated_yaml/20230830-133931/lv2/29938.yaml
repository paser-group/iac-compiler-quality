---
- name: Ansible Latent Bug Explorer
  hosts: all
  gather_facts: false

  vars:
    network_subnet: "10.1.1.0"
    network_gateway: "10.1.1.254"
    network_name: "node-net"
    nodes:
      - { name: "ubuntu1", ip: "10.1.1.1", distribution: "ubuntu" }
      - { name: "alpine1", ip: "10.1.1.2", distribution: "alpine" }
      - { name: "centos1", ip: "10.1.1.3", distribution: "centos" }
      - { name: "redhat1", ip: "10.1.1.4", distribution: "redhat" }

  tasks:
    - name: Create network subnet
      shell:
        cmd: "ip address add {{ network_subnet }}/24 dev eth0"
        executable: "/bin/bash"

    - name: Set gateway
      shell:
        cmd: "ip route add default via {{ network_gateway }}"
        executable: "/bin/bash"

    - name: Create network
      docker_network:
        name: "{{ network_name }}"
        subnet: "{{ network_subnet }}/24"
        gateway: "{{ network_gateway }}"

    - name: Create Docker nodes
      docker_container:
        name: "{{ item.name }}"
        image: "{{ item.distribution }}"
        command: /bin/sleep infinity
        detach: yes
        network_mode: "{{ network_name }}"
      loop: "{{ nodes }}"

    - name: Wait for nodes to come up
      wait_for:
        host: "{{ item.ip }}"
        state: started
        timeout: 20
      loop: "{{ nodes }}"