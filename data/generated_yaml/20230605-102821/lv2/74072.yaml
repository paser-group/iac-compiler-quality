
---
- name: Gathering Facts fails with 'failed to transfer file' error - Stress Test Playbook
  hosts: all
  gather_facts: false
  tasks:

    - name: Generate random file on remote system
      command: dd if=/dev/urandom of=/tmp/{{ item }} bs=100M count=1
      with_items:
        - "{{ 'a'*10 }}"
        - "{{ 'b'*10 }}"
        - "{{ 'c'*10 }}"

    - name: Copy files from remote systems
      copy:
        src: /tmp/{{ item }}
        dest: /tmp/stress-test/{{ inventory_hostname }}_{{ item }}
      with_items:
        - "{{ 'a'*10 }}"
        - "{{ 'b'*10 }}"
        - "{{ 'c'*10 }}"

    - name: Remove files from remote systems
      file:
        path: /tmp/stress-test/{{ inventory_hostname }}_{{ item }}
        state: absent
      with_items:
        - "{{ 'a'*10 }}"
        - "{{ 'b'*10 }}"
        - "{{ 'c'*10 }}"

    - name: Failing Gathering Facts Scenario #1
      command: "ssh -i /some/path/to/key.pem ansible-user@{{ inventory_hostname }} 'sudo -S /usr/bin/sudo -l'"
      register: sudo_check

    - name: Failing Gathering Facts Scenario #2
      copy:
        content: "{{ 'a'*100000 }}\n{{ 'b'*100000 }}\n{{ 'c'*100000 }}\n{{ 'd'*100000 }}\n{{ 'e'*100000 }}\n{{ 'f'*100000 }}\n{{ 'g'*100000 }}\n{{ 'h'*100000 }}\n{{ 'i'*100000 }}\n{{ 'j'*100000 }}"
        dest: /tmp/test_file
      delegate_to: "{{ inventory_hostname }}"

    - name: Failing Gathering Facts Scenario #3
      shell: "echo 'update test_table set name = '''$(echo -e '''\\'''')''''''''''', roll_no = 8, age = ''''$(echo -e '''\\'''')''''''' where student_id = ''1';' > /tmp/test.sql"
      delegate_to: "{{ inventory_hostname }}"
