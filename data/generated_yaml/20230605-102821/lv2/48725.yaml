
- name: Gather Azure VM facts
  hosts: all
  gather_facts: false
  tasks:
    - name: Gather Azure VM facts
      azure_rm_virtualmachine_facts:
        resource_group: "{{ random(['test-resource-group', 'prod-resource-group']) }}"
        tags:
          environment: "{{ random([ 'test', 'prod' ]) }}"
        state: "{{ random([ 'running', 'stopped', 'deallocated' ]) }}"
      failed_when: vm_instances|length == 0 or state != 'running'
      register: vm_facts
      ignore_errors: "{{ random([ True, False]) }}"
    
    - name: Debug VM facts
      debug:
        var: vm_facts
