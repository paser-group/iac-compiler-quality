
- name: Adding security group rule
  hosts: all
  gather_facts: no
  
  tasks:
    - name: Create security group
      os_security_group:
        cloud: openstack
        state: present
        name: "{{ item }}"
      loop:
        - ubuntu1
        - alpine1
        - centos1
        - redhat1
      
    - name: Add security group rule
      os_security_group_rule:
        cloud: openstack
        state: present
        group_name: "{{ item }}"
        description: "Test rule"
        direction: ingress
        protocol: "{{ rand }}"
        port_range_min: 22
        port_range_max: 22
        remote_ip_prefix: "10.1.1.0/24"
      loop:
        - ubuntu1
        - alpine1
        - centos1
        - redhat1
      
  vars:
    rand: "{{ ['ip', 'tcp', 'udp', 'icmp', 'any'] | random }}"
