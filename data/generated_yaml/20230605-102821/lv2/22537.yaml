yaml
---
- name: Test EC2 instances health using EC2 ASG
  hosts: all
  become: yes

  tasks:
    - name: Wait for instances to be healthy in the target group
      ec2_asg:
        name: "{{ elb_asg_name }}"
        region: "{{ ec2_region }}"
        max_retries: 30
        health_check_grace_period: 300
        metrics_granularity: 1Minute
        wait_for_instances: true
      register: elb_asg

    - name: Print instance details
      debug:
        var: elb_asg.instances
