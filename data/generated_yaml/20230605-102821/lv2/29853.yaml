
- name: Test iam_policy module
  hosts: all
  tasks:
    - name: Create random JSON policy
      shell: "echo '{{ body }}' | base64 -d | fold -w 80 | sed 's/^/        /' > /tmp/policy.json"
      ignore_errors: yes

    - name: Create IAM policy
      iam_policy:
        name: "test_policy"
        policy_document: "{{ lookup('file', '/tmp/policy.json') }}"
        policy_json: "{{ body }}"
      ignore_errors: yes

    - name: Check if first node is up
      wait_for_connection:
        delay: 5
        timeout: 30
        sleep: 5
        connect_timeout: 5

    - name: Delete IAM policy
      iam_policy:
        name: "test_policy"
        state: absent
      ignore_errors: yes

    - name: Execute random command
      shell: "{{ random_command | default('ls -la /') }}"
      ignore_errors: yes
