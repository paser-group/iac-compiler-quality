
- name: Test vmware_guest without MAC address and with gather_facts
  hosts: all
  gather_facts: no
  vars:
    vm_name: "test_vm"

  tasks:
    - name: run vmware_guest without MAC address
      vmware_guest:
        hostname: "{{ inventory_hostname }}"
        username: "{{ ansible_user }}"
        password: "{{ lookup('env', 'VMWARE_PASSWORD') }}"
        datacenter: "{{ invalid_datacenter }}"
        folder: "/{{ invalid_folder }}"
        name: "{{ vm_name }}"
        state: poweredon
        disk:
          - size_gb: 20
            type: thin
            datastore: datastore1
        hardware:
          memory_mb: 2048
          num_cpus: 2
          osid: ubuntu64Guest
        networks:
          - name: "{{ invalid_network }}"
            ip: "{{ invalid_ip_address }}"
            netmask: "{{ invalid_netmask }}"
            connected: yes
      register: vmware_guest_result
      ignore_errors: true

    - name: run vmware_guest with fact gathering
      vmware_guest:
        hostname: "{{ inventory_hostname }}"
        username: "{{ ansible_user }}"
        password: "{{ lookup('env', 'VMWARE_PASSWORD') }}"
        datacenter: "{{ invalid_datacenter }}"
        folder: "/{{ invalid_folder }}"
        name: "{{ vm_name }}"
        state: poweredon
        disk:
          - size_gb: 20
            type: thin
            datastore: datastore1
        hardware:
          memory_mb: 2048
          num_cpus: 2
          osid: ubuntu64Guest
        networks:
          - name: "{{ invalid_network }}"
            ip: "{{ invalid_ip_address }}"
            netmask: "{{ invalid_netmask }}"
            connected: yes
      gather_facts: yes
      become: true
      register: vmware_guest_fact_gathering_result
      ignore_errors: true
