
- name: Test ovirtsdk4 issue
  hosts: ubuntu1
  gather_facts: no

  tasks:
  - name: Install python-ovirt-engine-sdk4
    yum:
      name: python-ovirt-engine-sdk4
      state: present
    register: ovirt_install

  - debug:
      var: ovirt_install

  - name: Install pycurl with no SSL support
    yum:
      name: libcurl-devel
      state: present
    register: curl_install

  - debug:
      var: curl_install

  - name: Compile pycurl with no SSL support
    command: |
      cd /usr/src
      wget https://github.com/curl/curl/releases/download/curl-7_60_0/curl-7.60.0.tar.gz
      tar -xzf curl-7.60.0.tar.gz
      cd curl-7.60.0
      ./configure --without-ssl --disable-shared
      make && make install
    register: pycurl_compile

  - debug:
      var: pycurl_compile

  - name: Try to import ovirtsdk4
    command: python -c "import ovirtsdk4"
    register: ovirt_import
    ignore_errors: True

  - debug:
      var: ovirt_import

  - name: Check if pycurl is used by ovirtsdk4
    command: ldd /usr/lib64/python2.7/site-packages/ovirtsdk4/*.so | grep -o "libcurl.so"
    register: ovirt_curl_check
    ignore_errors: True

  - debug:
      var: ovirt_curl_check

  - name: Clean up
    file:
      path: /usr/src/curl-7.60.0.tar.gz
      state: absent
