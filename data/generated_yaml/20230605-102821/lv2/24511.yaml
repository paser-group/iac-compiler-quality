
- name: Create a snapshot and delete it
  hosts: all
  gather_facts: false
  tasks:
    - name: Create a snapshot
      vmware_guest_snapshot:
        hostname: 10.1.1.5
        username: administrator@vsphere.local
        password: "{{ lookup('file', '/path/to/password/file') }}"
        validate_certs: no
        name: "{{ inventory_hostname }}"
        state: present
        memory: no
      register: snapshot_result

    - name: Assert snapshot created
      assert:
        that:
          - snapshot_result.changed == true

    - name: Delete the snapshot
      vmware_guest_snapshot:
        hostname: 10.1.1.5
        username: administrator@vsphere.local
        password: "{{ lookup('file', '/path/to/password/file') }}"
        validate_certs: no
        name: "{{ inventory_hostname }}"
        state: absent

    - name: Assert snapshot deleted
      assert:
        that:
          - snapshot_result.changed == false
