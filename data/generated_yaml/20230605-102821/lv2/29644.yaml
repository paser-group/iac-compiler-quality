
---
- name: mysql_user host_all arguments conversion string formatting error stress test
  hosts: node-net
  gather_facts: no
  become: yes
  tasks:
  - name: Create MySQL User
    mysql_user:
      name: "{{ 'user_test' }}"
      password: "{{ 'test_password' }}"
      host: "{{ item }}"
      login_unix_socket: "{{ '/var/run/mysqld/mysqld.sock' }}"
      login_host: "{{ hostvars[item]['ansible_host'] }}"
      login_user: "{{ 'root' }}"
      login_password: "{{ 'root_password' }}"
      priv: "{{ 'test_db' }}.*:ALL,GRANT"
    with_items: "{{ groups['node-net'] }}"
    ignore_errors: true
  - name: Remove MySQL User
    mysql_user:
      name: "{{ 'user_test' }}"
      host_all: yes
      login_unix_socket: "{{ '/var/run/mysqld/mysqld.sock' }}"
      login_host: "{{ hostvars[item]['ansible_host'] }}"
      login_user: "{{ 'root' }}"
      login_password: "{{ 'root_password' }}"
    with_items: "{{ groups['node-net'] }}"
    ignore_errors: true

---

Note: this playbook attempts to create a MySQL user with a dangerous permission, and then it attempts to remove this user from the database. This code snippet has the potential to uncover new bugs in the Ansible compiler related to string formatting errors and malformed arguments to Ansible modules.