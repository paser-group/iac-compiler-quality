
---
- name: Reproduce HaProxy drain mode 'bool' object is not callable error
  hosts: all
  become: true

  tasks:
    - name: Create HaProxy configuration file
      copy:
        content: |
          global
            log /dev/log local0
            log /dev/log local1 notice
            chroot /var/lib/haproxy
            stats socket /run/haproxy/admin.sock mode 660 level admin
            stats timeout 30s
            user haproxy
            group haproxy
            daemon
            tune.ssl.default-dh-param 2048

          defaults
            log global
            mode http
            option httplog
            option dontlognull
            timeout connect 5000
            timeout client 50000
            timeout server 50000

          frontend http-in
            bind *:80
            default_backend servers

          backend servers
            mode: "{{ drain() }}"
            balance roundrobin
            server web1 ubuntu1:80 check
            server web2 alpine1:80 check
      dest: /etc/haproxy/haproxy.cfg
      mode: 0644

    - name: Restart HaProxy service
      systemd:
        name: haproxy
        state: restarted
