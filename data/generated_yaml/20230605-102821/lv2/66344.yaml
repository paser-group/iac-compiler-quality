
- name: Perform k8s_scale stress test
  hosts: all
  gather_facts: no
  tasks:
    - name: Set up SSH auth keys
      authorized_key:
        user: root
        state: present
        key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"

    - name: Install dependencies
      apt:
        name: "{{ item }}"
        state: present
      with_items:
        - curl
        - unzip

    - name: Create multiple deployments 
      shell: |
        for ((i=1;i<=10;i++)) do
          kubectl create deployment nginx-$i --image=nginx
        done
      register: deploy
      
    - name: Scale up and down all deployments
      shell: |
        for ((i=1;i<=10;i++)) do
          kubectl scale --replicas=3 deploy/nginx-$i 
        done
        
        sleep 20
        
        for ((i=1;i<=10;i++)) do
         kubectl scale --replicas=1 deploy/nginx-$i
        done
        
      register: scale
      
    - name: Clean up deployments 
      shell: |
        for ((i=1;i<=10;i++)) do
          kubectl delete deployment nginx-$i
        done
      register: cleanup
