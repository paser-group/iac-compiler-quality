
- name: Validate and execute Windows custom module
  hosts: windows
  gather_facts: no
  tasks:
    - name: Check if winrm protocol is available
      wait_for:
         port: 5986
         timeout: 10
         state: started
      register: win_connection

    - block:
        - name: Load dependencies
          win_shell: |
            Install-Module -Name {{ module_name }} -Force
          args:
            executable: powershell.exe
          register: module_install

        - name: Execute custom module
          win_shell: |
            {{ module_name }} -{{ module_args }}
          args:
            executable: powershell.exe
          register: module_output
      when: 
        - win_connection is succeeded
        - module_install is succeeded
        - module_output is succeeded

    - name: Print module output
      debug: 
        var: module_output.stdout_lines
