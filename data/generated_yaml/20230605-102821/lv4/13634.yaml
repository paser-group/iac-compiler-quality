
- name: group_by creates incorrect groups
  hosts: all
  tasks:
    - name: Create sample dictionary
      vars:
        sample_dict:
          - name: ubuntu1
            os: ubuntu
            groups:
              - web
          - name: alpine1
            os: alpine
            groups:
              - web
          - name: centos1
            os: centos
            groups:
              - db
          - name: redhat1
            os: redhat
            groups:
              - db
      debug: var=sample_dict
      run_once: true

    - name: Group hosts by group
      group_by:
        key: "{{ item.groups[0] }}"
      with_items: "{{ sample_dict }}"
      run_once: true
