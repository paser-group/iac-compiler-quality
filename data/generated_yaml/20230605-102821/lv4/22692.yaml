
---
- name: Create EC2 Spot Instances
  hosts: localhost
  vars:
    aws_access_key: 'YOUR_ACCESS_KEY'
    aws_secret_key: 'YOUR_SECRET_KEY'
    spot_price: '0.1'
    instance_type: 't2.micro'
    key_name: 'ec2-keypair'
    image: 'ami-04b9e92b5572fa0d1'
    security_group_id: "sg-0fd69f232b747b"
  tasks:
    - name: Provision EC2 spot instance
      ec2:
        spot_price: "{{ spot_price }}"
        key_name: "{{ key_name }}"
        instance_type: "{{ instance_type }}"
        image: "{{ image }}"
        wait: true
        count: 1
        group_id: "{{ security_group_id }}"
      register: ec2_instance

    - name: Wait for instance to start
      wait_for:
        host: "{{ item.private_ip }}"
        port: 22
        state: started
      with_items: "{{ ec2_instance.instances }}"

    - name: Run command on EC2 instance
      shell: echo "Hello World"
      delegate_to: "{{ item.private_ip }}"
      become: True
      become_user: 'ubuntu'
      with_items: "{{ ec2_instance.instances }}"
