
- name: Add Security Group Rule
  os_security_group_rule:
    state: present
    security_group: "{{ security_group }}"
    direction: ingress
    protocol: "{{ item.proto | default(omit) }}"
    ethertype: ipv4
    cidr: "{{ item.cidr_ip }}"
    port_range_min: "{{ item.from_port }}"
    port_range_max: "{{ item.to_port }}"
  with_items: "{{ rules }}"
  when: not ("{{ item.cidr_ip }}:{{ item.from_port }}:{{ item.to_port }}:{{ item.proto }}" in existing_rules)
