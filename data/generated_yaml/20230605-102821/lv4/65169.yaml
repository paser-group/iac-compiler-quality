
---
- name: Test IMC_REST Module with Maximum Sessions
  hosts: all
  gather_facts: no

  vars:
    devices:
      - name: ubuntu1
        ip: 10.1.1.1
        username: ubuntu
        password: SecretPassword
      - name: alpine1
        ip: 10.1.1.2
        username: root
        password: SecretPassword
      - name: centos1
        ip: 10.1.1.3
        username: centos
        password: SecretPassword
      - name: redhat1
        ip: 10.1.1.4
        username: redhat
        password: SecretPassword

  tasks:
    - name: Collect Data from Devices using IMC_REST
      imc_rest:
        host: "{{ item.ip }}"
        username: "{{ item.username }}"
        password: "{{ item.password }}"
        endpoint: "/rest/v1/network-device"
        method: "get"
        validate_certs: no
        timeout: 10
      register: result
      with_items: "{{ devices }}"
      ignore_errors: yes

    - name: Monitor Errors and Warnings
      debug:
        msg: "{{ item }}"
      with_items: "{{ result.results|selectattr('failed', 'defined')|list }}"
      when: item.failed == true

    - name: Echo Result
      debug:
        var: result
