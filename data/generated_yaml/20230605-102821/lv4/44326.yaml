
- name: Gather VMware Portgroup security policy info
  vmware_portgroup_facts:
    esxi_hostname: "{{ esxi_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: no
    name: "{{ portgroup_name }}"
  register: pg_facts

- name: Disable security policy
  vmware_portgroup:
    esxi_hostname: "{{ esxi_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: no
    name: "{{ portgroup_name }}"
    security:
      allow_promiscuous: false
      mac_changes: false
      forged_transmits: false
  when: pg_facts.security.allow_promiscuous == true or pg_facts.security.mac_changes == true or pg_facts.security.forged_transmits == true
