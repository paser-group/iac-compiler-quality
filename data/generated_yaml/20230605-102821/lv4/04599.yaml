
---
- name: Add SSH key to authorized_keys
  hosts: all
  become: yes
  vars:
    user: "ansible"
  tasks:
    - name: Ensure ssh directory exists
      file:
        path: "/home/{{ user }}/.ssh"
        state: directory
        mode: '0700'
        owner: "{{ user }}"
      become_method: su
    - name: Ensure authorized_keys file exists
      file:
        path: "/home/{{ user }}/.ssh/authorized_keys"
        state: touch
        mode: '0600'
        owner: "{{ user }}"
      become_method: su
    - name: Append SSH public key to authorized_keys file
      lineinfile:
        path: "/home/{{ user }}/.ssh/authorized_keys"
        line: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAAgQC8rjZrJQW2Vxod/V8BEDN/0LNTAZ29B3uW7GnHLJiHm7dd0mBLWgWhn7PLAdyTdygzN9lKv+Uk4P19tJiJ8r9SvFfd/4iAMJsjrDILzZimHLX6mTXVxE2RJhwzjkPb+fLreyvucxqzkwATyTbmVv77LxMCkQJnXuKPWR/jFQ== ansible"
        create: yes
      become_method: su
