yaml
---
- hosts: all
  gather_facts: yes
  tasks:
    - name: "Run a test command"
      command: echo "Test command"
      register: cmd_output
      changed_when: false
      ignore_errors: true

    - name: "Fail the play if there are errors on hosts"
      fail:
        msg: "Error on host {{ inventory_hostname }} detected."
      when: cmd_output is failed and (cmd_output.rc not in [20, 130])
