
- name: Test gce.py in virtual environment
  hosts: all
  gather_facts: false
  tasks:
    - name: Create virtual environment
      command: python3 -m venv ~/ansible-venv/
      
    - name: Activate virtual environment
      shell: source ~/ansible-venv/bin/activate
      
    - name: Install dependencies
      pip:
        name: google-auth
        virtualenv: ~/ansible-venv/
      
    - name: Test gce.py
      command: ansible-playbook -i inventory -e ansible_python_interpreter=~/ansible-venv/bin/python playbook.yml --private-key /var/tmp/key_I.pem --become-password-file <path_to_password_file>
      register: output
      
    - name: Echo output
      debug:
        msg: "{{ output.stdout_lines }}"
