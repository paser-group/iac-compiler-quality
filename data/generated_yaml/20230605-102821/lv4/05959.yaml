
- name: Create nova keypair directory
  file:
    path: "{{ nova_keypair_base_path }}/x509"
    state: directory
    mode: '0700'
    owner: nova
    group: nova

- name: Generate nova keypair
  command: >
    nova-api-os-keypairs
    --gen-keypair
    --rsakey_bits 4096
    --type ssh
    --user {{ user_name }}
  environment:
    OS_AUTH_URL: "{{ os_auth_url }}"
    OS_PROJECT_NAME: "{{ os_project_name }}"
    OS_PROJECT_DOMAIN_NAME: "{{ os_project_domain_name }}"
    OS_USERNAME: "{{ os_username }}"
    OS_USER_DOMAIN_NAME: "{{ os_user_domain_name }}"
    OS_PASSWORD: "{{ os_password }}"
    OS_REGION_NAME: "{{ os_region_name }}"
  become: true

- name: Set correct permissions on nova keypair
  file:
    path: "{{ nova_keypair_base_path }}/x509/{{ user_name }}.pem"
    mode: '0400'
    owner: nova
  become: true
