yaml
- name: Verify Service Availability
  hosts: all
  gather_facts: no
  tasks:
    - name: Check SSH service status
      service:
        name: sshd
        state: started
      async: 3600
      poll: 0
      register: service_status

    - name: Wait for service state
      async_status:
        jid: "{{ service_status.ansible_job_id }}"
      register: service_result
      until: service_result.finished
      retries: 30
      delay: 10

    - name: Verify service availability
      set_fact:
        service_available: "{{ 'reachable' if service_result.msg | regex_search('Active: active') else 'unreachable' }}"

    - name: Debug service status
      debug:
        var: service_available
