
- name: Test efs_facts module
  hosts: all
  gather_facts: false
  vars:
    efs_mount_target: "{{inventory_hostname}}:/"
    mount_dir: '/mnt/efs'
  tasks:
  - name: Set mount directory permissions
    file:
      path: "{{ mount_dir }}"
      state: directory
      mode: '0755'
  - name: Mount EFS file system
    mount:
      name: "{{ efs_mount_target }}"
      path: "{{ mount_dir }}"
      fstype: nfs4
      opts: "nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2"
      state: mounted
  - name: Gather EFS Facts
    efs_facts:
      efs_file_system_id: "{{ efs_mount_target.split(':')[1] }}"
      region: "{{ ec2_metadata.region }}"
    register: result
  - name: Print EFS Facts
    debug:
      var: result.ansible_facts.efs_filesystems[0].mount_targets[0].network_interface_id
  - name: Unmount EFS file system
    mount:
      name: "{{ efs_mount_target }}"
      path: "{{ mount_dir }}"
      state: unmounted
