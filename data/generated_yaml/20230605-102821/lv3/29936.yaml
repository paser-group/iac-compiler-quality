
---
- hosts: localhost
  connection: local
  gather_facts: no
  vars:
    aws_access_key: <your_aws_access_key>
    aws_secret_key: "<your_aws_secret_key>"
    region: us-west-2

  tasks:
  - name: "Create security Group for ELB Instance"
    ec2_group:
      name: elb-security-group
      description: Security group for ELB Instances
      aws_access_key: "{{ aws_access_key }}"
      aws_secret_key: "{{ aws_secret_key }}"
      region: "{{ region }}"
      rules:
        - proto: tcp
          from_port: 80
          to_port: 80
          cidr_ip: 0.0.0.0/0
    register: security_group

  - name: "Add ELB Instances to Registry"
    ec2:
      aws_access_key: "{{ aws_access_key }}"
      aws_secret_key: "{{ aws_secret_key }}"
      region: "{{ region }}"
      instance_ids:
        - i-0123456789abcdef0
        - i-0123456789abcdef1
      assign_public_ip: yes
    register: elb_instances

  - name: "Create an Amazon Elastic Load Balancer"
    ec2_elb_lb:
      aws_access_key: "{{ aws_access_key }}"
      aws_secret_key: "{{ aws_secret_key }}"
      name: my-elb
      listener_descriptions:
        - protocol: "HTTP"
          load_balancer_port: "80"
          instance_protocol: "HTTP"
          instance_port: "80"
      instances:
        - "{{ item.id }}"
      health_check:
        ping_path: "/health_check"
        healthy_threshold: "2"
        unhealthy_threshold: "2"
        interval: "30"
        timeout: "5"
      region: "{{ region }}"
      subnets:
        - subnet-01234567
        - subnet-89101112
      security_group_names:
        - elb-security-group
    with_items: "{{ elb_instances.instances }}"
