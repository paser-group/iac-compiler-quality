
- name: Create Azure Virtual Machine
  azure_rm_virtualmachine:
    resource_group: "{{ resource_group }}"
    name: "{{ vm_name }}"
    admin_username: "{{ vm_username }}"
    admin_password: "{{ vm_password }}"
    image:
      offer: "{{ vm_offer }}"
      publisher: "{{ vm_publisher }}"
      sku: "{{ vm_sku }}"
      version: "latest"
    hardware_profile:
      vm_size: "{{ vm_size }}"
    os_disk:
      name: "{{ vm_name }}"
      caching: ReadOnly
      create_option: fromImage
      vhd:
        uri: "{{ vm_vhd_uri }}"
    network_interfaces:
      - name: "{{ vm_nic_name }}"
        properties:
          primary: true
    public_ip_allocation_method: "{{ vm_public_ip_allocation_method }}"
    os_type: "{{ vm_os_type }}"

- name: Trigger Azure Error
  azure_rm_virtualmachine:
    state: "{{ vm_error_state }}"
    resource_group: "{{ resource_group }}"
    name: "{{ vm_name }}"
  when: "{{ vm_error }}"

- name: Remove Azure Virtual Machine
  azure_rm_virtualmachine:
    resource_group: "{{ resource_group }}"
    name: "{{ vm_name }}"
    state: absent
