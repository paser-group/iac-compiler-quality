
- name: Test ec2 module
  hosts: localhost
  connection: local
  become: true
  tasks:
    - name: Launch EC2 instance
      ec2:
        key_name: my_key
        instance_type: t2.micro
        image: ami-0c55b159cbfafe1f0
        wait: yes
        instance_tags:
          Name: test_instance
          Environment: dev
        region: us-west-2
        count: 1
        vpc_subnet_id: subnet-abc1234
        assign_public_ip: yes
        group: sg-1234abcd
        changed_after: "2022-02-03T16:16:34Z"
      register: ec2_instance

    - name: Update tags of EC2 instance
      ec2_tag:
        resource: "{{ item.id }}"
        state: present
        tags:
          Name: test_instance_updated
          Environment: dev
      with_items: "{{ ec2_instance.instances }}"
      when: ec2_instance.changed is defined and ec2_instance.changed == true
