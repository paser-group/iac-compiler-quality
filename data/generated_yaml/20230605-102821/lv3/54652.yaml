
- name: Create a new server
  os_server:
    state: present
    auth:
      auth_url: <auth_url>
      username: <username>
      password: <password>
      project_name: <project_name>
      project_domain_name: <project_domain_name>
      user_domain_name: <user_domain_name>
    name: test-server
    flavor: m1.small
    image: trusty-server-cloudimg-amd64
    key_name: test-key
    network: "{{ inventory_hostname }}"
    port: "port-1"
    
- name: Re-run server module with different port ID
  os_server:
    state: present
    auth:
      auth_url: <auth_url>
      username: <username>
      password: <password>
      project_name: <project_name>
      project_domain_name: <project_domain_name>
      user_domain_name: <user_domain_name>
    name: test-server
    flavor: m1.small
    image: trusty-server-cloudimg-amd64
    key_name: test-key
    network: "{{ inventory_hostname }}"
    port: "port-2"
  when: "'port-1' in hostvars[inventory_hostname].os_server_networks['{{ inventory_hostname }}'][0].port_id"
