
- hosts: all
  gather_facts: no

  tasks:
  - name: Generate Let's Encrypt certificate with sub-agreement
    acme_certificate:
      account_email: "test@example.com"
      acme_directory: "{{ acme_staging_directory }}"
      acme_version: "v2"
      domains:
        - "{{ domain_name }}"
      validation: http-01
      authority: "{{ acme_authority }}"
      terms_agreed: yes
      tls_sni_01_address: "{{ ansible_default_ipv4.address }}"
      subdomains:
        - name: "{{ subdomain_name }}"
          options:
            - "http-01"
            - "tls-sni-01"
          opts:
            --challenge-alias
            "{{ subdomain_name }}.alias.acme.invalid"
          terms_agreed: yes
      state: present
