
- name: Create Azure VM
  azure_rm_virtualmachine:
    ...
  register: vm

- name: Check if VM provisioning succeeded
  assert:
    that:
      - vm.failed == false
      - vm.status == "Succeeded"

- name: Perform additional tasks on VM
  ...

- name: Delete VM if an error occurs
  block:
    - name: Perform risky task
      ...
    - name: Another risky task
      ...
  rescue:
    - name: Remove VM resources
      azure_rm_deleteresource:
        resource_group: "{{ vm.resource_group }}"
        name: "{{ vm.name }}"
        type: "Microsoft.Compute/virtualMachines"
