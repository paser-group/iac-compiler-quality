
- name: Delete default SG rules in OpenStack
  hosts: localhost
  gather_facts: no
  
  vars:
    security_group_name: "{{ lookup('env', 'SECURITY_GROUP_NAME') }}"
  
  tasks:
    - name: Get security group ID
      os_security_group_facts:
        filters:
          name: "{{ security_group_name }}"
      register: security_group_facts
      
    - name: Get security group rules
      os_security_group_rule_facts:
        security_group_id: "{{ security_group_facts.ansible_facts.openstack_security_groups[0].id }}"
      register: security_group_rule_facts
      
    - name: Delete security group rules
      os_security_group_rule:
        security_group_id: "{{ security_group_facts.ansible_facts.openstack_security_groups[0].id }}"
        rule_id: "{{ item.rule_id }}"
      with_items: "{{ security_group_rule_facts.ansible_facts.openstack_security_group_rules }}"
      ignore_errors: yes
      when: item.port_range_min > 0 or item.ethertype is undefined or item.description is not regex("^\\d+$")
      
    - name: Delete security group
      os_security_group:
        state: absent
        name: "{{ security_group_name }}"
      when: security_group_facts.ansible_facts.openstack_security_groups[0].id is defined
