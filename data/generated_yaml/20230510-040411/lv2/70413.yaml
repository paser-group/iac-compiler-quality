
---
- hosts: all
  gather_facts: no

  vars:
    my_dict:
      key1: value1
      key2: value2
      key3: value3

  tasks:
    - name: Loop over dict with missing key
      debug:
        msg: "{{ item.key }}"
      with_items:
        - "{{ my_dict }}"
        - "{{ my_dict.missing_key | default('default_value') }}"

    - name: Loop over dict with non-dict items
      debug:
        msg: "{{ item }}"
      with_items:
        - "{{ my_dict }}"
        - 42
        - "string item"

    - name: Loop over dict with non-iterable items
      debug:
        msg: "{{ item }}"
      with_items:
        - "{{ my_dict }}"
        - 42

    - name: Skip task on empty dict
      debug:
        msg: "This task should be skipped"
      when: my_dict is not defined or my_dict | length == 0

    - name: Loop over empty dict
      debug:
        msg: "This task should not be skipped"
      with_items: "{{ my_dict | default({}) }}"

    - name: Loop over dict with non-string keys
      debug:
        msg: "{{ item }}"
      with_items:
        - "{{ my_dict }}"
        - -123
        - true

    - name: Loop over dict with non-dict values
      debug:
        msg: "{{ item }}"
      with_items:
        - "{{ my_dict }}"
        - "a string"
        - 42
        - true
        - null
