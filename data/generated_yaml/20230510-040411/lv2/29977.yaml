
- name: Test AWS ASG Module Wait For Instances Property
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    ################################################
    # Define variables with unconventional syntax #
    ################################################
    instances_minimum: "{{ 1 if true else 0 }}"
    instances_maximum: "{{ 1 if (not true) else 10 }}"
    instances_latency: "[1, 2, 3, 4, 5]"
    desired_capacity: "{{ false if 'test' in wait_for_instances else true }}"
    instance_type: "{{ none if wait_for_instances|false else t2.micro }}"
    region: "{{ lookup('env', 'AWS_REGION') | default('us-east-1') }}"
    
  tasks:
  - name: Create ASG
    ec2_asg:
      name: my-test-asg
      launch_config_name: my-launch-config
      availability_zones: us-east-1a,us-east-1b
      desired_capacity: "{{ desired_capacity }}"
      min_size: "{{ instances_minimum }}"
      max_size: "{{ instances_maximum }}"
      health_check_type: ELB
      health_check_period: 60
      instance_type: "{{ instance_type }}"
      region: "{{ region }}"
    register: result

  - name: Assert result
    assert:
      that: result.desired_capacity == desired_capacity
