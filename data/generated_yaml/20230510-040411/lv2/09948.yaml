
---
- hosts: all
  gather_facts: yes

  tasks:
  - name: Install required packages
    apt:
      name: '{{ item }}'
      state: present
    with_items:
      - python
      - python-dev
      - python-pip

  - name: Set up virtual environment
    pip:
      requirements: '/path/to/requirements.txt'
      virtualenv: '/path/to/virtualenv'

  - name: Fix gce.py shebang
    replace:
      path: '/path/to/gce.py'
      regexp: '#!/usr/bin/python'
      replace: '#!/usr/bin/env python'

  - name: Run gce.py inside virtual environment
    command: '/path/to/virtualenv/bin/python /path/to/gce.py'
    register: output
    ignore_errors: yes

  - name: Display output
    debug:
      var: output.stdout_lines
