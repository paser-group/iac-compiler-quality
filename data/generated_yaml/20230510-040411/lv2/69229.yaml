
---
- name: Test postgresql_set on uppercase default_tablespace value
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Install PostgreSQL
      apt:
        name: postgresql
        state: present

    - name: Create a new test database
      postgresql_db:
        name: test_db
        state: present
        template: template0

    - name: Set default_tablespace with uppercase value
      postgresql_set:
        name: default_tablespace
        value: TEST

    - name: Assert that default_tablespace value is in lowercase
      assert:
        that:
          - ("TEST" | lower) in (ansible_postgresql.conf['defaults']['default_tablespace'] | lower)

    - name: Set invalid value to default_tablespace
      postgresql_set:
        name: default_tablespace
        value: invalid_value

    - name: Assert that error message is returned
      assert:
        that:
          - 'invalid_value is not a valid value for parameter "default_tablespace"' in ansible_postgresql.stderr
          - ansible_postgresql.rc != 0

    - name: Set default_tablespace with long value
      postgresql_set:
        name: default_tablespace
        value: "{{ 'a' * 100 }}"

    - name: Assert that default_tablespace value is truncated
      assert:
        that:
          - (("a" * 100)[:63] | lower) in (ansible_postgresql.conf['defaults']['default_tablespace'] | lower)
