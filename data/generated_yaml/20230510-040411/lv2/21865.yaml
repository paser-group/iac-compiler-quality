
---
- name: Test Ansible ec2_elb_lb idempotence issues
  hosts: localhost
  connection: local

  tasks:
    - name: Create an ELB
      ec2_elb_lb:
        name: "test-elb"
        listeners:
          - protocol: "HTTP"
            load_balancer_port: "80"
            instance_protocol: "HTTP"
            instance_port: "80"
        zones:
          - ap-southeast-2a
          - ap-southeast-2b
          - ap-southeast-2c
        state: "present"

    - name: Pause 10 seconds
      pause:
        seconds: 10

    - name: Ensure idempotence
      ec2_elb_lb:
        name: "test-elb"
        listeners:
          - protocol: "HTTP"
            load_balancer_port: "80"
            instance_protocol: "HTTP"
            instance_port: "80"
        zones:
          - ap-southeast-2a
          - ap-southeast-2b
          - ap-southeast-2c
        state: "present"

    - name: Modify the ELB
      ec2_elb_lb:
        name: "test-elb"
        listeners:
          - protocol: "TCP"
            load_balancer_port: "22"
            instance_protocol: "TCP"
            instance_port: "22"
        zones:
          - ap-southeast-2a
        state: "present"

    - name: Pause 10 seconds
      pause:
        seconds: 10

    - name: Ensure idempotence
      ec2_elb_lb:
        name: "test-elb"
        listeners:
          - protocol: "TCP"
            load_balancer_port: "22"
            instance_protocol: "TCP"
            instance_port: "22"
        zones:
          - ap-southeast-2a
        state: "present"

    - name: Remove the ELB
      ec2_elb_lb:
        name: "test-elb"
        state: "absent"

    - name: Pause 10 seconds
      pause:
        seconds: 10

    - name: Ensure idempotence
      ec2_elb_lb:
        name: "test-elb"
        state: "absent"
