
- name: Test out-of-memory issue with win_command and batch file
  hosts: all

  tasks:
    - name: Debug memory usage
      debug:
        msg: "Memory usage before executing batch file - {{ ansible_memfree_mb }} Mb free out of {{ ansible_memory_mb.real }} Mb total"

    - name: Run batch file with proper resource allocation
      shell: cmd /C "start /LOW /WAIT /B {{ environment.bat }}"
      async: 20
      poll: 0

    - name: Debug memory usage
      debug:
        msg: "Memory usage after executing batch file - {{ ansible_memfree_mb }} Mb free out of {{ ansible_memory_mb.real }} Mb total"
