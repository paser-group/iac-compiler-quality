
- name: Add VM to vmware_vm_inventory if it is not an orphaned VM
  vsphere_guest:
    vcenter_hostname: "<vCenter hostname/IP>"
    username: "<Username>"
    password: "<Password>"
    guest: "{{ item.name }}"
    validate_certs: False
  register: vmware_vm_result
  loop: "{{ vmware_vm_inventory }}"
  when: "not item.is_orphaned"
  
- name: Create vmware_vm_inventory file
  copy:
    content: "{{ vmware_vm | to_nice_json }}"
    dest: "/etc/ansible/vmware_vm_inventory.json"
