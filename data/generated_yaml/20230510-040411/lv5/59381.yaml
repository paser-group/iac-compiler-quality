
- name: Gather facts about the Cisco IOS device
  ios_facts:

- name: Enable pubkey authentication for SSH
  ios_config:
    lines:
      - "ip ssh pubkey-chain"
      - "username {{ ansible_user }} algorithm ssh-rsa public-key " "{{ lookup('file', '{{ pubkey_path }}') | regex_replace('\\n', '') }}" # replace newlines with empty string
    parents: # make sure to modify the correct parent config block, it may vary per version of IOS
      - "line vty"
        
- name: Test the SSH connection using pubkey authentication
  ios_ping:
