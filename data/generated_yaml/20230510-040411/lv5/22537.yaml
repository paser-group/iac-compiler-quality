
- name: wait for the ELB instances to start
  ec2_elb_facts:
    names: "{{ elb_instance_id }}"
  register: elb_status
  until: elb_status.instance_states | map(attribute='state') | select('equalto', 'InService') | list | count == elb_status.instance_states | list | count
  retries: 10
  delay: 30

- name: wait for the instances to be registered with the ELB
  ec2_instance_facts:
    filters:
      instance-state-name : running
      "tag:aws:autoscaling:groupName": "{{ asg_name }}"
  register: ec2_status
  until: ec2_status.instances | map(attribute='id') | difference(ec2_in_elb.instances | map(attribute='id')) | list | count == 0
  retries: 10
  delay: 30
