
---
- name: Test-Async-Connection-to-Service
  hosts: localhost
  gather_facts: no

  vars:
    target_ip: 192.168.1.1
    target_port: 8080
    timeout: 10  # seconds

  tasks:
    - name: Test Connection
      async: {{timeout}}
      poll: {{timeout}}
      ignore_errors: true
      command: |
        curl -I -s -f {{target_ip}}:{{target_port}}
      register: conn_result

    - name: Wait for Connection
      async_status: jid={{conn_result.ansible_job_id}}
      notify: Handle Connection Result

    - name: Fail if Connection Timed Out
      fail:
        msg: "Connection to {{target_ip}} timed out after {{timeout}} seconds"
      when: conn_result|failed

  handlers:
    - name: Handle Connection Result
      debug:
        msg: "Connection Result: {{(item.task_result|stdout_lines)[0]}}"
      loop: "{{lookup('async_status', 'ids=conn_result.ansible_job_id')}}"
