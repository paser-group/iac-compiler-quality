
- name: Verify permissions on authorized_keys file
  stat:
    path: /path/to/authorized_keys
  register: auth_keys_stat

- name: Ensure authorized_keys file is owned by user and mode is 0600
  file:
    path: /path/to/authorized_keys
    owner: "{{ ansible_ssh_user }}"
    group: "{{ ansible_ssh_user }}"
    mode: "0600"
  when: auth_keys_stat.stat.exists

- name: Verify authorized_keys file format
  shell: cat /path/to/authorized_keys | ssh-keygen -lf -
  register: auth_keys_format

- name: Restart SSH service when authorized_keys file changes
  service:
    name: ssh
    state: restarted
  when: auth_keys_format.changed
