
---
- name: Demo Playbook for 'delegate_to' and 'changing target' issue
  hosts: localhost
  gather_facts: false

  tasks:
  - name: Run task on target A
    debug:
      msg: "Task running on Target A"
    delegate_to: target_a

  - name: Change target for the next task and delegate to new target
    set_fact:
      new_target: target_b

  - name: Run task on new target B but use old delegate_to (Target A)
    debug:
      msg: "Unexpected behavior due to Target A delegate_to parameter"
    delegate_to: target_a
    when: "'target_b' in new_target"
