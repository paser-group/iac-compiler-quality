
---
- name: Fact gathering and cache race condition playbook
  hosts: all
  gather_facts: false

  tasks:
    - name: Get system facts
      setup:
    - name: Get network facts
      setup:
      gather_subset: network

  handlers:
    - name: Fact cache
      meta: clear_facts
      when: "ansible_check_mode == false"

- name: Concurrent fact gathering
  hosts: all

  tasks:
    - name: Fact gathering 1
      setup:
    - name: Fact gathering 2
      setup:
