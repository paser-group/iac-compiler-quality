
- name: Test playbook to expose ansible_user issues
  hosts: localhost
  gather_facts: no
  vars:
    users:
      - name: user1
        shell: /bin/bash
      - name: user2
        shell: /usr/bin/bash

  tasks:
    - name: Create users with with_items loop
      user:
        name: "{{ item.name }}"
        shell: "{{ item.shell }}"
      with_items: "{{ users }}"
      become: yes
      become_method: sudo
      become_user: root
