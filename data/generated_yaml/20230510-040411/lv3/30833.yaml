
---
- hosts: haproxy
  become: true
  tasks:
    - name: Install haproxy
      apt:
        name: haproxy
        state: present

    - name: Configure haproxy
      haproxy:
        backend: app_backend
        mode: http
        balance: roundrobin
        option: allbackups
        option: forwardfor
        option: httpchk
        option: redispatch
        cookie: SRV insert indirect nocache
        server: webserver1.example.com 192.0.2.1:80 check cookie webserver1
        server: webserver2.example.com 192.0.2.2:80 check cookie webserver2
        server: webserver3.example.com 192.0.2.3:80 check cookie webserver3
        drain: true  

    - name: Drain proxy connections
      haproxy:
        backend: app_backend
        state: drain
        addr: all
        port: all
        appsession: JSESSIONID
