
---
- name: Create EC2 RDS Postgres instance
  hosts: localhost
  gather_facts: false
  vars:
    region: "us-west-2"
    instance_name: "my-postgres-instance"
    db_name: "mydatabase"
    username: "myuser"
    password: "mypassword"
    instance_class: "db.t2.micro"
    engine: "postgres"
    engine_version: "10.6"
    license_model: "postgresql-license"
    allocation: 5
  tasks:
    - name: Create a new security group
      ec2_group:
        name: "{{ instance_name }}"
        description: "Security group for {{ instance_name }} instances"
        region: "{{ region }}"
        rules:
          - proto: tcp
            from_port: 5432
            to_port: 5432
            cidr_ip: 0.0.0.0/0
        rules_egress:
          - proto: all
            cidr_ip: 0.0.0.0/0
        vpc_id: "{{ vpc_id }}"
        state: present
      become: true
      tags:
        - security_group

    - name: Create a new EC2 RDS Postgres instance
      ec2_rds:
        instance_name: "{{ instance_name }}"
        db_name: "{{ db_name }}"
        username: "{{ username }}"
        password: "{{ password }}"
        instance_class: "{{ instance_class }}"
        engine: "{{ engine }}"
        engine_version: "{{ engine_version }}"
        license_model: "{{ license_model }}"
        allocate_storage: "{{ allocation }}"
        storage_type: "gp2"
        storage_encrypted: true
        ec2_security_group: "{{ instance_name }}"
        region: "{{ region }}"
        wait: true
      become: true
      tags:
        - rds_instance

    - name: Print the endpoint
      debug:
        msg: "The endpoint of the RDS instance is {{ ec2_rds[0].endpoint }} "
