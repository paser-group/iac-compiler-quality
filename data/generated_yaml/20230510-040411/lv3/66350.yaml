
- name: Creating a security group rule
  hosts: localhost
  gather_facts: false
  vars:
    security_group_name: "test-group"
    port: 80
    proto: "any"
    cidr_ip: "0.0.0.0/0"
  tasks:
    - name: Adding the security group rule
      os_security_group_rule:
        security_group: "{{ security_group_name }}"
        direction: ingress
        port_range_min: "{{ port }}"
        port_range_max: "{{ port }}"
        protocol: "{{ proto }}"
        cidr_ip: "{{ cidr_ip }}"
      register: output

    - name: Verifying whether the security group rule exists
      debug:
        var: output

    - name: Attempting to add the same security group rule
      os_security_group_rule:
        security_group: "{{ security_group_name }}"
        direction: ingress
        port_range_min: "{{ port }}"
        port_range_max: "{{ port }}"
        protocol: "{{ proto }}"
        cidr_ip: "{{ cidr_ip }}"
      register: duplicate_output

    - name: Verifying the error message on duplicate addition of rule
      debug:
        var: duplicate_output
