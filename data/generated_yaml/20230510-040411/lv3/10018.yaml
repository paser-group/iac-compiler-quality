
---
- name: Recreate Ansible Compiler Weakness
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Set delegate host
      set_fact:
        delegate_host: "{{ groups['all'][0] }}"

    - name: Copy a file from delegate host
      copy:
        src: files/testfile.txt
        dest: /tmp/
      delegate_to: "{{ delegate_host }}"
      become: true
      become_user: root

    - name: Read file content
      template:
        src: files/{{ inventory_hostname }}/testfile.txt.j2
        dest: /tmp/dest.txt
      delegate_to: "{{ delegate_host }}"
      become: true
      become_user: root
