
- name: Test S3 bucket versioning functionality
  hosts: localhost
  gather_facts: no
  tasks:
  - name: Create a versioned bucket
    s3_bucket:
      name: test-bucket
      region: us-east-1
      versioning_state: enabled
      access_key: ACCESS_KEY
      secret_key: SECRET_KEY

  - name: Attempt to retrieve the bucket versioning state
    s3_bucket:
      name: test-bucket
      region: us-east-1
      access_key: ACCESS_KEY
      secret_key: SECRET_KEY
      return_versioning_state: yes
    register: get_versioning_response

  - name: Confirm that the state matches the one we set
    fail:
      msg: "Bucket versioning state is not as expected"
    when: get_versioning_response['versioning_state'] != 'Enabled'
