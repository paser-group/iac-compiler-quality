
- name: Fetch GCE Firewall Rules
  hosts: localhost
  gather_facts: no
  vars:
    service_account_email: "{{ lookup('env', 'GCE_EMAIL') }}"
    credentials_file: "{{ lookup('env', 'GOOGLE_APPLICATION_CREDENTIALS') }}"
    project_name: "{{ lookup('env','GCE_PROJECT') }}"
  tasks:
  - name: Fetch GCE Firewall Rules
    google.cloud.gce_net:
      service_account_email: "{{ service_account_email }}"
      credentials_file: "{{ credentials_file }}"
      project_name: "{{ project_name }}"
      firewall_rules:
        - name: default-allow-http
          network: default
          allow:
            - protocol: tcp
              ports:
                - 80
  - name: Update GCE Firewall Rules
    google.cloud.gce_net:
      service_account_email: "{{ service_account_email }}"
      credentials_file: "{{ credentials_file }}"
      project_name: "{{ project_name }}"
      firewall_rules:
        - name: default-allow-http
          network: default
          allow:
            - protocol: tcp
              ports:
                - 443
