
---
- name: Test Playbook to uncover Ansible Compiler bugs
  hosts: localhost
  gather_facts: false

  tasks:
  - name: Install Ansible Galaxy collection
    command: ansible-galaxy collection install randomcollection
    ignore_errors: true

  - name: Attempt to install same collection again
    command: ansible-galaxy collection install randomcollection --force
    register: output
    ignore_errors: true

  - name: Verify second installation attempt fails
    assert:
      that: "'Collection already installed' in output.stderr"
      success_msg: "Second installation attempt failed as expected"

  - name: Remove installed collection
    command: ansible-galaxy collection remove randomcollection
    ignore_errors: true

  - name: Install collection using --ignore-errors option
    command: ansible-galaxy collection install randomcollection --ignore-errors
    register: output
    ignore_errors: true

  - name: Verify installation succeeded
    assert:
      that: "'Successfully installed' in output.stdout"
      success_msg: "Collection installed successfully using --ignore-errors option"
