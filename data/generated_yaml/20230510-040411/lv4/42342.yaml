
- name: Test MySQL connectivity
  hosts: db_hosts
  gather_facts: false
  tasks:
    - name: Test MySQL connectivity
      mysql_ping:
        login_host: "{{ mysql_host_ip }}"
        login_port: "{{ mysql_host_port }}"
        login_user: root
        login_password: "{{ mysql_root_password }}"

- name: Check for MySQL Python library compatibility
  hosts: db_hosts
  gather_facts: false
  tasks:
    - name: Install MySQL Python library
      pip:
         name: mysql-connector-python
         extra_args: "--user"
         executable: pip3

    - name: Create MySQL user with Python3 interpreter
      mysql_user:
        name: "{{ mysql_username }}"
        password: "{{ mysql_password }}"
        priv: "{{ mysql_db }}.*: ALL"
        host: "%"
        login_user: root
        login_password: "{{ mysql_root_password }}"
        login_host: "{{ mysql_host_ip }}"
        login_port: "{{ mysql_host_port }}"
        executable: python3

- name: Try creating a MySQL user with Python2 interpreter
  hosts: db_hosts
  gather_facts: false
  tasks:
    - name: Create MySQL user with Python2 interpreter
      mysql_user:
        name: "{{ mysql_username }}"
        password: "{{ mysql_password }}"
        priv: "{{ mysql_db }}.*: ALL"
        host: "%"
        login_user: root
        login_password: "{{ mysql_root_password }}"
        login_host: "{{ mysql_host_ip }}"
        login_port: "{{ mysql_host_port }}"
        executable: python2
