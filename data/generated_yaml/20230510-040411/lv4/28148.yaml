
- name: Request Let's Encrypt certificate using http-01 challenge
  become: true
  vars:
    domain_name: example.com
    email: user@example.com
    webroot_path: /var/www/html/
  tasks:
    - name: Install Python 3 and required modules for Let's Encrypt
      apt:
        name: '{{ item }}'
        state: present
      with_items:
        - python3
        - python3-venv
        - gcc
        - libffi-dev
        - libssl-dev
      become: true

    - name: Create virtual environment for Let's Encrypt
      command: python3 -m venv /root/letsencrypt
      become: true

    - name: Activate virtual environment for Let's Encrypt
      command: source /root/letsencrypt/bin/activate
      become: true

    - name: Install certbot and dependencies
      pip:
        name: certbot
        virtualenv: /root/letsencrypt
      become: true
    
    - name: Request Let's Encrypt certificate using http-01 challenge
      command: certbot certonly --agree-tos --renew-by-default --standalone --http-01-"))
        --email {{ email }} -d {{ domain_name }} -w {{ webroot_path }}
      become: true
