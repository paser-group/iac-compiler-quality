
- hosts: localhost
  tasks:
    - name: Create credential 
      tower_credentials:
        name: My Credential
        credential_type: aws
        inputs:
          access_key: "{{ my_access_key }}"
          secret_key: "{{ my_secret_key }}"
        state: present
        
    - name: Ensure idempotency
      tower_credentials:
        name: My Credential
        credential_type: aws
        inputs:
          access_key: "{{ my_access_key }}"
          secret_key: "{{ my_secret_key }}"
        state: present
      register: idempotency_result
      
    - name: Fail if not idempotent
      fail:
        msg: 'Idempotency test failed'
      when: idempotency_result.changed
