
- name: Test ec2_vpc module with boto 2.32.x
  hosts: localhost
  gather_facts: no
  vars:
    aws_access_key: "YOUR_ACCESS_KEY"
    aws_secret_key: "YOUR_SECRET_KEY"
    aws_region: "us-west-2"
    vpc_name: "test-vpc"
  tasks:
    - name: Create VPC
      ec2_vpc:
        state: present
        region: "{{ aws_region }}"
        name: "{{ vpc_name }}"
        cidr_block: 10.0.0.0/16
        aws_access_key: "{{ aws_access_key }}"
        aws_secret_key: "{{ aws_secret_key }}"
      register: vpc

    - name: Create Internet Gateway
      ec2_vpc_igw:
        vpc_id: "{{ vpc.vpc.id }}"
        state: present
        region: "{{ aws_region }}"
        aws_access_key: "{{ aws_access_key }}"
        aws_secret_key: "{{ aws_secret_key }}"
      register: igw

    - name: Create Subnet
      ec2_vpc_subnet:
        vpc_id: "{{ vpc.vpc.id }}"
        cidr: 10.0.1.0/24
        region: "{{ aws_region }}"
        aws_access_key: "{{ aws_access_key }}"
        aws_secret_key: "{{ aws_secret_key }}"
      register: subnet

    - name: Create Route Table
      ec2_vpc_route_table:
        vpc_id: "{{ vpc.vpc.id }}"
        region: "{{ aws_region }}"
        aws_access_key: "{{ aws_access_key }}"
        aws_secret_key: "{{ aws_secret_key }}"
      register: route_table

    - name: Add route to the Internet Gateway
      ec2_vpc_route_table_entry:
        route_table_id: "{{ route_table.table.id }}"
        dest_cidr_block: 0.0.0.0/0
        gateway_id: "{{ igw.gateway.id }}"
        region: "{{ aws_region }}"
        aws_access_key: "{{ aws_access_key }}"
        aws_secret_key: "{{ aws_secret_key }}"

    - name: Associate subnet with the route table
      ec2_vpc_subnet_route_table:
        subnet_id: "{{ subnet.subnet.id }}"
        route_table_id: "{{ route_table.table.id }}"
        region: "{{ aws_region }}"
        aws_access_key: "{{ aws_access_key }}"
        aws_secret_key: "{{ aws_secret_key }}"

    - name: Create Security Group
      ec2_group:
        name: "test-instance-sg"
        description: "test instance security group"
        vpc_id: "{{ vpc.vpc.id }}"
        region: "{{ aws_region }}"
        rules:
          - proto: tcp
            from_port: 80
            to_port: 80
            cidr_ip: 0.0.0.0/0
        aws_access_key: "{{ aws_access_key }}"
        aws_secret_key: "{{ aws_secret_key }}"
      register: sg

    - name: Launch instance
      ec2:
        key_name: "test-key"
        instance_type: "t2.micro"
        image: "ami-0c55b159cbfafe1f0"
        wait: true
        group: "{{ sg.group_id }}"
        vpc_subnet_id: "{{ subnet.subnet.id }}"
        region: "{{ aws_region }}"
        aws_access_key: "{{ aws_access_key }}"
        aws_secret_key: "{{ aws_secret_key }}"
      register: ec2_instance

    - name: Create HTTP server
      command: "echo '<h1>It works!</h1>' > index.html && nohup python -m SimpleHTTPServer 80 &"
      args:
        chdir: "/home/ec2-user"
      become: true
      become_user: ec2-user
