yaml
- name: Remove failed Azure virtual machine
  hosts: localhost
  connection: local
  
  vars:
    vm_name: my_vm_name
    resource_group: my_resource_group

  tasks:
  - name: Get failed virtual machines
    azure_rm_virtualmachine_info:
      resource_group: "{{ resource_group }}"
      name: "{{ vm_name }}"
    register: failed_vms

  - name: Remove failed virtual machine
    azure_rm_virtualmachine:
      resource_group: "{{ resource_group }}"
      name: "{{ vm_name }}"
      state: absent
    when: failed_vms is not defined or failed_vms.results is not defined or failed_vms.results | length == 0
