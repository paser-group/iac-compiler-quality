
---
- hosts: localhost
  gather_facts: no

  tasks:
    - name: Create VPC and Subnet
      vars:
        vpc_cidr_block: "10.0.0.0/16"
        public_subnet_cidr_block: "10.0.1.0/24"
        private_subnet_cidr_block: "10.0.2.0/24"
      ec2_vpc:
        state: present
        cidr_block: "{{ vpc_cidr_block }}"
        region: "{{ region }}"
        resource_tags:
          Name: "{{ vpc_name }}"
      register: vpc_result

    - name: Create Public Subnet
      ec2_vpc_subnet:
        state: present
        az: "{{ az }}"
        vpc_id: "{{ vpc_result.id }}"
        cidr: "{{ public_subnet_cidr_block }}"
        resource_tags:
          Name: "{{ public_subnet_name }}"
      register: public_subnet_result

    - name: Create Private Subnet
      ec2_vpc_subnet:
        state: present
        az: "{{ az }}"
        vpc_id: "{{ vpc_result.id }}"
        cidr: "{{ private_subnet_cidr_block }}"
        resource_tags:
          Name: "{{ private_subnet_name }}"
      register: private_subnet_result

    - name: Update VPC Route Table
      ec2_vpc_route_table:
        state: present
        vpc_id: "{{ vpc_result.id }}"
        routes:
          - dest: "0.0.0.0/0"
            gateway_id: "{{ internet_gateway_result.internet_gateway_id }}"
        resource_tags:
          Name: "{{ vpc_route_table_name }}"
      register: route_table_result
