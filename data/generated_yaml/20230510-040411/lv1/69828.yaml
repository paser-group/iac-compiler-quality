
- hosts: windows
  gather_facts: true
  become: true
  vars:
    ansible_connection: winrm
    ansible_winrm_transport: credssp
    ansible_winrm_credssp_includes: true
  tasks:
  - name: Test WinRM connection
    win_ping:
  - name: Install Prerequisites for credssp connection
    win_chocolatey:
      name: '-y KB2919355'
      state: present
    when: "'is_domain_joined' not in hostvars[inventory_hostname] or hostvars[inventory_hostname]['is_domain_joined'] == 'True'"
  - name: Install PowerShell 3.0 for credssp connection
    win_chocolatey:
      name: '-y PowerShell'
      state: present
    when: "'is_domain_joined' not in hostvars[inventory_hostname] or hostvars[inventory_hostname]['is_domain_joined'] == 'True'"
