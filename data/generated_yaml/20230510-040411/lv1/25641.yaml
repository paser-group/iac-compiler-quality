
- hosts: localhost
  gather_facts: false
  vars:
    cloudstack_api_endpoint: "http://example.com/client/api"
    cloudstack_api_key: "YOUR_API_KEY_HERE"
    cloudstack_secret_key: "YOUR_SECRET_KEY_HERE"
  tasks:
    - name: Add host to CloudStack
      cs_host:
        hostname: "{{ inventory_hostname }}"
        username: "{{ cloudstack_api_key }}"
        password: "{{ cloudstack_secret_key }}"
        url: "{{ cloudstack_api_endpoint }}"
        zone: "{{ zone }}"
        cluster: "{{ cluster }}"
        pod: "{{ pod }}"
        hypervisor: "{{ hypervisor }}"
        tags: "{{ tags }}"
        state: "{{ state }}"
      register: cloudstack_host

    - name: Add http:// prefix
      replace:
        path: "{{ cloudstack_host['url'] }}"
        regexp: '^(https{0,1}\:\/\/)'
        replace: 'http://'
      when: cloudstack_host['url'] is search('^https{0,1}\:\/\/')

