
---
- name: Create a GCP IAM service account
  hosts: localhost
  gather_facts: no
  vars:
    project_id: "my-project-id"
    service_account_name: "my-service-account"
  tasks:
    - name: Check if service account already exists
      google.cloud.gcp_iam_service_account_info:
        service_account_email: "{{service_account_name}}@{{project_id}}.iam.gserviceaccount.com"
      register: service_account_info
      ignore_errors: yes
  
    - name: Create service account if it does not exist
      google.cloud.gcp_iam_service_account:
        name: "{{service_account_name}}"
        project: "{{project_id}}"
      when: not service_account_info.service_account_email
