yaml
- name: Add security group rule
  hosts: server
  gather_facts: false

  tasks:

  - name: Find existing rule
    shell: >
      nova secgroup-list-rules securitygroup
      | awk '/0.0.0.0\/0/ && /any/ {print $0}'
    register: sg_rule

  - name: Add security group rule
    shell: >
      nova secgroup-add-rule securitygroup
      tcp 22 22 0.0.0.0/0
    when: sg_rule.rc != 0
