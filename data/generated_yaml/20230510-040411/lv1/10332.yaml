
- hosts: all
  gather_facts: true
  tasks:
    - name: Install necessary packages
      apt:
        name:
          - python3
          - python3-pip
        state: latest

    - name: Create virtualenv and activate it
      pip:
        virtualenv: /opt/env
        requirements: /opt/requirements.txt
        state: latest
      args:
        chdir: /opt

    - name: Clone the repository
      git:
        repo: https://github.com/example/repo.git
        dest: /opt
      args:
        recursive: true
        accept_hostkey: true

    - name: Run the script
      command: python3 /opt/script.py
      args:
        chdir: /opt
