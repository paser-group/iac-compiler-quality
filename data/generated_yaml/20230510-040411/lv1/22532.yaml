
---
- name: Ensure esg_asg module works reliably
  gather_facts: true
  hosts: all

  tasks:
    - name: Pause Task
      pause:
        seconds: 60
      changed_when: false

    - name: Restart AWS instance
      ec2:
        state: stopped
        instance_ids: <instance_id>
        wait: true
      register: stopped

    - name: Start stopped instances
      ec2:
        state: started
        instance_ids: <instance_id>
      when: stopped|int|changed

    - name: Wait for instance to be running
      local_action:
        module: wait_for
        host: "{{ item.public_dns_name }}"
        port: 22
        delay: 10
        timeout: 600
      with_items: "{{ ec2.instances }}"

    - name: Test ESG_ASG module
      command: <esg_asg_module_test_command>
      register: esg_asg_test_output
      ignore_errors: true

    - name: Retry Task
      pause:
        seconds: 120
      when: esg_asg_test_output.rc != 0

    - name: Debug Test Output
      debug:
        var: esg_asg_test_output
