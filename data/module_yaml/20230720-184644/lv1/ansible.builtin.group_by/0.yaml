- name: Dynamically group hosts
  hosts: all
  gather_facts: false

  tasks:
    - name: Get node facts
      ansible.builtin.setup:

    - name: Create parent groups
      ansible.builtin.group_by:
        key: "{{ item.key }}"
        parents: "{{ item.parents }}"
      loop:
        - { key: "OS:{{ ansible_facts['ansible_distribution']|lower }}", parents: [] }
        - { key: "IP:{{ ansible_facts['ansible_default_ipv4']['address'] }}", parents: [] }

    # Add more tasks here to perform actions on the created groups