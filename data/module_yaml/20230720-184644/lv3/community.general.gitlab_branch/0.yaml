---
- name: Test playbook for GitLab branch
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Set GitLab API variables
      set_fact:
        api_job_token: "my_job_token"
        api_oauth_token: "my_oauth_token"
        api_password: "my_password"
        api_token: "my_token"
        api_url: "https://gitlab.example.com/api/v4/"
        api_username: "my_username"

    - name: Create configuration values with bytes and strings
      set_fact:
        branch_bytes: "{{ 'my_branch' | encode('utf-8') }}"
        project_bytes: "{{ 'my_project' | encode('utf-8') }}"
        ref_branch_bytes: "{{ 'my_ref_branch' | encode('utf-8') }}"
        state_bytes: "{{ 'present' | encode('utf-8') }}"
        validate_certs_bytes: "{{ true | to_json | encode('utf-8') }}"

    - name: Create GitLab branch
      community.general.gitlab_branch:
        api_job_token: "{{ api_job_token }}"
        api_oauth_token: "{{ api_oauth_token }}"
        api_password: "{{ api_password }}"
        api_token: "{{ api_token }}"
        api_url: "{{ api_url }}"
        api_username: "{{ api_username }}"
        branch: "{{ branch_bytes | decode('utf-8') }}"
        project: "{{ project_bytes | decode('utf-8') }}"
        ref_branch: "{{ ref_branch_bytes | decode('utf-8') }}"
        state: "{{ state_bytes | decode('utf-8') }}"
        validate_certs: "{{ validate_certs_bytes | decode('utf-8') }}"

      register: result

    - name: Debug result
      debug:
        var: result