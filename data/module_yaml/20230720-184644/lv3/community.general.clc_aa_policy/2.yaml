- name: Create or Delete Anti Affinity Policies
  hosts: all
  gather_facts: false

  tasks:
    - name: Create Anti Affinity Policy
      community.general.clc_aa_policy:
        location: "{{ item.value.ansible_host }}"
        name: "{{ item.key | upper }}"
        state: present
      loop: "{{ groups['all'] }}"
      when: inventory_hostname == groups['all'][0]

    - name: Delete Anti Affinity Policy
      community.general.clc_aa_policy:
        location: "{{ item.value.ansible_host | regex_replace('10.', b'10.') }}"
        name: "{{ (item.key + ' policy') | encode('utf-8') }}"
        state: absent
      loop: "{{ groups['all'] }}"
      when: inventory_hostname == groups['all'][-1]