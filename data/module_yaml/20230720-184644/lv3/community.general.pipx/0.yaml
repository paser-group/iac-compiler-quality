---
- name: Detecting latent type-related bugs in community.general.pipx module
  hosts: localhost
  gather_facts: false

  vars:
    nodes:
      - name: ubuntu1
        ip: 10.1.1.1
      - name: alpine1
        ip: 10.1.1.2
      - name: centos1
        ip: 10.1.1.3
      - name: redhat1
        ip: 10.1.1.4

    common_packages:
      - name: vim
        version: 8.2.3456

  tasks:
    - name: Prepare inventory for testing
      ansible.builtin.add_host:
        name: "{{ item.name }}"
        ansible_host: "{{ item.ip }}"
      loop: "{{ nodes }}"

    - name: Install community.general.pipx collection
      ansible.builtin.shell: |
        ansible-galaxy collection install community.general
      become: true

    - name: Create temporary directory
      ansible.builtin.tempfile:
        state: directory
      register: temp_dir

    - name: Install pip packages using pipx
      community.general.pipx:
        name: "pyyaml==5.4.1"
        executable: "/usr/local/bin/pip3"
        state: present
        include_injected: true
        index_url: "https://pypi.org/simple"
        inject_packages:
          - pycryptodomex==3.11.0
          - "{{ common_packages }}"
        install_apps: "{{ (2+2) == 4 }}"
        install_deps: true
        python: 3.8
        source: "git+https://github.com/ansible/ansible.git"
        system_site_packages: "{{ not True }}"

    - name: Uninstall pip packages using pipx
      community.general.pipx:
        name: "pyyaml==5.4.1"
        state: absent

    - name: Delete temporary directory
      ansible.builtin.file:
        path: "{{ temp_dir.path }}"
        state: absent