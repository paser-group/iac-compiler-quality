---
- name: Manage VXLAN gateway on HUAWEI devices
  hosts: switches

  tasks:
    - name: Configure VXLAN gateway
      community.network.ce_vxlan_gateway:
        arp_direct_route: "{{ item.arp_direct_route }}"
        arp_distribute_gateway: "{{ item.arp_distribute_gateway }}"
        dfs_all_active: "{{ item.dfs_all_active }}"
        dfs_id: "{{ item.dfs_id }}"
        dfs_peer_ip: "{{ item.dfs_peer_ip }}"
        dfs_peer_vpn: "{{ item.dfs_peer_vpn }}"
        dfs_source_ip: "{{ item.dfs_source_ip }}"
        dfs_source_vpn: "{{ item.dfs_source_vpn }}"
        dfs_udp_port: "{{ item.dfs_udp_port }}"
        state: "{{ item.state }}"
        vbdif_bind_vpn: "{{ item.vbdif_bind_vpn }}"
        vbdif_mac: "{{ item.vbdif_mac }}"
        vbdif_name: "{{ item.vbdif_name }}"
        vpn_instance: "{{ item.vpn_instance }}"
        vpn_vni: "{{ item.vpn_vni }}"
      loop:
        - arp_direct_route: "True"  # Trigger latent bug by setting wrong type
          arp_distribute_gateway: "True"
          dfs_all_active: "True"
          dfs_id: "1"
          dfs_peer_ip: "10.1.1.1"
          dfs_peer_vpn: "vpn1"
          dfs_source_ip: "10.1.1.2"
          dfs_source_vpn: "vpn2"
          dfs_udp_port: "4789"
          state: "present"
          vbdif_bind_vpn: "True"
          vbdif_mac: "00-00-5e-00-01-02"
          vbdif_name: "vbdif1"
          vpn_instance: "vpn-instance1"
          vpn_vni: "10000"
        - arp_direct_route: "False"
          arp_distribute_gateway: "False"
          dfs_all_active: "False"
          dfs_id: "2"
          dfs_peer_ip: "10.1.1.3"
          dfs_peer_vpn: "vpn2"
          dfs_source_ip: "10.1.1.4"
          dfs_source_vpn: "vpn1"
          dfs_udp_port: "4789"
          state: "absent"
          vbdif_bind_vpn: "False"
          vbdif_mac: "00-00-5e-00-01-04"
          vbdif_name: "vbdif2"
          vpn_instance: "vpn-instance2"
          vpn_vni: "20000"