- name: Test Community Network CNOS VRF module
  hosts: all
  gather_facts: false

  tasks:
    - name: Generate random IP address
      set_fact:
        random_ip: "{{ range_ip.split('/')[0] }}.{{ range_ip.split('/')[1] | random_integer(min=1, max=255) }}"

    - name: Configure VRFs
      community.network.cnos_vrf:
        provider:
          host: "{{ ansible_host }}"
          username: "{{ ansible_user }}"
          password: "{{ ansible_password }}"  # Make sure to provide the password for each host
        name: "{{ item.name }}"
        rd: "{{ item.rd }}"
        purge: "{{ item.purge }}"
        state: "{{ item.state }}"
        associated_interfaces: "{{ item.associated_interfaces | default(omit) }}"
        interfaces: "{{ item.interfaces | default(omit) }}"
        aggregate: "{{ item.aggregate | default(omit) }}"
        delay: "{{ item.delay | default(omit) }}"
      with_items:
        - name: test_vrf
          rd: "{{ random_ip }}"
          purge: false
          state: present