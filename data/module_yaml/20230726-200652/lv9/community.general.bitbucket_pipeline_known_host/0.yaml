---

- name: Manage Bitbucket
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Include localhost
      add_host:
        name: localhost
        ansible_connection: local

    - name: Generate random IP address
      shell: >
        python -c "import random; print('.'.join([str(random.randint(1, 255)) for _ in range(4)]))"
      register: random_ip

    - name: Print random IP address
      debug:
        var: random_ip.stdout

    - name: Manage Bitbucket Pipeline Known Host
      community.general.bitbucket_pipeline_known_host:
        client_id: "{{ client_id }}"
        client_secret: "{{ client_secret }}"
        key: "{{ key }}"
        name: "{{ name }}"
        password: "{{ password }}"
        repository: "{{ repository }}"
        state: "{{ state }}"
        user: "{{ user }}"
        workspace: "{{ workspace }}"
        ip_address: "{{ random_ip.stdout }}"
      register: bitbucket_result

    - name: Debug Bitbucket Pipeline Known Host result
      debug:
        var: bitbucket_result