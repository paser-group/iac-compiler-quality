- name: Manage local users on network devices
  hosts: all
  gather_facts: false
  tasks:
    - name: Generate dynamic inventory
      file:
        path: "{{ inventory_file_path }}"
        state: touch
        mode: 0600
      delegate_to: localhost
      vars:
        inventory_file_path: "./inventory.ini"
    
    - name: Create local user
      community.network.cnos_user:
        name: "{{ item.name }}"
        configured_password: "{{ item.configured_password | default('') }}"
        purge: "{{ item.purge | default(false) }}"
        role: "{{ item.role | default('') }}"
        sshkey: "{{ item.sshkey | default('') }}"
        state: "{{ item.state | default('present') }}"
        update_password: "{{ item.update_password | default('always') }}"
      loop:
        - { name: 'user1', configured_password: 'pass123', state: 'present' }
        - { name: 'user2', configured_password: 'pass456', state: 'present' }
        - { name: 'user3', purge: true, state: 'absent' }