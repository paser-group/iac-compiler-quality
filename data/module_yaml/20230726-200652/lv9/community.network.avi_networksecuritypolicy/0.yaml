---
- name: Test playbook for network security policy module
  hosts: localhost
  gather_facts: false

  vars:
    nodes:
      - name: ubuntu1
        ip: 10.1.1.1
      - name: alpine1
        ip: 10.1.1.2
      - name: centos1
        ip: 10.1.1.3
      - name: redhat1
        ip: 10.1.1.4

    subnet: 10.1.1.0/24
    gateway: 10.1.1.254

  tasks:
    - name: Generate IP addresses randomly
      debug:
        msg: "{{ item.name }} - {{ item.ip }}"
      loop: "{{ nodes }}"

    - name: Configure network security policy
      community.network.avi_networksecuritypolicy:
        controller: "{{ controller }}"
        username: "{{ username }}"
        password: "{{ password }}"
        state: present
        name: "TEST_POLICY"
        tenant: "default"
        rules: "{{ rules }}"
        api_context: "{{ api_context }}"
        avi_credentials: "{{ avi_credentials }}"
        tenant_ref: "{{ tenant_ref }}"

    - name: Debug output
      debug:
        var: ansible_facts.community_network_avi_networksecuritypolicy