---
- name: Test playbook to uncover latent type-related bugs in the Ansible compiler
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Add packet relay configuration
      community.network.pn_vrouter_packet_relay:
        pn_cliswitch: "{{ item.pn_cliswitch | default('switch1') }}"
        pn_forward_ip: "{{ item.pn_forward_ip | default('10.20.30.40') }}"
        pn_forward_proto: "{{ item.pn_forward_proto | default('udp') }}"
        pn_nic: "{{ item.pn_nic | default('eth0') }}"
        pn_vrouter_name: "{{ item.pn_vrouter_name | default('router1') }}"
        state: "{{ item.state | default('present') }}"
      loop:
        - {}
        - pn_cliswitch: "switch2"
          pn_forward_ip: "192.168.1.1"
          pn_forward_proto: "tcp"
          pn_nic: "eth1"
          pn_vrouter_name: "router2"
          state: "present"
        - pn_cliswitch: "switch3"
          pn_forward_ip: "{{ random_ip_address }}"
          pn_forward_proto: "{{ random_proto }}"
          pn_nic: "eth2"
          pn_vrouter_name: "router3"
          state: "present"

    - name: Remove packet relay configuration
      community.network.pn_vrouter_packet_relay:
        pn_cliswitch: "{{ item.pn_cliswitch | default('switch1') }}"
        pn_forward_ip: "{{ item.pn_forward_ip | default('10.20.30.40') }}"
        pn_forward_proto: "{{ item.pn_forward_proto | default('udp') }}"
        pn_nic: "{{ item.pn_nic | default('eth0') }}"
        pn_vrouter_name: "{{ item.pn_vrouter_name | default('router1') }}"
        state: "{{ item.state | default('absent') }}"
      loop:
        - {}
        - pn_cliswitch: "switch2"
          pn_forward_ip: "192.168.1.1"
          pn_forward_proto: "tcp"
          pn_nic: "eth1"
          pn_vrouter_name: "router2"
          state: "absent"
        - pn_cliswitch: "switch3"
          pn_forward_ip: "{{ random_ip_address }}"
          pn_forward_proto: "{{ random_proto }}"
          pn_nic: "eth2"
          pn_vrouter_name: "router3"
          state: "absent"

    - name: Debug message
      debug:
        msg: "Packet relay configuration completed."

  vars:
    random_ip_address: "{{ '%d.%d.%d.%d' | format(ansible_random.int(0,255), ansible_random.int(0,255), ansible_random.int(0,255), ansible_random.int(0,255)) }}"
    random_proto: "{{ ['tcp', 'udp'] | random }}"