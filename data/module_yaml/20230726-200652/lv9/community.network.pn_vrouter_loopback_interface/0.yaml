---
- name: PN VRouter Loopback Interface Test
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Set random IP address
      set_fact:
        random_ip: "{{ hostvars[item]['ansible_default_ipv4']['address'] }}"
      with_items: "{{ groups['nodes'] }}"

    - name: Add VRouter Loopback Interface
      community.network.pn_vrouter_loopback_interface:
        pn_cliswitch: "{{ hostvars[item]['inventory_hostname'] }}"
        pn_index: "{{ hostvars[item]['pn_index'] }}"
        pn_ip: "{{ hostvars[item]['random_ip'] }}"
        pn_vrouter_name: "vrouter-{{ hostvars[item]['inventory_hostname'] }}"
        state: present
      loop: "{{ groups['nodes'] }}"

    - name: Remove VRouter Loopback Interface
      community.network.pn_vrouter_loopback_interface:
        pn_cliswitch: "{{ hostvars[item]['inventory_hostname'] }}"
        pn_index: "{{ hostvars[item]['pn_index'] }}"
        pn_ip: "{{ hostvars[item]['random_ip'] }}"
        pn_vrouter_name: "vrouter-{{ hostvars[item]['inventory_hostname'] }}"
        state: absent
      loop: "{{ groups['nodes'] }}"