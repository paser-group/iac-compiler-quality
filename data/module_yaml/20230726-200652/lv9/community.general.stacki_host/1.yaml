---
- name: Test playbook for community.general.stacki_host
  hosts: localhost
  gather_facts: False

  tasks:
    - name: Generate random IP address
      set_fact:
        random_ip: "{{ ((item | random) + 1) | ipmath('10.1.1.0/24') }}"
      loop: "{{ range(10) | list }}"

    - name: Add host to Stacki
      community.general.stacki_host:
        state: present
        name: ubuntu1
        network: node-net
        prim_intf: eth0
        prim_intf_ip: "{{ hostvars['ubuntu1'].ansible_default_ipv4.address }}"
        prim_intf_mac: "{{ hostvars['ubuntu1'].ansible_default_ipv4.macaddress }}"
        rack: 1
        rank: 1
        stacki_endpoint: http://stacki.example.com
        stacki_user: admin
        stacki_password: secret
      register: result
      when: "'ubuntu1' in groups['docker_nodes']"

    - name: Debug result
      debug:
        var: result

    - name: Remove host from Stacki
      community.general.stacki_host:
        state: absent
        name: ubuntu1
        network: node-net
        prim_intf: eth0
        prim_intf_ip: "{{ hostvars['ubuntu1'].ansible_default_ipv4.address }}"
        prim_intf_mac: "{{ hostvars['ubuntu1'].ansible_default_ipv4.macaddress }}"
        rack: 1
        rank: 1
        stacki_endpoint: http://stacki.example.com
        stacki_user: admin
        stacki_password: secret
      register: result
      when: "'ubuntu1' in groups['docker_nodes']"

    - name: Debug result
      debug:
        var: result