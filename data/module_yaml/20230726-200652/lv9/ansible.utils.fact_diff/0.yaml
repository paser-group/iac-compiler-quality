---
- name: Testing ansible.utils.fact_diff module for type-related bugs
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Set network nodes
      set_fact:
        network_nodes:
          - name: ubuntu1
            ip_address: 10.1.1.1
            os_distribution: ubuntu
          - name: alpine1
            ip_address: 10.1.1.2
            os_distribution: alpine
          - name: centos1
            ip_address: 10.1.1.3
            os_distribution: centos
          - name: redhat1
            ip_address: 10.1.1.4
            os_distribution: redhat

    - name: Generate random IP address
      set_fact:
        random_ip_address: "{{ network_nodes | random }}"
      run_once: true

    - name: Debug random IP address
      debug:
        msg: "Random IP address: {{ random_ip_address.ip_address }}"

    - name: Gather facts before change
      setup:
      register: facts_before_change

    - name: Debug facts before change
      debug:
        var: facts_before_change

    - name: Simulate a change in network configuration
      set_fact:
        changed_fact: "{{ random_ip_address }}"

    - name: Gather facts after change
      setup:
      register: facts_after_change

    - name: Debug facts after change
      debug:
        var: facts_after_change

    - name: Calculate fact differences
      set_fact:
        fact_diff: "{{ facts_before_change | difference(facts_after_change) }}"

    - name: Debug fact differences
      debug:
        var: fact_diff