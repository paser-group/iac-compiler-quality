---
- name: Setup HealthMonitor with random IP addresses
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Generate random IP addresses
      set_fact:
        ip_addresses:
          - "{{ range(4) }}{{ item }}"
      with_sequence: start=1 end=4
      register: random_ips

    - name: Setup HealthMonitor
      community.network.avi_healthmonitor:
        controller: "{{ controller }}"
        password: "{{ password }}"
        username: "{{ username }}"
        tenant: "{{ tenant }}"
        name: "{{ item.0 }}"
        ip_address: "{{ item.1 }}"
        type: tcp_monitor
      loop: "{{ random_ips.results | zip(ip_addresses) }}"
      register: result

    - name: Debug result
      debug:
        var: result

    - name: Trigger latent type-related bug
      community.network.avi_healthmonitor:
        controller: "{{ controller }}"
        password: "{{ password }}"
        username: "{{ username }}"
        tenant: "{{ tenant }}"
        name: "{{ item }}"
        ip_address: "{{ random_ips.results[0].ansible_facts.ip_addresses | first }}"
        type: custom_monitor  # This is intentionally incorrect
      loop: "{{ random_ips.results | map(attribute='item.0') }}"
      register: bug_result

    - name: Debug bug_result
      debug:
        var: bug_result