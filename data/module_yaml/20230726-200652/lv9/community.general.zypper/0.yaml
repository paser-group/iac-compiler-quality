---
- name: Manage packages using zypper
  hosts: all
  become: true
  vars:
    package_name: "vim"
    allow_vendor_change: true
    clean_deps: true
    disable_gpg_check: true
    disable_recommends: true
    extra_args: "--quiet"
    extra_args_precommand: ""
    force: true
    force_resolution: true
    oldpackage: true
    replacefiles: true
    state: latest
    type: package
    update_cache: true

  tasks:
    - name: Update package cache
      zypper:
        name: ''
        update_cache: "{{ update_cache }}"
        extra_args_precommand: "{{ extra_args_precommand }}"

    - name: Install package
      zypper:
        name: "{{ package_name }}"
        allow_vendor_change: "{{ allow_vendor_change }}"
        clean_deps: "{{ clean_deps }}"
        disable_gpg_check: "{{ disable_gpg_check }}"
        disable_recommends: "{{ disable_recommends }}"
        extra_args: "{{ extra_args }}"
        extra_args_precommand: "{{ extra_args_precommand }}"
        force: "{{ force }}"
        force_resolution: "{{ force_resolution }}"
        oldpackage: "{{ oldpackage }}"
        replacefiles: "{{ replacefiles }}"
        state: "{{ state }}"
        type: "{{ type }}"

    - name: Remove package
      zypper:
        name: "{{ package_name }}"
        state: absent

    - name: Verify package is not installed
      assert:
        that:
          - not ('package_name' in ansible_facts['ansible_packages'])