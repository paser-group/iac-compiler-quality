- name: Test playbook for community.general.influxdb_user module
  hosts: localhost
  gather_facts: False

  vars:
    influxdb_hostname: "{{ random_ip }}"  # Potential latent type-related bug
    influxdb_port: "8086"                 # Potential latent type-related bug
    influxdb_admin_username: "admin"
    influxdb_admin_password: "admin"
    influxdb_username: "test_user"
    influxdb_user_password: "test_password"
    influxdb_grants: ["ALL"]

  tasks:
    - name: Create InfluxDB user
      community.general.influxdb_user:
        hostname: "{{ influxdb_hostname }}"
        port: "{{ influxdb_port }}"
        admin: True
        username: "{{ influxdb_admin_username }}"
        password: "{{ influxdb_admin_password }}"
        state: present
        user_name: "{{ influxdb_username }}"
        user_password: "{{ influxdb_user_password }}"
        grants: "{{ influxdb_grants }}"
      register: influxdb_user_result

    - name: Debug output
      debug:
        var: influxdb_user_result

    - name: Delete InfluxDB user
      community.general.influxdb_user:
        hostname: "{{ influxdb_hostname }}"
        port: "{{ influxdb_port }}"
        admin: True
        username: "{{ influxdb_admin_username }}"
        password: "{{ influxdb_admin_password }}"
        state: absent
        user_name: "{{ influxdb_username }}"
      register: influxdb_delete_result

    - name: Debug output
      debug:
        var: influxdb_delete_result