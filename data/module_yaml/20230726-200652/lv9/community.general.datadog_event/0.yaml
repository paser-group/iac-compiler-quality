---
- name: Test playbook for exposing latent type-related bugs
  hosts: localhost
  gather_facts: false

  vars:
    api_key: "YOUR_API_KEY"
    app_key: "YOUR_APP_KEY"
    tags:
      - test
    date_happened: "{{ ansible_date_time.epoch }}"
    title: "Test Event"

  tasks:
    - name: Include community.general.datadog_event module
      include_vars:
        file: "/path/to/community.general.datadog_event.yml"
        name: datadog_event_module

    - name: Set event details
      set_fact:
        event_details:
          api_key: "{{ api_key }}"
          app_key: "{{ app_key }}"
          title: "{{ title }}"
          tags: "{{ tags }}"
          date_happened: "{{ date_happened }}"
          text: "This is a test event"
          priority: low
          alert_type: info
          validate_certs: "{{ validate_certs }}"
          aggregation_key: "{{ aggregation_key }}"
      vars:
        aggregation_key: "{{ hostvars[inventory_hostname].ansible_default_ipv4.address }}"
        validate_certs: "{{ invalid_variable }}"
      when: hostvars[inventory_hostname].ansible_default_ipv4.address is defined

    - name: Post event using community.general.datadog_event module
      community.general.datadog_event: "{{ event_details }}"
      register: event_result

    - name: Debug event result
      debug:
        var: event_result