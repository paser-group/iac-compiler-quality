- name: Set and Get Apache httpd 2.4 module attributes
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Generate random MAC address
      set_fact:
        random_mac_address: "{{ ('00:' ~ '%02x' ~ ':'.join([ '%02x' % (random() * 256) for i in range(5)]) ) | upper }}"

    - name: Set Apache2 mod_proxy member attributes
      community.general.apache2_mod_proxy:
        balancer_url_suffix: "/balancer"
        balancer_vhost: "example.com"
        member_host: "backend.example.com"
        state: "present"
        tls: false
        validate_certs: true
        proxy_set_header:
          - "Host example.com"
          - "X-Forwarded-Host example.com"
          - "X-Real-IP 10.1.1.1"
        proxy_pass:
          - "http://upstream-backend"
        proxy_pass_reverse:
          - "http://upstream-backend"
        proxy_ignore_headers:
          - "Set-Cookie"
      register: set_attributes_result

    - name: Get Apache2 mod_proxy member attributes
      community.general.apache2_mod_proxy:
        balancer_url_suffix: "/balancer"
        balancer_vhost: "example.com"
        member_host: "backend.example.com"
        state: "absent"
        tls: true
        validate_certs: false
        proxy_set_header:
          - "Host example.com"
          - "X-Forwarded-Host example.com"
          - "X-Real-IP {{ random_mac_address }}"
        proxy_pass:
          - "http://upstream-backend"
        proxy_pass_reverse:
          - "http://upstream-backend"
        proxy_ignore_headers:
          - "Set-Cookie"
      register: get_attributes_result

    - name: Print set_attributes_result
      debug:
        var: set_attributes_result

    - name: Print get_attributes_result
      debug:
        var: get_attributes_result