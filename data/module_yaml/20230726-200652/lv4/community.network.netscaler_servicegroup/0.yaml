---
- name: Test playbook for community.network.netscaler_servicegroup module
  hosts: localhost
  gather_facts: false

  vars:
    nitro_user: admin
    nitro_pass: password
    nitro_protocol: https
    nitro_timeout: 10
    nsip: 192.0.2.1
    validate_certs: false

  tasks:
    - name: Generate random MAC address
      shell: 'openssl rand -hex 6 | sed "s/\(..\)/\1:/g; s/.$//"'
      register: random_mac_address

    - name: Manage service group config
      community.network.netscaler_servicegroup:
        nsip: "{{ nsip }}"
        validate_certs: "{{ validate_certs }}"
        nitro_user: "{{ nitro_user }}"
        nitro_pass: "{{ nitro_pass }}"
        nitro_protocol: "{{ nitro_protocol }}"
        nitro_timeout: "{{ nitro_timeout }}"
        state: present
        servicegroupname: web
        servicetype: HTTP
        usip: true
        svrtimeout: '60'
        clttimeout: '180'
        maxreq: '0'
        cacheable: true
        maxbandwidth: '0'
        monthreshold: '0'
        healthmonitor: true
        tcpb: false
        httpprofilename: "{{ random_mac_address.stdout }}"
        comment: Test service group
        disabled: false
        graceful: true
        cka: true
        cmp: true
        rtspsessionidremap: false
        useproxyport: false
        autoscale: false
        servicemembers:
          - ip: 10.1.1.1
            port: 80