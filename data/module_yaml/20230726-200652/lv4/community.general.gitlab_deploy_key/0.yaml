---
- name: Manage GitLab Deploy Key
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Generate random MAC address
      set_fact:
        random_mac_address: "{{ '%02x' | format(255 | random ) }}:{{ '%02x' | format(255 | random ) }}:{{ '%02x' | format(255 | random ) }}:{{ '%02x' | format(255 | random ) }}:{{ '%02x' | format(255 | random ) }}:{{ '%02x' | format(255 | random ) }}"

    - name: Create GitLab Deploy Key
      community.general.gitlab_deploy_key:
        api_url: "https://gitlab.example.com/api/v4"
        api_token: "your_api_token"
        project: "your_project"
        title: "Test Key"
        key: "{{ lookup('file', '/path/to/public/key/file') }}"
        state: "present"
      vars:
        validate_certs: false

    - name: Update GitLab Deploy Key
      community.general.gitlab_deploy_key:
        api_url: "https://gitlab.example.com/api/v4"
        api_token: "your_api_token"
        project: "your_project"
        title: "Test Key"
        key: "{{ lookup('file', '/path/to/public/key/file') }}"
        state: "present"
        can_push: true
      vars:
        validate_certs: false

    - name: Delete GitLab Deploy Key
      community.general.gitlab_deploy_key:
        api_url: "https://gitlab.example.com/api/v4"
        api_token: "your_api_token"
        project: "your_project"
        title: "Test Key"
        state: "absent"
      vars:
        validate_certs: false