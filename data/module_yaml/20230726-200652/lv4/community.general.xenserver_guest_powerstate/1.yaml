- name: Manage power state of XenServer virtual machine
  hosts: localhost
  gather_facts: false

  tasks:

    - name: Generate random MAC address
      set_fact:
        random_mac_address: "{{ '00:' + '%0.2x' | format((0x00..0x7F)|random) + ':%0.2x' | format((0x00..0xFF)|random) + ':%0.2x' | format((0x00..0xFF)|random) + ':%0.2x' | format((0x00..0xFF)|random) + ':%0.2x' | format((0x00..0xFF)|random) }}"

    - name: Set power state of virtual machine
      community.general.xenserver_guest_powerstate:
        hostname: "{{ xenserver_hostname }}"
        username: "{{ xenserver_username }}"
        password: "{{ xenserver_password }}"
        uuid: "{{ vm_uuid }}"
        state: "{{ vm_power_state }}"
        state_change_timeout: "{{ state_timeout }}"
        validate_certs: "{{ validate_certs }}"
        wait_for_ip_address: "{{ wait_for_ip }}"
        name: "Virtual Machine"
        mac: "{{ random_mac_address }}"
      register: power_state_result
      
    - name: Print power state result
      debug:
        var: power_state_result