---
- name: Ansible Latent Bug Finder & Heuristic Test Playbook
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Set network attributes
      set_fact:
        network_attributes:
          - { node: 'ubuntu1', ip_address: '10.1.1.1', mac_address: "{{ hostvars['localhost']['mac_addresses']['ubuntu1'] }}" }
          - { node: 'alpine1', ip_address: '10.1.1.2', mac_address: "{{ hostvars['localhost']['mac_addresses']['alpine1'] }}" }
          - { node: 'centos1', ip_address: '10.1.1.3', mac_address: "{{ hostvars['localhost']['mac_addresses']['centos1'] }}" }
          - { node: 'redhat1', ip_address: '10.1.1.4', mac_address: "{{ hostvars['localhost']['mac_addresses']['redhat1'] }}" }

    - name: Generate random MAC addresses for network modules
      set_fact:
        mac_addresses:
          ubuntu1: "{{ '00:16:3e:%02x:%02x:%02x' | format(0,0,0) }}"
          alpine1: "{{ '00:16:3e:%02x:%02x:%02x' | format(0,0,1) }}"
          centos1: "{{ '00:16:3e:%02x:%02x:%02x' | format(0,0,2) }}"
          redhat1: "{{ '00:16:3e:%02x:%02x:%02x' | format(0,0,3) }}"
      vars:
        hostvars: "{{ hostvars }}"

    - name: Print network attributes
      debug:
        var: network_attributes

    - name: Execute ocapi_command module
      community.general.ocapi_command:
        baseuri: "https://ocapi-controller.example.com"
        category: "network"
        command: "configure"

        oc_api_data:
          - command: "set-ip"
            params:
              node: "{{ item.node }}"
              ip_address: "{{ item.ip_address }}"
              mac_address: "{{ item.mac_address }}"
              subnet: "10.1.1.0/24"
              gateway: "10.1.1.254"
        username: "admin"
        password: "admin123"
        timeout: 30
      loop: "{{ network_attributes }}"