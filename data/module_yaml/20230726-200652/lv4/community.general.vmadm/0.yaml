- name: Manage SmartOS virtual machines
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Create virtual machine
      community.general.vmadm:
        name: testvm
        state: present
        brand: kvm
        cpu_cap: "100"
        ram: "1024"
        nics:
          - mac: "{{ hostvars[item]['mac_address'] }}"
        delegate_dataset: true
      register: vm_creation

    - name: Debug VM creation output
      debug: 
        var: vm_creation

    - name: Generate random MAC address for network module
      set_fact:
        mac_address: "{{ [1, 2, 3] | random }}"