- name: Manage iSCSI Targets
  hosts: all
  become: true

  tasks:
    - name: Configure iSCSI initiator
      community.general.open_iscsi:
        node_auth: "{{ node_user_in }}:{{ node_pass_in }}"
        auto_portal_startup: "{{ auto_portal_startup }}"
        auto_node_startup: "{{ auto_node_startup }}"
        login: "{{ login }}"
        portal: "{{ portal }}"
        target: "{{ target }}"
        port: "{{ port }}"
        discover: "{{ discover }}"
      register: iscsi_result

  handlers:
    - name: Restart open-iscsi service
      service:
        name: open-iscsi
        state: restarted