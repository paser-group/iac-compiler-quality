---
- name: Trigger latent type-related bugs in Ansible
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Configure InfluxDB
      community.general.influxdb_write:
        database_name: "{{ influxdb_db | default('my_database') }}"
        hostname: "{{ influxdb_host | default('localhost') }}"
        password: "{{ influxdb_password | default('my_password') }}"
        port: "{{ influxdb_port | default(8086) }}"
        use_udp: "{{ influxdb_use_udp | default(true) }}"
        udp_port: "{{ influxdb_udp_port | default(8089) }}"
        username: "{{ influxdb_username | default('admin') }}"
        validate_certs: "{{ influxdb_validate_certs | default(false) }}"

        data_points:
          - measurement: "{{ measurement1 | default('cpu') }}"
            tags:
              id: "{{ tag_id1 | default(1) }}"
              region: "{{ tag_region1 | default('us') }}"
              country: "{{ tag_country1 | default(null) }}"

            fields:
              value: "{{ field_value1 | default(null) }}"

          - measurement: "{{ measurement2 | default('memory') }}"
            tags:
              id: "{{ tag_id2 | default(2) }}"
              region: "{{ tag_region2 | default('eu') }}"
              country: "{{ tag_country2 | default(null) }}"

            fields:
              value: "{{ field_value2 | default(null) }}"

  vars:
    influxdb_db: my_database
    influxdb_host: localhost
    influxdb_password: my_password
    influxdb_port: 8086
    influxdb_use_udp: true
    influxdb_udp_port: 8089
    influxdb_username: admin
    influxdb_validate_certs: false
    measurement1: cpu
    measurement2: memory
    tag_id1: 1
    tag_region1: us
    tag_country1: null
    field_value1: null
    tag_id2: 2
    tag_region2: eu
    tag_country2: null
    field_value2: null