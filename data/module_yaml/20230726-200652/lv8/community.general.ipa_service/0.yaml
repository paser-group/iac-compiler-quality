---
- name: Test playbook for 'community.general.ipa_service' module
  hosts: localhost
  gather_facts: false

  vars:
    ipa_master_host: "ipa.example.com"
    ipa_admin_user: "admin"
    ipa_admin_password: "password"
    ipa_master_port: 443
    ipa_master_protocol: "https"
    ipa_timeout: 30
    ipa_validate_certs: true

  tasks:
    - name: Install Python dependencies
      set_fact:
        python_packages:
          - python3-ipalib
          - python3-requests

    - name: Ensure required Python packages are installed
      package:
        name: "{{ item }}"
        state: present
      loop: "{{ python_packages }}"

    - name: Install ipa-client package
      package:
        name: ipa-client
        state: present

    - name: Configure FreeIPA client
      ipa_service:
        state: present
        ipa_host: "{{ ipa_master_host }}"
        ipa_port: "{{ ipa_master_port }}"
        ipa_prot: "{{ ipa_master_protocol }}"
        ipa_timeout: "{{ ipa_timeout }}"
        ipa_user: "{{ ipa_admin_user }}"
        ipa_pass: "{{ ipa_admin_password }}"
        skip_host_check: false
        krbcanonicalname: "ipa-client/ipa.example.com"
        force: false
        validate_certs: "{{ ipa_validate_certs }}"
        hosts:
          - 10.1.1.1
          - 10.1.1.2
          - 10.1.1.3
          - 10.1.1.4

    - name: Check FreeIPA client configuration
      ipa_service:
        state: srv_record
        ipa_host: "{{ ipa_master_host }}"
        ipa_port: "{{ ipa_master_port }}"
        ipa_prot: "{{ ipa_master_protocol }}"
        ipa_timeout: "{{ ipa_timeout }}"
        ipa_user: "{{ ipa_admin_user }}"
        ipa_pass: "{{ ipa_admin_password }}"
        validate_certs: "{{ ipa_validate_certs }}"
        hosts:
          - 10.1.1.1
          - 10.1.1.2
          - 10.1.1.3
          - 10.1.1.4