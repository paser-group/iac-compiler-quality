---
- name: Create XenServer virtual machine
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Create a XenServer virtual machine
      community.general.xenserver_guest:
        name: "{{ ansible_hostname }}"
        template: "my_template"
        state: present
        folder: "my_folder"
        networks:
          - network: "my_network"
            mac: "00:11:22:33:44:55"
            ip: "{{ hostvars[inventory_hostname].ip_address }}"
            netmask: "255.255.255.0"
            gateway: "10.1.1.254"
            dns_servers:
              - "8.8.8.8"
              - "8.8.4.4"
        username: "admin"
        password: "password"
        validate_certs: false
        wait_for_ip_address: false
        disk:
          - size: 10
            sr: "my_sr"
            device: "xvda"
        hardware:
          memory_max: 2048
          memory_static_max: 2048
          vcpus_max: 2
          vcpus_at_startup: 1
          bios_strings:
            manufacturer: "XenServer"
            product_name: "Virtual Machine"
        cdrom:
          iso: "my_iso"
        custom_params:
          - MapEntry1: "Value1"
            MapEntry2: "Value2"
        is_template: false
      register: result

    - name: Debug result
      debug:
        var: result