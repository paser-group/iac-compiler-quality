---
- name: Test playbook for community.network.pn_connection_stats_settings module
  hosts: localhost
  gather_facts: false

  vars:
    pn_client_server_stats_log_disk_space: "/var/log/connection_stats/"
    pn_client_server_stats_log_enable: "true"
    pn_client_server_stats_log_interval: "5m"
    pn_client_server_stats_max_memory: "100M"
    pn_cliswitch: "off"
    pn_connection_backup_enable: "true"
    pn_connection_backup_interval: "10m"
    pn_connection_max_memory: "200M"
    pn_connection_stats_log_disk_space: "/var/log/connection_stats/"
    pn_connection_stats_log_enable: "true"
    pn_connection_stats_log_interval: "5m"
    pn_connection_stats_max_memory: "100M"
    pn_enable: "true"
    pn_fabric_connection_backup_enable: "true"
    pn_fabric_connection_backup_interval: "10m"
    pn_fabric_connection_max_memory: "200M"
    pn_service_stat_max_memory: "100M"
    state: "absent"

  tasks:
    - name: Set connection stats settings
      community.network.pn_connection_stats_settings:
        pn_client_server_stats_log_disk_space: "{{ pn_client_server_stats_log_disk_space }}"
        pn_client_server_stats_log_enable: "{{ pn_client_server_stats_log_enable }}"
        pn_client_server_stats_log_interval: "{{ pn_client_server_stats_log_interval }}"
        pn_client_server_stats_max_memory: "{{ pn_client_server_stats_max_memory }}"
        pn_cliswitch: "{{ pn_cliswitch }}"
        pn_connection_backup_enable: "{{ pn_connection_backup_enable }}"
        pn_connection_backup_interval: "{{ pn_connection_backup_interval }}"
        pn_connection_max_memory: "{{ pn_connection_max_memory }}"
        pn_connection_stats_log_disk_space: "{{ pn_connection_stats_log_disk_space }}"
        pn_connection_stats_log_enable: "{{ pn_connection_stats_log_enable }}"
        pn_connection_stats_log_interval: "{{ pn_connection_stats_log_interval }}"
        pn_connection_stats_max_memory: "{{ pn_connection_stats_max_memory }}"
        pn_enable: "{{ pn_enable }}"
        pn_fabric_connection_backup_enable: "{{ pn_fabric_connection_backup_enable }}"
        pn_fabric_connection_backup_interval: "{{ pn_fabric_connection_backup_interval }}"
        pn_fabric_connection_max_memory: "{{ pn_fabric_connection_max_memory }}"
        pn_service_stat_max_memory: "{{ pn_service_stat_max_memory }}"
        state: "{{ state }}"
      register: result

    - name: Debug playbook output
      debug:
        var: result

    - name: Verify playbook execution result
      assert:
        that:
          - "'failed' not in result"
        msg: "The playbook execution failed"

    - name: Verify conn_stats settings
      assert:
        that:
          - result.changed == "true"
          - result.pn_connection_stats_log_enable == pn_connection_stats_log_enable
      msg: "The connection stats settings are not correctly changed"