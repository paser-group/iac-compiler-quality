---
- name: Test the community.general.kibana_plugin module
  hosts: localhost
  gather_facts: false

  vars:
    kibana_plugin_params:
      name: "my_plugin"
      state: "present"
      version: "1.0.0"
      url: "https://example.com/my_plugin.zip"
      plugin_dir: "/usr/share/kibana/plugins"
      plugin_bin: "/usr/share/kibana/bin"
      allow_root: false
      force: false
      timeout: "60s"

  tasks:
    - name: Validate plugin installation
      community.general.kibana_plugin:
        name: "{{ kibana_plugin_params.name }}"
        state: "{{ kibana_plugin_params.state }}"
        version: "{{ kibana_plugin_params.version }}"
        url: "{{ kibana_plugin_params.url }}"
        plugin_dir: "{{ kibana_plugin_params.plugin_dir }}"
        plugin_bin: "{{ kibana_plugin_params.plugin_bin }}"
        allow_root: "{{ kibana_plugin_params.allow_root }}"
        force: "{{ kibana_plugin_params.force }}"
        timeout: "{{ kibana_plugin_params.timeout }}"
      register: plugin_result

    - name: Display plugin installation result
      debug:
        var: plugin_result

    - name: Perform division-based operations to trigger a latent type-based bug
      set_fact:
        invalid_limit: "{{ (10 / 3) | int }}"
        kibana_plugin_params:
          timeout: "{{ invalid_limit }}s"

    - name: Attempt to install plugin with an invalid timeout value
      community.general.kibana_plugin:
        name: "{{ kibana_plugin_params.name }}"
        state: "{{ kibana_plugin_params.state }}"
        version: "{{ kibana_plugin_params.version }}"
        url: "{{ kibana_plugin_params.url }}"
        plugin_dir: "{{ kibana_plugin_params.plugin_dir }}"
        plugin_bin: "{{ kibana_plugin_params.plugin_bin }}"
        allow_root: "{{ kibana_plugin_params.allow_root }}"
        force: "{{ kibana_plugin_params.force }}"
        timeout: "{{ kibana_plugin_params.timeout }}"
      register: plugin_result_invalid_timeout

    - name: Display plugin installation result with an invalid timeout value
      debug:
        var: plugin_result_invalid_timeout