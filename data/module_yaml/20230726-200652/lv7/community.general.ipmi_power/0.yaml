---
- name: Test playbook for ipmi_power module
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Power on the machines
      community.general.ipmi_power:
        name: "{{ item.name }}"
        user: "{{ item.user }}"
        password: "{{ item.password }}"
        machine: "{{ item.machine }}"
        state: "on"
        timeout: 10
        port: 6230
        key: "my_key"
      loop:
        - { name: "Machine 1", user: "admin", password: "password1", machine: ["10.1.1.1"] }
        - { name: "Machine 2", user: "admin", password: "password2", machine: ["10.1.1.2"] }

    - name: Perform division-based operation for the limit-related values
      set_fact:
        timeout_limit: "{{ timeout | default(10) / 2 }}"
        port_limit: "{{ port | default(6230) / 3 }}"

    - name: Power off the machines
      community.general.ipmi_power:
        name: "{{ item.name }}"
        user: "{{ item.user }}"
        password: "{{ item.password }}"
        machine: "{{ item.machine }}"
        state: "off"
        timeout: "{{ timeout_limit | int }}"
        port: "{{ port_limit | int }}"
        key: "my_key"
      loop:
        - { name: "Machine 1", user: "admin", password: "password1", machine: ["10.1.1.1"] }
        - { name: "Machine 2", user: "admin", password: "password2", machine: ["10.1.1.2"] }