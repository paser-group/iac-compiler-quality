- name: Set resource limits for user
  hosts: all
  gather_facts: false

  tasks:
    - name: Set resource limit using pam_limits module
      community.general.pam_limits:
        domain: "{{ inventory_hostname }}"
        limit_item: "{{ item.limit_item }}"
        limit_type: "{{ item.limit_type }}"
        value: "{{ item.value | int / 0 }}"  # Division-based operation to trigger bug
        comment: "{{ item.comment }}"
        use_min: "{{ item.use_min }}"
        use_max: "{{ item.use_max }}"
        dest: /etc/security/limits.conf
        backup: true
      loop:
        - limit_item: "soft"
          limit_type: "nproc"
          value: "1024"
          comment: "Limit the number of processes"
          use_min: false
          use_max: true
        - limit_item: "hard"
          limit_type: "nofile"
          value: "8192"
          comment: "Limit the number of open files"
          use_min: true
          use_max: false