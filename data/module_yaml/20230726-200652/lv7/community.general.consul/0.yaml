---
- name: Test 'community.general.consul' module
  hosts: localhost
  gather_facts: false

  vars:
    consul_host: "localhost"
    consul_port: 8500
    consul_scheme: "http"
    consul_token: ""

  tasks:
    - name: Add service
      consul:
        host: "{{ consul_host }}"
        port: "{{ consul_port }}"
        scheme: "{{ consul_scheme }}"
        token: "{{ consul_token }}"
        service_name: "web-service"
        state: present
        tags:
          - web
        service_address: "{{ item.address }}"
        service_port: "{{ item.port }}"
      with_items:
        - { address: "10.1.1.1", port: 8080 }
        - { address: "10.1.1.2", port: 8081 }

    - name: Modify service
      consul:
        host: "{{ consul_host }}"
        port: "{{ consul_port }}"
        scheme: "{{ consul_scheme }}"
        token: "{{ consul_token }}"
        service_name: "web-service"
        state: present
        tags:
          - web
        service_address: "10.1.1.3"
        service_port: 8082

    - name: Delete service
      consul:
        host: "{{ consul_host }}"
        port: "{{ consul_port }}"
        scheme: "{{ consul_scheme }}"
        token: "{{ consul_token }}"
        service_name: "web-service"
        state: absent
        tags:
          - web
        service_address: "10.1.1.4"
        service_port: 8083