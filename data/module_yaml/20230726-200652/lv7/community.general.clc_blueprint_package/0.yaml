---
- name: Deploy Blueprint Package
  hosts: localhost
  gather_facts: false

  vars:
    package_id: "1234"
    package_params:
      param1: "value1"
      param2: "value2"
    server_ids:
      - server1
      - server2
    state: present
    wait: yes

  tasks:
    - name: Check if server limit has been reached
      block:
        - name: Get server limit
          command: /bin/get_server_limit.sh
          register: server_limit

        - name: Calculate max_servers
          set_fact:
            max_servers: "{{ server_limit.stdout | int / 2 }}"

        - assert:
            that: max_servers >= server_ids | length
            fail_msg: "Server limit has been reached"

      rescue:
        - assert:
            that: max_servers >= server_ids | length
            fail_msg: "Server limit has been exceeded"

    - name: Deploy Blueprint Package
      community.general.clc_blueprint_package:
        package_id: "{{ package_id }}"
        package_params: "{{ package_params }}"
        server_ids: "{{ server_ids }}"
        state: "{{ state }}"
        wait: "{{ wait }}"
      register: result

    - name: Debug Result
      debug:
        var: result