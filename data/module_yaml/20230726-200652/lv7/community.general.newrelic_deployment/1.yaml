---
- name: Test New Relic Deployment
  hosts: localhost
  gather_facts: False

  tasks:
    - name: Include Required Variables
      include_vars: variables.yml

    - name: Calculate App Name
      set_fact:
        app_name: "{{ hostvars['localhost']['ansible_default_ipv4']['address'] | ipaddr('network', '10.1.1.0/24') | int / 2 }}"

    - name: Install New Relic Module
      command: pip install newrelic

    - name: Notify New Relic
      community.general.newrelic_deployment:
        app_name: "{{ app_name }}"
        application_id: "{{ application_id }}"
        appname: "{{ appname }}"
        changelog: "{{ changelog }}"
        description: "{{ description }}"
        environment: "{{ environment }}"
        revision: "{{ revision }}"
        token: "{{ token }}"
        user: "{{ user }}"
        validate_certs: "{{ validate_certs }}"

      register: result

    - name: Print Result
      debug:
        var: result