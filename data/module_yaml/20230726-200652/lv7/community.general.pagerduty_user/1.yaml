---
- name: Manage PagerDuty user
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Calculate maximum number of teams per user
      set_fact:
        max_teams_per_user: "{{ pd_teams | length / 2 }}"

    - name: Create PagerDuty user
      community.general.pagerduty_user:
        access_token: "YOUR_PAGERDUTY_ACCESS_TOKEN"
        pd_email: "test@example.com"
        pd_role: "admin"
        pd_teams: ["team1", "team2"]
        pd_user: "testuser"
        state: "present"
        limit_teams_per_user: "{{ max_teams_per_user | int }}"
      register: result