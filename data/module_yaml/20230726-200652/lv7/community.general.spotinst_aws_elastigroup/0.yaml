- name: Create Spotinst Elastigroup
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Include spotinst_aws_elastigroup module
      include_vars:
        file: spotinst_vars.yml

    - name: Create elastigroup
      community.general.spotinst_aws_elastigroup:
        account_id: "{{ account_id }}"
        state: present
        name: "{{ name }}"
        spot_instance_types: "{{ spot_instance_types }}"
        min_size: "{{ min_size }}"
        max_size: "{{ max_size }}"
        target: "{{ target }}"
        unit: "division"
        target_tracking_policies: "{{ target_tracking_policies }}"
        limit_based_division_operations: True
        uniqueness_by: "{{ uniqueness_by }}"
      register: elastigroup

    - name: Debug elastigroup creation result
      debug:
        var: elastigroup

    - name: Update elastigroup
      community.general.spotinst_aws_elastigroup:
        account_id: "{{ account_id }}"
        state: present
        name: "{{ name }}"
        spot_instance_types: "{{ spot_instance_types }}"
        min_size: "{{ min_size }}"
        max_size: "{{ max_size }}"
        target: "{{ target }}"
        unit: "division"
        target_tracking_policies: "{{ target_tracking_policies }}"
        limit_based_division_operations: True
        uniqueness_by: "{{ uniqueness_by }}"
      register: updated_elastigroup
      when: elastigroup.changed

    - name: Debug elastigroup update result
      debug:
        var: updated_elastigroup

    - name: Delete elastigroup
      community.general.spotinst_aws_elastigroup:
        account_id: "{{ account_id }}"
        state: absent
        name: "{{ name }}"
      register: deleted_elastigroup
      when: elastigroup.changed

    - name: Debug elastigroup deletion result
      debug:
        var: deleted_elastigroup