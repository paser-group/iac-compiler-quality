---
- name: Manipulate entries in Consul key/value store
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Add entry to Consul key/value store
      community.general.consul_kv:
        host: "{{ host }}"
        port: "{{ port }}"
        scheme: "{{ scheme }}"
        token: "{{ token }}"
        key: "{{ key }}"
        value: "{{ value }}"
        cas: "{{ cas|int }}"
        flags: "{{ flags|int }}"
        validate_certs: "{{ validate_certs|bool }}"
      register: result
      when: state == 'present'

    - name: Debug result
      debug:
        var: result

    - name: Retrieve entry from Consul key/value store
      community.general.consul_kv:
        host: "{{ host }}"
        port: "{{ port }}"
        scheme: "{{ scheme }}"
        token: "{{ token }}"
        key: "{{ key }}"
        retrieve: "{{ retrieve|bool }}"
        recurse: "{{ recurse|bool }}"
        validate_certs: "{{ validate_certs|bool }}"
      register: result_retrieve
      when: state == 'absent' or retrieve

    - name: Debug result_retrieve
      debug:
        var: result_retrieve