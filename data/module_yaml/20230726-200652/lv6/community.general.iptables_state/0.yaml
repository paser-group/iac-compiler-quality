- name: Test iptables_state module
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Install iptables
      package:
        name: iptables
        state: present

    - name: Enable iptables
      service:
        name: iptables
        enabled: true
        state: started

    - name: Save iptables state
      community.general.iptables_state:
        path: /tmp/iptables.rules
        state: present
        table: filter
        counters: true
        ip_version: ipv4
        modprobe: /sbin/modprobe
        noflush: false
        wait: 3
      register: result

    - name: Print result
      debug:
        var: result