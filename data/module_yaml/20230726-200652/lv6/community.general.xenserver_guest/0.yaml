---
- name: Manage XenServer VMs
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Create XenServer VM
      community.general.xenserver_guest:
        name: "{{ item.name }}"
        template: "{{ item.template }}"
        folder: "{{ item.folder }}"
        state: "{{ item.state }}"
        hostname: "{{ item.hostname }}"
        username: "{{ item.username }}"
        password: "{{ item.password }}"
        validate_certs: "{{ item.validate_certs }}"
        cdrom: "{{ item.cdrom }}"
        disks: "{{ item.disks }}"
        hardware: "{{ item.hardware }}"
        networks: "{{ item.networks }}"
        custom_params: "{{ item.custom_params }}"
        wait_for_ip_address: "{{ item.wait_for_ip_address }}"
        force: "{{ item.force }}"
        state_change_timeout: "{{ item.state_change_timeout }}"
      loop:
        - name: "Test VM 1"
          template: "MyTemplate"
          folder: "/root/"
          state: "running"
          hostname: "10.0.0.1"
          username: "admin"
          password: "password"
          validate_certs: false
          cdrom:
            iso_path: "/path/to/iso"
            bootable: true
          disks:
            - size: 10GiB
              sr: "MySR"
              device: "xvda"
              type: "system"
              extra_args: ""
          hardware:
            cpu_cores: 2
            memory_max: 2GiB
          networks:
            - name: "network1"
          custom_params:
            - key: "xenstore-data"
              value: "value1"
        - name: "Test VM 2"
          template: "MyOtherTemplate"
          folder: "/root/"
          state: "stopped"
          hostname: "10.0.0.2"
          username: "admin"
          password: "password"
          validate_certs: true
          cdrom:
            iso_path: "/path/to/other/iso"
            bootable: false
          disks:
            - size: 20GiB
              sr: "MyOtherSR"
              device: "xvdb"
              type: "system"
              extra_args: ""
          hardware:
            cpu_cores: 4
            memory_max: 4GiB
          networks:
            - name: "network2"
          custom_params:
            - key: "xenstore-data"
              value: "value2"