---
- name: Create Rackspace instance with varied encodings
  hosts: localhost
  gather_facts: false
  vars:
    api_key: "{{ lookup('env', 'RAX_API_KEY') }}"
    auth_endpoint: "{{ lookup('env', 'RAX_AUTH_ENDPOINT') }}"
    username: "{{ lookup('env', 'RAX_USERNAME') }}"
    tenant_id: "{{ lookup('env', 'RAX_TENANT_ID') }}"
    region: "{{ lookup('env', 'RAX_REGION') }}"
    count: 1
    flavor: "2"
    image: "fce07736-6abb-474b-8f7a-505c292b271a"
    networks:
      - net-id: "11111111-1111-1111-1111-111111111111"
    key_name: "mykey"
    wait: yes
    state: present
  
  tasks:
    - name: Create Rackspace instance
      community.general.rax:
        api_key: "{{ api_key }}"
        auth_endpoint: "{{ auth_endpoint }}"
        username: "{{ username }}"
        tenant_id: "{{ tenant_id }}"
        region: "{{ region }}"
        count: "{{ count }}"
        flavor: "{{ flavor }}"
        image: "{{ image }}"
        networks: "{{ networks }}"
        key_name: "{{ key_name }}"
        wait: "{{ wait }}"
        state: "{{ state }}"
      register: rax_instance

    - name: Print Rackspace instance details
      debug:
        var: rax_instance

- name: Delete Rackspace instance
  hosts: localhost
  gather_facts: false
  vars:
    api_key: "{{ lookup('env', 'RAX_API_KEY') }}"
    auth_endpoint: "{{ lookup('env', 'RAX_AUTH_ENDPOINT') }}"
    username: "{{ lookup('env', 'RAX_USERNAME') }}"
    tenant_id: "{{ lookup('env', 'RAX_TENANT_ID') }}"
    region: "{{ lookup('env', 'RAX_REGION') }}"
    instance_ids:
      - "{{ rax_instance.id }}"

  tasks:
    - name: Delete Rackspace instance
      community.general.rax:
        api_key: "{{ api_key }}"
        auth_endpoint: "{{ auth_endpoint }}"
        username: "{{ username }}"
        tenant_id: "{{ tenant_id }}"
        region: "{{ region }}"
        instance_ids: "{{ instance_ids }}"
        state: absent