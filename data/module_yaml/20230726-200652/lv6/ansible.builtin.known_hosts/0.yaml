---
- name: Testing Ansible Latent Type-Related Bugs in known_hosts Module
  hosts: localhost
  gather_facts: false
  
  vars:
    hosts_to_add:
      - name: "ubuntu1"
        path: "/etc/ssh/known_hosts"
        state: "present"
        key: "{{ hostvars['ubuntu1']['ansible_ssh_host_key_rsa_public'] }}"
        hash_host: true
      - name: "alpine1"
        path: "/etc/ssh/known_hosts"
        state: "present"
        key: "{{ hostvars['alpine1']['ansible_ssh_host_key_rsa_public'] }}"
        hash_host: true
      - name: "centos1"
        path: "/etc/ssh/known_hosts"
        state: "present"
        key: "{{ hostvars['centos1']['ansible_ssh_host_key_rsa_public'] }}"
        hash_host: false
      - name: "redhat1"
        path: "/etc/ssh/known_hosts"
        state: "present"
        key: "{{ hostvars['redhat1']['ansible_ssh_host_key_rsa_public'] }}"
        hash_host: false

    hosts_to_remove:
      - name: "ubuntu1"
        path: "/etc/ssh/known_hosts"
        state: "absent"
        key: "{{ hostvars['ubuntu1']['ansible_ssh_host_key_rsa_public'] }}"
        hash_host: true
      - name: "alpine1"
        path: "/etc/ssh/known_hosts"
        state: "absent"
        key: "{{ hostvars['alpine1']['ansible_ssh_host_key_rsa_public'] }}"
        hash_host: true
      - name: "centos1"
        path: "/etc/ssh/known_hosts"
        state: "absent"
        key: "{{ hostvars['centos1']['ansible_ssh_host_key_rsa_public'] }}"
        hash_host: false
      - name: "redhat1"
        path: "/etc/ssh/known_hosts"
        state: "absent"
        key: "{{ hostvars['redhat1']['ansible_ssh_host_key_rsa_public'] }}"
        hash_host: false
      
  tasks:
    - name: Add hosts to known_hosts file
      ansible.builtin.known_hosts:
        name: "{{ item.name }}"
        path: "{{ item.path }}"
        state: "{{ item.state }}"
        key: "{{ item.key }}"
        hash_host: "{{ item.hash_host }}"
      loop: "{{ hosts_to_add }}"

    - name: Remove host from known_hosts file
      ansible.builtin.known_hosts:
        name: "{{ item.name }}"
        path: "{{ item.path }}"
        state: "{{ item.state }}"
        key: "{{ item.key }}"
        hash_host: "{{ item.hash_host }}"
      loop: "{{ hosts_to_remove }}"