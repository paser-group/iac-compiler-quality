---
- name: Test XenServer guest module
  hosts: localhost
  gather_facts: false
  
  vars:
    cdrom:
      sr: "{{ hostvars[groups['xenserver'][0]]['cdrom_sr_uuid'] }}"
      device: "{{ hostvars[groups['xenserver'][0]]['cdrom_device'] }}"
      bootable: yes
    custom_params:
      - key: "param1"
        value: "value1"
      - key: "param2"
        value: "value2"
    disks:
      - sr: "{{ hostvars[groups['xenserver'][0]]['sr_uuid'] }}"
        size: 10
        device: "disk"
    folder: "/"
    home_server: "{{ groups['xenserver'][0] }}"
    hostname: "{{ hostvars[groups['xenserver'][0]]['hostname'] }}"
    is_template: no
    linked_clone: yes
    name: "test_vm"
    name_desc: "Test VM"
    networks:
      - network: "{{ hostvars[groups['xenserver'][0]]['network_uuid'] }}"
    password: "{{ hostvars[groups['xenserver'][0]]['password'] }}"
    state: "running"
    state_change_timeout: 120
    template: "template_uuid"
    username: "{{ hostvars[groups['xenserver'][0]]['username'] }}"
    validate_certs: False
    wait_for_ip_address: False
  
  tasks:
    - name: Create XenServer guest
      community.general.xenserver_guest:
        cdrom: "{{ cdrom }}"
        custom_params: "{{ custom_params }}"
        disks: "{{ disks }}"
        folder: "{{ folder }}"
        home_server: "{{ home_server }}"
        hostname: "{{ hostname }}"
        is_template: "{{ is_template }}"
        linked_clone: "{{ linked_clone }}"
        name: "{{ name }}"
        name_desc: "{{ name_desc }}"
        networks: "{{ networks }}"
        password: "{{ password }}"
        state: "{{ state }}"
        state_change_timeout: "{{ state_change_timeout }}"
        template: "{{ template }}"
        username: "{{ username }}"
        validate_certs: "{{ validate_certs }}"
        wait_for_ip_address: "{{ wait_for_ip_address }}"
      register: result
      
    - name: Debug result
      debug:
        var: result