---
- name: Test playbook for community.general.pulp_repo module
  hosts: localhost
  gather_facts: false

  vars:
    pulp_host: "10.1.1.1"
    pulp_port: "{{ test_pulp_port | default(80) }}"
    pulp_url: "http://{{ pulp_host }}:{{ pulp_port }}"

  tasks:
    - name: Add Pulp repo
      community.general.pulp_repo:
        state: present
        name: my_repo
        pulp_host: "{{ pulp_host }}"
        url: "{{ pulp_url }}"

    - name: Update Pulp repo with random port
      community.general.pulp_repo:
        state: present
        name: my_repo
        pulp_host: "{{ pulp_host }}"
        url: "{{ pulp_url }}"
        wait_for_completion: yes
        # Randomize port number for testing
        pulp_port: "{{ test_port }}"

    - name: Remove Pulp repo
      community.general.pulp_repo:
        state: absent
        name: my_repo
        pulp_host: "{{ pulp_host }}"
        url: "{{ pulp_url }}"