- name: Test gitlab_branch module
  hosts: localhost
  gather_facts: false

  vars:
    api_url: "https://gitlab.example.com/api/v4"
    api_username: "admin"
    api_password: "admin123"

  tasks:
    - name: Create random port numbers
      set_fact:
        random_port: "{{ 1024 + (inventory_hostname | hash) | random(65535 - 1024) }}"

    - name: Creating a GitLab branch
      community.general.gitlab_branch:
        api_url: "{{ api_url }}"
        api_username: "{{ api_username }}"
        api_password: "{{ api_password }}"
        project: "my_project"
        branch: "new_branch"
        ref_branch: "master"
        state: "present"
        validate_certs: false
        api_port: "{{ random_port }}"
      register: result

    - name: Print the output
      debug:
        var: result