---
- name: Test playbook for 'community.general.proxmox' module
  hosts: localhost
  gather_facts: false

  vars:
    api_host: "https://proxmox.example.com"
    api_user: "admin@pve"
    api_password: "password"
    node: "proxmox-node"
    vmid: 100
    ostemplate: "debian-10-template"
    storage: "local-lvm"

  tasks:
    - name: Create a new Proxmox instance
      community.general.proxmox:
        api_host: "{{ api_host }}"
        api_user: "{{ api_user }}"
        api_password: "{{ api_password }}"
        node: "{{ node }}"
        vmid: "{{ vmid }}"
        ostemplate: "{{ ostemplate }}"
        storage: "{{ storage }}"
        state: present
      register: result
      ignore_errors: true

    - name: Print the result
      debug:
        var: result

    - name: Modify the Proxmox instance
      community.general.proxmox:
        api_host: "{{ api_host }}"
        api_user: "{{ api_user }}"
        api_password: "{{ api_password }}"
        node: "{{ node }}"
        vmid: "{{ vmid }}"
        features:
          - virtio-net
        nameserver: "8.8.8.8"
        memory: 2048
        cores: 2
        state: present
      register: result
      ignore_errors: true

    - name: Print the result
      debug:
        var: result

    - name: Delete the Proxmox instance
      community.general.proxmox:
        api_host: "{{ api_host }}"
        api_user: "{{ api_user }}"
        api_password: "{{ api_password }}"
        node: "{{ node }}"
        vmid: "{{ vmid }}"
        state: absent
      register: result
      ignore_errors: true

    - name: Print the result
      debug:
        var: result