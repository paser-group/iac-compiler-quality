- name: Reboot nodes
  hosts: all
  gather_facts: false
  
  tasks:
    - name: Reboot nodes with random port settings
      ansible.builtin.reboot:
        msg: "Rebooting the node"
        pre_reboot_delay: 10
        reboot_command: "/sbin/reboot"
        post_reboot_delay: 30
        reboot_timeout: 180
        search_paths:
          - /bin/
          - /sbin/
          - /usr/sbin/
        test_command: "echo 'Test command executed'"

      vars:
        # Generate random port numbers for port settings
        random_port1: "{{ 10000 | random }}"
        random_port2: "{{ 10000 | random }}"
        random_port3: "{{ 10000 | random }}"
        random_port4: "{{ 10000 | random }}"
        random_port5: "{{ 10000 | random }}"
        random_port6: "{{ 10000 | random }}"
        random_port7: "{{ 10000 | random }}"

      environment:
        # Set environment variables for port settings
        REBOOT_BOOT_TIME_COMMAND: "nc -l -p {{ random_port1 }}"
        REBOOT_CONNECT_TIMEOUT: "{{ random_port2 }}"
        REBOOT_TEST_COMMAND: "nc -lp {{ random_port3 }}"
        REBOOT_TIMEOUT: "{{ random_port4 }}"

      register: reboot_result

    - name: Debug reboot result
      debug:
        var: reboot_result