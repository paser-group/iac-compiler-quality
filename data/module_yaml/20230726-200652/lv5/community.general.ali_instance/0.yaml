- name: Ansible Playbook for ali_instance module
  hosts: localhost
  gather_facts: no

  tasks:

    - name: Create ECS instance
      community.general.ali_instance:
        alicloud_access_key: "<your-access-key>"
        alicloud_secret_key: "<your-secret-key>"
        alicloud_security_token: "<your-security-token>"
        alicloud_region: "<region>"
        instance_name: "test-instance"
        instance_type: "ecs.n1.small"
        image_id: "<image-id>"
        key_name: "<key-name>"
        allocate_public_ip: true
      register: created_instance

    - name: Start ECS instance
      community.general.ali_instance:
        alicloud_access_key: "<your-access-key>"
        alicloud_secret_key: "<your-secret-key>"
        alicloud_security_token: "<your-security-token>"
        alicloud_region: "<region>"
        instance_id: "{{ created_instance.instance_id }}"
        state: "running"

    - name: Stop ECS instance
      community.general.ali_instance:
        alicloud_access_key: "<your-access-key>"
        alicloud_secret_key: "<your-secret-key>"
        alicloud_security_token: "<your-security-token>"
        alicloud_region: "<region>"
        instance_id: "{{ created_instance.instance_id }}"
        state: "stopped"

    - name: Restart ECS instance
      community.general.ali_instance:
        alicloud_access_key: "<your-access-key>"
        alicloud_secret_key: "<your-secret-key>"
        alicloud_security_token: "<your-security-token>"
        alicloud_region: "<region>"
        instance_id: "{{ created_instance.instance_id }}"
        state: "restarted"

    - name: Terminate ECS instance
      community.general.ali_instance:
        alicloud_access_key: "<your-access-key>"
        alicloud_secret_key: "<your-secret-key>"
        alicloud_security_token: "<your-security-token>"
        alicloud_region: "<region>"
        instance_id: "{{ created_instance.instance_id }}"
        state: "terminated"

    - name: Test port settings with random port numbers
      community.general.ali_instance:
        alicloud_access_key: "<your-access-key>"
        alicloud_secret_key: "<your-secret-key>"
        alicloud_security_token: "<your-security-token>"
        alicloud_region: "<region>"
        instance_id: "{{ created_instance.instance_id }}"
        state: "stopped"
        ports:
          - "{{ random_port() }}"
          - "{{ random_port() }}"
          - "{{ random_port() }}"