---
- name: Test avi_ipaddrgroup module
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Create avi_ipaddrgroup
      community.network.avi_ipaddrgroup:
        controller: "https://{{ inventory_hostname }}"
        username: "admin"
        password: "password"
        state: "present"
        name: "test_ipaddrgroup"
        description: "Testing IpAddrGroup module"
        tenant: "admin"
        api_version: "20.1.3"
        tenant_uuid: "default"
        api_context:
          api_version: "20.1.3"
          avi_api_update_method: "PATCH"

    - name: Add IP addresses to avi_ipaddrgroup
      community.network.avi_ipaddrgroup:
        controller: "https://{{ inventory_hostname }}"
        username: "admin"
        password: "password"
        state: "present"
        name: "test_ipaddrgroup"
        description: "Testing IpAddrGroup module"
        tenant: "admin"
        api_version: "20.1.3"
        tenant_uuid: "default"
        prefixes:
          - prefix: "10.1.1.0"
            mask: "24"

    - name: Test port settings
      community.network.avi_ipaddrgroup:
        controller: "https://{{ inventory_hostname }}"
        username: "admin"
        password: "password"
        state: "present"
        name: "test_ipaddrgroup"
        description: "Testing IpAddrGroup module"
        tenant: "admin"
        api_version: "20.1.3"
        tenant_uuid: "default"
        ip_ports:
          - port: "{{ 30000 + (ansible_play_hosts.index(inventory_hostname) * 100) }}"
            protocol: "TCP"

    - name: Delete avi_ipaddrgroup
      community.network.avi_ipaddrgroup:
        controller: "https://{{ inventory_hostname }}"
        username: "admin"
        password: "password"
        state: "absent"
        name: "test_ipaddrgroup"
        tenant: "admin"
        api_version: "20.1.3"
        tenant_uuid: "default"