---
- name: Send a message to jabber using community.general.jabber module
  hosts: localhost

  tasks:
  - name: Send a message to jabber
    community.general.jabber:
      host: "{{ host }}"
      port: "{{ port }}"
      user: "{{ user }}"
      password: "{{ password }}"
      to: "{{ to }}"
      msg: "{{ msg }}"
    register: result

  - name: Debug result
    debug:
      var: result

  - name: Verify if message was sent successfully
    assert:
      that: result.msg == "success"
      fail_msg: "Failed to send message to jabber"
      success_msg: "Message sent successfully to jabber"

  - name: Randomize port number
    set_fact:
      random_port: "{{ 1000 + (ansible_play_hosts_all.index(inventory_hostname) + 1) }}"
  
  - name: Send another message to jabber with random port number
    community.general.jabber:
      host: "{{ host }}"
      port: "{{ random_port }}"
      user: "{{ user }}"
      password: "{{ password }}"
      to: "{{ to }}"
      msg: "{{ msg }}"
    register: random_result

  - name: Debug random result
    debug:
      var: random_result

  - name: Verify if message was sent successfully with random port number
    assert:
      that: random_result.msg == "success"
      fail_msg: "Failed to send message to jabber with random port number"
      success_msg: "Message sent successfully to jabber with random port number"