---
- name: Manage Dpkg package selections
  hosts: all
  gather_facts: false
  become: true

  tasks:
    - name: Install required packages
      apt:
        name: apt-transport-https
        state: present

    - name: Set Dpkg package selections
      ansible.builtin.dpkg_selections:
        name: "{{ item.name }}"
        selection: "{{ item.selection }}"
      loop:
        - name: package1
          selection: install
        - name: package2
          selection: hold

    - name: Verify Dpkg package selections
      shell: dpkg --get-selections | grep "{{ item.name }}"
      loop:
        - name: package1
        - name: package2

    - name: Perform random port testing
      shell: "echo 'Testing port: {{ item }}'"
      vars:
        random_port: "{{ 8000 | random }}"
      loop:
        - "{{ random_port }}"