---
- name: Test Ansible module for Netscaler Service Group
  hosts: localhost
  gather_facts: false

  vars:
    nsip: '10.1.1.1'  # Replace with the actual NSIP of your Netscaler device
    nitro_user: 'admin'  # Replace with the actual username for Netscaler
    nitro_pass: 'password'  # Replace with the actual password for Netscaler
    nitro_protocol: 'https'
    nitro_timeout: 10
    validate_certs: false

  tasks:
    - name: Create a service group with random port number
      community.network.netscaler_servicegroup:
        nsip: "{{ nsip }}"
        nitro_user: "{{ nitro_user }}"
        nitro_pass: "{{ nitro_pass }}"
        nitro_protocol: "{{ nitro_protocol }}"
        nitro_timeout: "{{ nitro_timeout }}"
        validate_certs: "{{ validate_certs }}"
        state: present
        servicegroupname: "my-service-group"
        servicetype: "HTTP"
        memberport: "{{ 10000 | random }}"
      register: result

    - name: Display the result
      debug:
        var: result

    - name: Delete the service group
      community.network.netscaler_servicegroup:
        nsip: "{{ nsip }}"
        nitro_user: "{{ nitro_user }}"
        nitro_pass: "{{ nitro_pass }}"
        nitro_protocol: "{{ nitro_protocol }}"
        nitro_timeout: "{{ nitro_timeout }}"
        validate_certs: "{{ validate_certs }}"
        state: absent
        servicegroupname: "my-service-group"

    - name: Display the result
      debug:
        var: result