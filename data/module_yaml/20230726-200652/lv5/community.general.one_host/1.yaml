---
- hosts: localhost
  gather_facts: false
  vars:
    random_port: "{{ 1000 + ( ansible_play_hosts.index(inventory_hostname) * 10 ) }}"
  tasks:
    - name: Create a new OpenNebula host
      community.general.one_host:
        api_url: "http://{{ api_url }}:{{ random_port }}/endpoint"
        api_username: "{{ api_username }}"
        api_password: "{{ api_password }}"
        name: "test-host"
        state: present
        cluster_name: "{{ cluster_name }}"
        cluster_id: "{{ cluster_id }}"
        im_mad_name: "{{ im_mad_name }}"
        vmm_mad_name: "{{ vmm_mad_name }}"
        template:
          LABELS: "{{ labels }}"
        validate_certs: "{{ validate_certs }}"
        wait_timeout: "{{ wait_timeout }}"
      register: result

    - debug:
        var: result