- name: Test playbook for community.network.avi_cloudconnectoruser module
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Create Cloud Connector User
      community.network.avi_cloudconnectoruser:
        controller: "https://{{ controller }}"
        username: "{{ username }}"
        password: "{{ password }}"
        tenant: "{{ tenant }}"
        name: "test-user"
        state: present
        api_context: {}
        avi_api_patch_op: null
        avi_api_update_method: null
        avi_credentials: {}
        avi_disable_session_cache_as_fact: false
        azure_serviceprincipal: null
        azure_userpass: null
        gcp_credentials: null
        oci_credentials: null
        private_key: null
        public_key: null
        tenant_ref: null
        tenant_uuid: null
        tencent_credentials: null
        url: null
        uuid: null

      register: result

    - name: Debug module output
      debug:
        var: result

    - name: Ensure Cloud Connector User is deleted
      community.network.avi_cloudconnectoruser:
        controller: "https://{{ controller }}"
        username: "{{ username }}"
        password: "{{ password }}"
        tenant: "{{ tenant }}"
        name: "test-user"
        state: absent

      when: result['changed']

- name: Test random port settings
  hosts: localhost
  gather_facts: false

  vars:
    port: "{{ 30000 | random }}"
    controller: "10.1.1.1"
    username: "admin"
    password: "admin"
    tenant: "Default"

  tasks:
    - name: Create Cloud Connector User with random port
      community.network.avi_cloudconnectoruser:
        controller: "https://{{ controller }}:{{ port }}"
        username: "{{ username }}"
        password: "{{ password }}"
        tenant: "{{ tenant }}"
        name: "test-user"
        state: present
        api_context: {}
        avi_api_patch_op: null
        avi_api_update_method: null
        avi_credentials: {}
        avi_disable_session_cache_as_fact: false
        azure_serviceprincipal: null
        azure_userpass: null
        gcp_credentials: null
        oci_credentials: null
        private_key: null
        public_key: null
        tenant_ref: null
        tenant_uuid: null
        tencent_credentials: null
        url: null
        uuid: null

      register: result

    - name: Debug module output
      debug:
        var: result

    - name: Ensure Cloud Connector User is deleted
      community.network.avi_cloudconnectoruser:
        controller: "https://{{ controller }}:{{ port }}"
        username: "{{ username }}"
        password: "{{ password }}"
        tenant: "{{ tenant }}"
        name: "test-user"
        state: absent

      when: result['changed']