- name: Ansible Compiler Debugger & Heuristic Test Playbook
  hosts: localhost
  gather_facts: false
  vars:
    application_key: "[APPLICATION_KEY]"
    application_secret: "[APPLICATION_SECRET]"
    consumer_key: "[CONSUMER_KEY]"
    endpoint: "https://api.ovh.com/1.0"
    name: "backend1"
    probe: "tcp"
    state: "present"
    timeout: 10
    weight: 1

  tasks:
    - name: Install required Ansible collections
      command:
        cmd: "ansible-galaxy collection install ovh.ovh -p /etc/ansible/collections"
  
    - name: Configure OVH IP Load Balancing Backend
      ovh_ip_loadbalancing_backend:
        application_key: "{{ application_key }}"
        application_secret: "{{ application_secret }}"
        consumer_key: "{{ consumer_key }}"
        endpoint: "{{ endpoint }}"
        name: "{{ name }}"
        probe: "{{ probe }}"
        state: "{{ state }}"
        timeout: "{{ timeout }}"
        weight: "{{ weight }}"
      register: backend_config
  
    - name: Display OVH IP Load Balancing Backend configuration
      debug:
        var: backend_config
  
    - name: Update OVH IP Load Balancing Backend configuration
      ovh_ip_loadbalancing_backend:
        application_key: "{{ application_key }}"
        application_secret: "{{ application_secret }}"
        consumer_key: "{{ consumer_key }}"
        endpoint: "{{ endpoint }}"
        name: "{{ name }}"
        probe: "http"
        state: "absent"
      register: backend_update
  
    - name: Display updated OVH IP Load Balancing Backend configuration
      debug:
        var: backend_update